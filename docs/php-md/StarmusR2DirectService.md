# StarmusR2DirectService

**Namespace:** `Starisian\Sparxstar\Starmus\services`

**File:** `/workspaces/starmus-audio-recorder/src/services/StarmusR2DirectService.php`

## Description

Direct S3-Compatible (R2/AWS) Audio Service
Minimal SDK-based S3/R2 control for bandwidth optimization versions.
Bypasses WordPress plugins for direct storage management of optimized assets.
Supports both Cloudflare R2 (primary) and AWS S3 (backup/alternative).

## Methods

### `processAfricaAudio()`

**Visibility:** `public`

Direct S3-Compatible (R2/AWS) Audio Service
Minimal SDK-based S3/R2 control for bandwidth optimization versions.
Bypasses WordPress plugins for direct storage management of optimized assets.
Supports both Cloudflare R2 (primary) and AWS S3 (backup/alternative).
/
final class StarmusR2DirectService
{
    private S3Client $storage_client;

    private string $bucket;

    private string $public_endpoint;

    private ?StarmusId3Service $id3_service = null;

    public function __construct(StarmusId3Service $id3_service)
    {
        try {
            $this->id3_service = $id3_service;

            // Detect Provider: Defaults to R2, checks for S3 override
            $provider = \defined('STARMUS_STORAGE_PROVIDER') ? STARMUS_STORAGE_PROVIDER : 'r2'; // 'r2' or 'aws'

            if ($provider === 'aws') {
                $this->configureAws();
            } else {
                $this->configureR2();
            }
        } catch (Throwable $throwable) {
            StarmusLogger::log($throwable);
        }
    }

    private function configureR2(): void
    {
        $this->bucket = \defined('STARMUS_R2_BUCKET') ? STARMUS_R2_BUCKET : 'starmus-audio';
        $account_id   = \defined('STARMUS_R2_ACCOUNT_ID') ? STARMUS_R2_ACCOUNT_ID : '';

        $this->public_endpoint = \defined('STARMUS_R2_ENDPOINT') ? STARMUS_R2_ENDPOINT : '';

        $this->storage_client = new S3Client([
            'version'     => 'latest',
            'region'      => 'auto',
            'endpoint'    => sprintf('https://%s.r2.cloudflarestorage.com', $account_id),
            'credentials' => [
                'key'    => \defined('STARMUS_R2_ACCESS_KEY') ? STARMUS_R2_ACCESS_KEY : '',
                'secret' => \defined('STARMUS_R2_SECRET_KEY') ? STARMUS_R2_SECRET_KEY : '',
            ],
            'use_path_style_endpoint' => true,
        ]);
    }

    private function configureAws(): void
    {
        $this->bucket = \defined('STARMUS_S3_BUCKET') ? STARMUS_S3_BUCKET : '';
        $region       = \defined('STARMUS_S3_REGION') ? STARMUS_S3_REGION : 'us-east-1';

        // AWS Public Endpoint construction or Custom Domain
        $this->public_endpoint = \defined('STARMUS_S3_ENDPOINT')
            ? STARMUS_S3_ENDPOINT
            : sprintf('https://%s.s3.%s.amazonaws.com/', $this->bucket, $region);

        $this->storage_client = new S3Client([
            'version'     => 'latest',
            'region'      => $region,
            'credentials' => [
                'key'    => \defined('STARMUS_S3_ACCESS_KEY') ? STARMUS_S3_ACCESS_KEY : '',
                'secret' => \defined('STARMUS_S3_SECRET_KEY') ? STARMUS_S3_SECRET_KEY : '',
            ],
        ]);
    }

    /**
Process audio for African networks with direct Storage control

### `getAfricaEstimates()`

**Visibility:** `public`

Get bandwidth estimates for Africa

---

_Generated by Starisian Documentation Generator_
