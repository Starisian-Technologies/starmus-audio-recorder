# .github/workflows/release.yml

name: Release Code Quality Final Review

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository's code.
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Set up Git for local operations only
      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          echo "ðŸ”§ Git configured for local operations (no push to protected branch)"

      # Step 3: Get the version number from the tag.
      - name: Get the version from the tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      # Step 4: Update version numbers in all files.
      - name: Update version numbers
        run: |
          # Update package.json version
          sed -i -E 's/("version":\s*").*(")/\1'${{ env.VERSION }}'\2/' package.json
          # Update plugin header version
          sed -i -E "s/^(\s*\* Version:\s*).*/\1${{ env.VERSION }}/" starmus-audio-recorder.php
          sed -i "s/define( 'STARMUS_VERSION', '[^']*' );/define( 'STARMUS_VERSION', '${{ env.VERSION }}' );/" starmus-audio-recorder.php
          # Update @version tags in source PHP files only
          find src/ -type f -name "*.php" -print0 | xargs -0 sed -i "s/@version\s\+[0-9.]\+/@version ${{ env.VERSION }}/g"

      # Step 5: Prepare version changes (no commit to protected branch)
      - name: Prepare version changes for release build
        run: |
          echo "ðŸ“ Version changes prepared for release build:"
          git diff --stat || echo "No version changes detected"
          echo "âš ï¸  Version changes are applied only to the build artifacts"
          echo "ðŸ”’ Protected branch prevents automatic version commits"
          echo "ðŸ’¡ Consider updating versions manually before tagging releases"

      # Step 6: Verify plugin entrypoint exists.
      - name: Verify plugin entrypoint
        run: |
          test -f starmus-audio-recorder.php || { echo "Missing starmus-audio-recorder.php"; exit 1; }
          grep -q "Plugin Name:" starmus-audio-recorder.php || { echo "No plugin header found"; exit 1; }

      # Step 7: Set up PHP and install Composer dependencies.
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:v2
          coverage: none
      - name: Install PHP dependencies (no-dev)
        run: composer install --no-dev --prefer-dist --no-progress --no-interaction --optimize-autoloader

      # Step 8: Set up Node.js and build frontend assets.
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Install JS dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Assets
        run: pnpm run build
      - name: Verify build output
        run: |
          test -f assets/js/starmus-audio-recorder-script.bundle.min.js || { echo "Missing ES module bundle"; exit 1; }
          test -f assets/css/starmus-audio-recorder-styles.min.css || { echo "Missing bundled CSS"; exit 1; }
          test -f assets/build-hash.txt || { echo "Missing build hash"; exit 1; }
          echo "âœ… All required build artifacts present"

      # Step 9: Build the distributable plugin ZIP file.
      - name: Ensure .distignore exists
        run: test -f .distignore || { echo ".distignore is missing"; exit 1; }
      
      - name: Verify production files are ready
        run: |
          echo "ðŸ” Verifying production-ready files..."
          test -d src/ || { echo "âŒ Missing src/ directory"; exit 1; }
          test -f starmus-audio-recorder.php || { echo "âŒ Missing plugin main file"; exit 1; }
          test -f assets/js/starmus-audio-recorder-script.bundle.min.js || { echo "âŒ Missing bundled JS"; exit 1; }
          test -f assets/css/starmus-audio-recorder-styles.min.css || { echo "âŒ Missing bundled CSS"; exit 1; }
          test -f vendor/autoload.php || { echo "âŒ Missing Composer autoloader"; exit 1; }
          echo "âœ… All production files verified"
          
      - name: Build plugin ZIP
        run: |
          SLUG="starmus-audio-recorder"
          VERSION=${{ env.VERSION }}
          echo "ðŸ—ï¸ Building release ZIP with version $VERSION"
          
          # Verify version was applied to files
          echo "ðŸ“‹ Verifying version numbers in key files:"
          grep -n "Version:" starmus-audio-recorder.php || echo "âš ï¸ Plugin header version not found"
          grep -n "STARMUS_VERSION" starmus-audio-recorder.php || echo "âš ï¸ Version constant not found"
          grep -n "\"version\"" package.json || echo "âš ï¸ Package version not found"
          
          rm -rf build
          mkdir -p build
          rsync -a --exclude-from=.distignore ./ build/${SLUG}/
          (cd build && zip -r "../${SLUG}-${VERSION}.zip" "${SLUG}")
          
          echo "ðŸ“¦ Release ZIP created: ${SLUG}-${VERSION}.zip"

      # NEW STEP: Ensure vendor exists and is packaged
      - name: Ensure vendor directory is preserved for ZIP
        run: |
          if [ ! -d "vendor" ]; then
            echo "Vendor directory missing â€” Composer install did not create it."
            exit 1
          fi
          echo "Vendor directory found."

      # Step 10: Generate checksums for the ZIP file.
      - name: Generate checksums
        run: |
          ZIP_FILE="starmus-audio-recorder-${{ env.VERSION }}.zip"
          sha256sum "$ZIP_FILE" > "$ZIP_FILE.sha256"
          sha1sum   "$ZIP_FILE" > "$ZIP_FILE.sha1"

      # Step 11: Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            starmus-audio-recorder-${{ env.VERSION }}.zip
            starmus-audio-recorder-${{ env.VERSION }}.zip.sha256
            starmus-audio-recorder-${{ env.VERSION }}.zip.sha1
