name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify plugin entrypoint
        run: |
          test -f starmus-audio-recorder.php || { echo "Missing starmus-audio-recorder.php"; exit 1; }
          grep -q "Plugin Name:" starmus-audio-recorder.php || { echo "No plugin header found"; exit 1; }

      - name: Read version from header
        id: vers
        run: |
          VER=$(grep -E "^\s*\*\s*Version:\s*" starmus-audio-recorder.php | sed -E 's/.*Version:\s*//')
          echo "version=${VER:-${GITHUB_REF_NAME#v}}" >> $GITHUB_OUTPUT

      - name: Ensure .distignore exists
        run: |
          if [ ! -f .distignore ]; then
            echo ".distignore is missing"; exit 1;
          fi

      - name: Build plugin ZIP (distignore)
        run: |
          SLUG="starmus-audio-recorder"
          mkdir -p build
          rsync -a --delete --exclude-from=.distignore ./ build/${SLUG}/
          (cd build && zip -r "${SLUG}-${{ steps.vers.outputs.version }}.zip" "${SLUG}")
          mv "build/${SLUG}-${{ steps.vers.outputs.version }}.zip" .

      - name: Generate checksums
        run: |
          sha256sum "starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip" > "starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip.sha256"
          sha1sum   "starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip" > "starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip.sha1"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-zip
          path: |
            starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip
            starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip.sha256
            starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip.sha1

      - name: Generate changelog (optional)
        id: changelog
        if: ${{ hashFiles('.github/changelog-config.json') != '' }}
        uses: mikepenz/release-changelog-builder-action@5f623dcdc2669b6cdbe6fd40fc15501a25676aa6        
        with:
          configuration: .github/changelog-config.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@72f2c25fcb47643c292f7107632f7a47c1df5cd8        
        with:
          files: |
            starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip
            starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip.sha256
            starmus-audio-recorder-${{ steps.vers.outputs.version }}.zip.sha1
          body: ${{ steps.changelog.outputs.changelog || 'Automated release.' }}
