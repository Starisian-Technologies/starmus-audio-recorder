# .github/workflows/proof-html-js-css.yml

name: Proof HTML, Lint JS & CSS

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  ################################################################
  # JOB 1: LINTER & PROOFER (The "Enforcer")
  # This job runs on EVERY push and pull request.
  # Its only job is to CHECK for errors and fail if it finds any.
  ################################################################
  lint:
    name: Lint & Proof Frontend Assets
    runs-on: ubuntu-latest
    permissions:
      contents: read # This job only needs to read files.

    steps:
      - name: Checkout code
        # v4.1.6 commit pin prevents tampering with checkout action.
        uses: actions/checkout@5a4ac9002afc2a3b8d9a0e327669c9fe749ac181

      - name: Set up Node.js
        # v4.0.2 commit pin ensures Node setup action stays deterministic.
        uses: actions/setup-node@8f1525dfb8c7b99f04f58f80ab1c2b74fdc6a051
        with:
          node-version: "18"
          cache: "npm" # Use built-in caching for Node.js

      - name: Install dependencies
        run: npm ci

      - name: Lint JavaScript (Check only)
        # We run WITHOUT --fix here. The goal is to report errors, not hide them.
        run: npx eslint "src/js/**/*.js"

      - name: Lint CSS (Check only)
        # We run WITHOUT --fix here.
        run: npx stylelint "src/css/**/*.css"

      - name: Proof HTML files
        # This action checks for issues like broken links, invalid tags, etc.
        uses: anishathalye/proof-html@121673da047796671cf7391fdeee2d8c7b911f8c
        with:
          # Tell the proofer which directory to scan for HTML files.
          # You can change this to '.' to scan the whole repository.
          directory: "./templates"
          # Optional: Add flags to ignore certain checks if needed.
          # options: '--disable-external'

  ################################################################
  # JOB 2: AUTO-FIXER (The "Helper Bot")
  # This job runs ONLY on pull requests.
  # Its job is to fix simple errors and push them back to the PR branch.
  ################################################################
  auto-fix:
    name: Auto-fix JS & CSS
    runs-on: ubuntu-latest
    # CRITICAL: This condition ensures the job only runs for pull requests.
    if: github.event_name == 'pull_request'

    permissions:
      contents: write # This job needs permission to push code.

    steps:
      - name: Checkout code
        # v4.1.6 commit pin prevents tampering with checkout action.
        uses: actions/checkout@5a4ac9002afc2a3b8d9a0e327669c9fe749ac181
        # CRITICAL: Check out the actual branch of the pull request.
        with:
          ref: ${{ github.head_ref }}

      - name: Set up Node.js
        # v4.0.2 commit pin ensures Node setup action stays deterministic.
        uses: actions/setup-node@8f1525dfb8c7b99f04f58f80ab1c2b74fdc6a05
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Fix JavaScript and CSS issues
        # Run WITH --fix. The goal is to apply changes.
        run: |
          npx eslint "src/js/**/*.js" --fix
          npx stylelint "src/css/**/*.css" --fix

      - name: Commit and push fixes
        # This dedicated action is the most reliable way to commit changes.
        # It will only create a commit if the --fix command actually changed files.
        uses: stefanzweifel/git-auto-commit-action@778341af668090896ca464160c2def5d1d1a3eb0
        with:
          commit_message: "chore: auto-fix JS/CSS lint issues"
          branch: ${{ github.head_ref }}
          file_pattern: "src/js/**/*.js src/css/**/*.css"
