!function(e,t){"use strict";const n={LOG_PREFIX:"[Starmus Submissions]"};function o(e,t,s){console&&console[e]&&console[e](n.LOG_PREFIX,t,s||"")}function r(e){return t.getElementById(e)}function i(e){return"string"==typeof e&&/^[A-Za-z0-9_-]{1,100}$/.test(e)}function a(t,...n){e.StarmusHooks&&e.StarmusHooks.doAction(t,...n)}function u(t,n,...s){return e.StarmusHooks?e.StarmusHooks.applyFilters(t,n,...s):n}function c(e,t,n){if(!i(e))return;const o=r("starmus_recorder_status_"+e)||r("starmus_calibration_status_"+e)||r("starmus_step1_usermsg_"+e);o&&(o.textContent=s(t),o.setAttribute("data-status",n||"info"))}const d={db:null,name:"StarmusSubmissions",store:"pendingSubmissions",init:function(){if("indexedDB"in e)try{const e=indexedDB.open(this.name,1),t=this;e.onupgradeneeded=function(e){const n=e.target.result;n.objectStoreNames.contains(t.store)||n.createObjectStore(t.store,{keyPath:"id",autoIncrement:!0})},e.onsuccess=function(e){t.db=e.target.result,o("log","Offline DB ready"),t.processQueue()},e.onerror=function(e){o("error","IndexedDB error",e&&e.target&&e.target.errorCode)}}catch(e){o("error","Could not initialize offline database",e.message)}else o("warn","IndexedDB missing")},add:function(e,t,n,s,r){if(this.db&&i(e))try{const o=this.db.transaction([this.store],"readwrite"),i=o.objectStore(this.store).add({formInstanceId:e,fileName:n,when:Date.now(),audioBlob:t,formFields:s||{},meta:r||{}});i.onsuccess=function(){c(e,"You are offline. Saved and will auto-send later.","success")},i.onerror=function(){c(e,"Failed to save offline.","error")}}catch(e){o("error","Failed to add item to offline queue",e.message)}else c(e,"Cannot save offline here.","error")},processQueue:function(){if(this.db&&navigator.onLine)try{const e=this.db.transaction([this.store],"readwrite").objectStore(this.store);let t=0;e.openCursor().onsuccess=function(n){const s=n.target.result;if(s){const n=s.value;setTimeout(function(){f(n.audioBlob,n.fileName,n.formFields,n.meta,n.formInstanceId).then(function(){c(n.formInstanceId,"Queued submission sent.","success"),e.delete(s.key)}).catch(function(e){o("error","Queued upload failed (will retry later)",e&&(e.message||e))})},1e3*t),t++,s.continue()}}}catch(e){o("error","Failed to process offline queue",e.message)}}};function f(t,n,r,a,u){if(!i(u))return Promise.reject(new Error("Invalid instanceId for upload"));const d=e.starmusTus||{};if(!e.tus||!d.endpoint){const o=e.starmusFormData||{};if(o.rest_url&&o.rest_nonce){const e=new FormData;return Object.keys(r||{}).forEach(function(t){e.append(s(t),r[t])}),e.append("audio_file",t,s(n)||"recording"),a&&e.append("metadata",JSON.stringify(a)),fetch(o.rest_url,{method:"POST",headers:{"X-WP-Nonce":o.rest_nonce},body:e}).then(function(e){if(!e.ok)throw new Error("Direct upload failed: "+e.status);return e})}return Promise.reject(new Error("tus missing and no fallback endpoint configured"))}return new Promise(function(e,i){const f=Object.assign({},r||{});f.filename=s(n)||"recording",a&&(f.starmus_meta=JSON.stringify(a));const l=new tus.Upload(t,{endpoint:d.endpoint,chunkSize:d.chunkSize||5242880,retryDelays:d.retryDelays||[0,3e3,5e3,1e4,2e4],headers:d.headers||{},metadata:f,onError:function(e){i(e)},onProgress:function(e,t){const n=Math.round(e/t*100);c(u,"Uploading… "+n+"%","info")},onSuccess:function(){c(u,"Upload complete.","success"),e(l.url)}});l.findPreviousUploads().then(function(e){e.length&&l.resumeFromPreviousUpload(e[0]),l.start()}).catch(function(e){o("warn","Could not resume previous upload, starting new",e.message),l.start()})})}function l(t){if(!i(t))return;const s=e.StarmusAudioRecorder;s&&"function"==typeof s.init?(c(t,"Initializing microphone...","info"),s.init({formInstanceId:t,srContinuous:n.SPEECH_CONFIG.continuous,language:n.SPEECH_CONFIG.language}).then(function(e){e&&"A"===e.tier?c(t,"Recorder ready. Use “Setup Mic” for best results.","info"):c(t,"Recorder ready.","info")}).catch(function(e){o("error","Engine init failed",e&&e.message),m(t)})):m(t)}function m(e){if(!i(e))return;const t=r("starmus_recorder_container_"+e),n=r("starmus_fallback_container_"+e);t&&(t.style.display="none"),n&&(n.style.display="block"),a("starmus_tier_c_revealed",e)}function _(e){const t=new FormData(e),n={};return t.forEach(function(e,t){"audio_file"!==t&&(n[s(t)]=e)}),n}function h(t,n){if(!i(t))return;const s=e.StarmusAudioRecorder?.getSubmissionData?.(t),c=r("starmus_fallback_input_"+t);let l=null,m="recording.webm";if(s?.blob?(l=s.blob,m=s.fileName):c?.files?.length&&(l=c.files[0],m=c.files[0].name),!l)return void a("starmus_submission_failed",t,"No audio");const h=_(n),b=s?.metadata||{},p={instanceId:t,blob:l,fileName:m,formFields:h,metadata:b};u("starmus_before_submit",!0,p)?(a("starmus_submission_started",t,p),f(l,m,h,b,t).then(n=>(a("starmus_upload_success",t,n),function(t,n,s){const o=e.starmusFormData||{};if(!o.rest_url||!o.rest_nonce)return Promise.resolve();const r=new FormData;return Object.keys(n||{}).forEach(e=>r.append(e,n[e])),r.append("tus_url",t||""),r.append("metadata",JSON.stringify(s)),fetch(o.rest_url,{method:"POST",headers:{"X-WP-Nonce":o.rest_nonce},body:r})}(n,h,b))).then(()=>{a("starmus_submission_complete",t)}).catch(e=>{o("error","Upload failed",e?.message),a("starmus_submission_failed",t,e),d.add(t,l,m,h,b)})):o("log","Submission handled by filter hook")}function _(e){const t=new FormData(e),n={};return t.forEach((e,t)=>{"audio_file"!==t&&(n[t]=e)}),u("starmus_form_fields",n,e)}function l(t){return new Promise((n,s)=>{if(!e.StarmusAudioRecorder?.init)return m(t),s(new Error("Recorder module missing."));e.StarmusAudioRecorder.init({formInstanceId:t}).then(n).catch(e=>{o("error","Engine init failed",e?.message),m(t),s(e)})})}function b(){d.init(),e.addEventListener("online",()=>d.processQueue()),a("starmus_submissions_handler_ready")}e.StarmusHooks?e.StarmusHooks.addAction("starmus_hooks_ready",b,5):"loading"===t.readyState?t.addEventListener("DOMContentLoaded",b):b(),e.StarmusSubmissionsHandler={handleSubmit:h,initRecorder:l,Offline:d}}(window,document);