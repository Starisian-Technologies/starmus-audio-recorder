// ==== starmus-audio-recorder-module.js ====
// Build Hash (SHA-1):   f2762e325da8ac4ee6159e4238116c308ab41b61
// Build Hash (SHA-256): f0e386bdb0da9d1f99b6bc815e272fa32d9aee7878026d2d847a337745540a37
// Build Time: 2025-09-10T21:14:04.882Z

!function(e,t){buildHash: 'f2762e325da8ac4ee6159e4238116c308ab41b61',
  "use strict";const n="[Starmus Controller]",r={continuous:!0,language:"en-US"};function o(e){try{return String(e).replace(/[\u0020-\u007E]/g,function(e){return/[<>"'&]/.test(e)?" ":e}).slice(0,500)}catch(e){return""}}function s(e,t,r){console&&console[e]&&console[e](n,o(t),r?o(r):"")}function i(e){return t.getElementById(e)}function a(e){return"string"==typeof e&&/^[A-Za-z0-9_-]{1,100}$/.test(e)}function u(e,t,n){if(!a(e))return;const r=i("starmus_recorder_status_"+e)||i("starmus_calibration_status_"+e)||i("starmus_step1_usermsg_"+e);r&&(r.textContent=o(t),r.setAttribute("data-status",n||"info"))}const c={db:null,name:"StarmusSubmissions",store:"pendingSubmissions",init:function(){if("indexedDB"in e)try{const e=indexedDB.open(this.name,1),t=this;e.onupgradeneeded=function(e){const n=e.target.result;n.objectStoreNames.contains(t.store)||n.createObjectStore(t.store,{keyPath:"id",autoIncrement:!0})},e.onsuccess=function(e){t.db=e.target.result,s("log","Offline DB ready"),t.processQueue()},e.onerror=function(e){s("error","IndexedDB error",e&&e.target&&e.target.errorCode)}}catch(e){s("error","Could not initialize offline database",e.message)}else s("warn","IndexedDB missing")},add:function(e,t,n,r,o){if(this.db&&a(e))try{const s=this.db.transaction([this.store],"readwrite"),i=s.objectStore(this.store).add({formInstanceId:e,fileName:n,when:Date.now(),audioBlob:t,formFields:r||{},meta:o||{}});i.onsuccess=function(){u(e,"You are offline. Saved and will auto-send later.","success")},i.onerror=function(){u(e,"Failed to save offline.","error")}}catch(e){s("error","Failed to add item to offline queue",e.message)}else u(e,"Cannot save offline here.","error")},processQueue:function(){if(this.db&&navigator.onLine)try{const e=this.db.transaction([this.store],"readwrite").objectStore(this.store);let t=0;e.openCursor().onsuccess=function(n){const r=n.target.result;if(r){const n=r.value;setTimeout(function(){d(n.audioBlob,n.fileName,n.formFields,n.meta,n.formInstanceId).then(function(){u(n.formInstanceId,"Queued submission sent.","success"),e.delete(r.key)}).catch(function(e){s("error","Queued upload failed (will retry later)",e&&(e.message||e))})},1e3*t),t++,r.continue()}}}catch(e){s("error","Failed to process offline queue",e.message)}}};function d(t,n,r,i,c){if(!a(c))return Promise.reject(new Error("Invalid instanceId for upload"));const d=e.starmusTus||{};if(!e.tus||!d.endpoint){const s=e.starmusFormData||{};if(s.rest_url&&s.rest_nonce){const e=new FormData;return Object.keys(r||{}).forEach(function(t){e.append(o(t),r[t])}),e.append("audio_file",t,o(n)||"recording"),i&&e.append("metadata",JSON.stringify(i)),fetch(s.rest_url,{method:"POST",headers:{"X-WP-Nonce":s.rest_nonce},body:e}).then(function(e){if(!e.ok)throw new Error("Direct upload failed: "+e.status);return e})}return Promise.reject(new Error("tus missing and no fallback endpoint configured"))}return new Promise(function(e,a){const l=Object.assign({},r||{});l.filename=o(n)||"recording",i&&(l.starmus_meta=JSON.stringify(i));const f=new tus.Upload(t,{endpoint:d.endpoint,chunkSize:d.chunkSize||5242880,retryDelays:d.retryDelays||[0,3e3,5e3,1e4,2e4],headers:d.headers||{},metadata:l,onError:function(e){a(e)},onProgress:function(e,t){const n=Math.round(e/t*100);u(c,"Uploading… "+n+"%","info")},onSuccess:function(){u(c,"Upload complete.","success"),e(f.url)}});f.findPreviousUploads().then(function(e){e.length&&f.resumeFromPreviousUpload(e[0]),f.start()}).catch(function(e){s("warn","Could not resume previous upload, starting new",e.message),f.start()})})}function l(t){if(!a(t))return;const n=e.StarmusAudioRecorder;n&&"function"==typeof n.init?(u(t,"Initializing microphone...","info"),n.init({formInstanceId:t,srContinuous:r.continuous,language:r.language}).then(function(e){e&&"A"===e.tier?u(t,"Recorder ready. Use “Setup Mic” for best results.","info"):u(t,"Recorder ready.","info")}).catch(function(e){s("error","Engine init failed",e&&e.message),f(t)})):f(t)}function f(e){if(!a(e))return;const t=i("starmus_recorder_container_"+e),n=i("starmus_fallback_container_"+e);t&&(t.style.display="none"),n&&(n.style.display="block"),u(e,"Live recording not supported. Use file upload below.","warn")}function m(e){if(!a(e))return;const t=i(e);t&&t.addEventListener("submit",function(n){n.preventDefault(),p(e,t)})}function g(e){if(!a(e))return;const t=i("starmus_continue_btn_"+e),n=i("starmus_step1_"+e),r=i("starmus_step2_"+e);t&&n&&r&&t.addEventListener("click",function(){let t=!0;const o=n.querySelectorAll("[required]");for(const e of o)if(!e.checkValidity()){"function"==typeof e.reportValidity&&e.reportValidity(),t=!1;break}t&&(n.style.display="none",r.style.display="block",l(e))})}function p(t,n){if(!a(t))return;const r=e.StarmusAudioRecorder&&e.StarmusAudioRecorder.getSubmissionData,l=r?r(t):null,f=i("starmus_fallback_input_"+t);let m=null,g="recording.webm";if(l&&l.blob?(m=l.blob,g=l.fileName):f&&f.files&&f.files.length&&(m=f.files[0],g=m.name),!m)return void u(t,"No audio recorded or selected.","error");const p=function(e){const t=new FormData(e),n={};return t.forEach(function(e,t){"audio_file"!==t&&(n[o(t)]=e)}),n}(n),h=function(t){if(!a(t))return{};const n=e.StarmusAudioRecorder&&e.StarmusAudioRecorder.getSubmissionData,r=n?n(t):null,o={instanceId:t,recordedAt:(new Date).toISOString()};return r&&r.metadata&&Object.assign(o,r.metadata),o}(t);if(!navigator.onLine)return s("log","Offline; queueing"),void c.add(t,m,g,p,h);d(m,g,p,h,t).then(function(t){const n=e.starmusFormData||{};if(n.rest_url&&n.rest_nonce){const e=new FormData;return Object.keys(p||{}).forEach(function(t){e.append(o(t),p[t])}),e.append("tus_url",t||""),e.append("metadata",JSON.stringify(h)),fetch(n.rest_url,{method:"POST",headers:{"X-WP-Nonce":n.rest_nonce},body:e})}return Promise.resolve()}).then(function(){u(t,"Submission saved.","success")}).catch(function(e){s("error","Upload failed; saving locally",e&&(e.message||e)),u(t,"Upload failed; saved locally for later.","warn"),c.add(t,m,g,p,h)})}function h(){c.init(),e.addEventListener("online",function(){s("log","Back online; processing queue"),c.processQueue()});try{const e=t.querySelectorAll("form.starmus-audio-form");if(e&&e.length>0)for(let t=0;t<e.length;t++){const n=e[t],r=n?n.id:null;r&&a(r)&&"1"!==n.getAttribute("data-starmus-bound")&&(n.setAttribute("data-starmus-bound","1"),g(r),m(r))}}catch(e){s("error","Failed to initialize forms",e.message)}}e.StarmusSubmissionsHandler={handleSubmit:p,initRecorder:l,revealTierC:f},"loading"===t.readyState?t.addEventListener("DOMContentLoaded",h):h()}(window,document);