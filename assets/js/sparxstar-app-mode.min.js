/**
 * @file         sparxstar-app-mode.js
 * @author       Starisian Technologies (Max Barrett)
 * @license      MIT License
 * @copyright    Copyright (c) 2026 Starisian Technologies.
 * @description  This script turns complex, scroll-heavy mobile pages into a controlled full-screen app experience so users can complete a task without the page fighting them.
 */
!function(t,e){const i={activeElement:null,triggerElement:null,threshold:1024,targetClasses:[".sparxstar-app-mode"],scrollTop:0,rafId:null,currentScale:1,_touchStartHandler:null,_touchMoveHandler:null,_touchEndHandler:null,_touchCancelHandler:null,touchStartY:0,touchStartTime:0,isDragging:!1,_handleResizeBound:null,init(){t.__sparxstarAppInitialized||(t.__sparxstarAppInitialized=!0,history.state&&history.state.sparxstarMode&&history.replaceState(null,"",location.href),this._setupTriggers(),t.addEventListener("popstate",()=>{this.activeElement&&this._cleanupUI()}),t.addEventListener("sparxstar:submissionAccepted",()=>{this.activeElement&&this.close()}),t.addEventListener("orientationchange",()=>{this.activeElement&&setTimeout(()=>this._fitToScreen(),100)}),e.addEventListener("keydown",t=>this._handleKeyboard(t)))},_setupTriggers(){e.addEventListener("click",t=>{if(this.activeElement)return;const e=this.targetClasses.join(", "),i=t.target.closest(e);i&&this.open(i)})},open(i){t.innerWidth>this.threshold||this.activeElement||(history.state&&history.state.sparxstarMode||t.history.pushState({sparxstarMode:!0},""),this.activeElement=i,this.triggerElement=e.activeElement,this.scrollTop=t.scrollY,e.body.style.top=`-${this.scrollTop}px`,e.body.classList.add("sparxstar-scroll-locked"),i.classList.add("sparxstar-active"),i.setAttribute("aria-modal","true"),i.setAttribute("role","dialog"),i.setAttribute("tabindex","-1"),i.style.transition="",this._fitToScreen(),requestAnimationFrame(()=>{this.activeElement&&i.focus({preventScroll:!0})}),this._bindResizeListener(),this._bindSwipeListeners())},close(){this.activeElement&&(history.state&&history.state.sparxstarMode?t.history.back():this._cleanupUI())},_cleanupUI(){if(!this.activeElement)return;const i=this.activeElement;this._unbindResizeListener(),this._unbindSwipeListeners(),i.classList.remove("sparxstar-active"),i.removeAttribute("aria-modal"),i.removeAttribute("role"),i.removeAttribute("tabindex"),i.style.transform="",i.style.transition="",e.body.classList.remove("sparxstar-scroll-locked"),e.body.style.top="",t.scrollTo(0,this.scrollTop),this.triggerElement&&this.triggerElement.isConnected&&this.triggerElement.focus(),this.activeElement=null,this.triggerElement=null,this.rafId=null,this.scrollTop=0,this.currentScale=1,this.isDragging=!1,this.touchStartY=0,this.touchStartTime=0},_getViewportSize:()=>({vw:t.visualViewport?.width||e.documentElement.clientWidth||t.innerWidth,vh:t.visualViewport?.height||e.documentElement.clientHeight||t.innerHeight}),_fitToScreen(){if(!this.activeElement)return;const t=this.activeElement;t.style.transform="none";const{vw:e,vh:i}=this._getViewportSize(),s=t.scrollWidth,n=t.scrollHeight;if(!(s&&n&&e&&i))return this.currentScale=1,void(t.style.transform="scale(1)");const r=e/s,a=i/n,o=n>i;this.currentScale=o?Math.min(r,1):Math.min(r,a,1),t.style.transform=`scale(${this.currentScale})`},_handleKeyboard(t){if(this.activeElement)if("Escape"!==t.key){if("Tab"===t.key){const i=this.activeElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),s=Array.from(i).filter(t=>{if(t.disabled)return!1;if("true"===t.getAttribute("aria-hidden"))return!1;const e=t.getBoundingClientRect();return e.width>0&&e.height>0});if(0===s.length)return void t.preventDefault();const n=s[0],r=s[s.length-1];t.shiftKey?e.activeElement===n&&(t.preventDefault(),r.focus()):e.activeElement===r&&(t.preventDefault(),n.focus())}}else this.close()},_bindSwipeListeners(){if(!this.activeElement)return;this._touchStartHandler=t=>this._onTouchStart(t),this._touchMoveHandler=t=>this._onTouchMove(t),this._touchEndHandler=t=>this._onTouchEnd(t),this._touchCancelHandler=t=>this._onTouchEnd(t);const t=this.activeElement;t.addEventListener("touchstart",this._touchStartHandler,{passive:!0}),t.addEventListener("touchmove",this._touchMoveHandler,{passive:!1}),t.addEventListener("touchend",this._touchEndHandler,{passive:!0}),t.addEventListener("touchcancel",this._touchCancelHandler,{passive:!0})},_unbindSwipeListeners(){if(!this.activeElement)return;const t=this.activeElement;t.removeEventListener("touchstart",this._touchStartHandler),t.removeEventListener("touchmove",this._touchMoveHandler),t.removeEventListener("touchend",this._touchEndHandler),t.removeEventListener("touchcancel",this._touchCancelHandler)},_onTouchStart(t){const e=t.target.tagName;["INPUT","TEXTAREA","SELECT","RANGE"].includes(e)||this.activeElement.scrollTop>0||(this.touchStartY=t.touches[0].clientY,this.touchStartTime=t.timeStamp,this.isDragging=!0)},_onTouchMove(t){if(!this.isDragging||!this.activeElement)return;const e=t.touches[0].clientY-this.touchStartY;e>0&&(t.cancelable&&t.preventDefault(),this.activeElement.style.transform=`translateY(${e}px) scale(${this.currentScale})`)},_onTouchEnd(t){if(!this.isDragging||!this.activeElement)return;this.isDragging=!1;const e=t.changedTouches&&t.changedTouches[0],i=(e?e.clientY:this.touchStartY)-this.touchStartY,s=t.timeStamp-this.touchStartTime;if(i>100&&i/(s||1)>.3&&this.activeElement.scrollTop<=0)this.close();else{const t=this.activeElement;t.style.transition="transform 0.3s ease-out",t.style.transform=`scale(${this.currentScale})`,setTimeout(()=>{this.activeElement===t&&(t.style.transition="")},300)}}};t.SparxstarApp=i,"loading"===e.readyState?e.addEventListener("DOMContentLoaded",()=>i.init()):i.init()}(window,document);