!function(e){"use strict";const t={actions:Object.create(null),filters:Object.create(null)},n=new Set;function r(e){return"string"==typeof e&&e.length>0&&!/[._]/.test(e)&&!/(proto|constructor)/.test(e)}function o(e,n,o,i=10){return!(!r(n)||"function"!=typeof o)&&(n in t[e]||(t[e][n]=[]),t[e][n].push({callback:o,priority:i}),t[e][n].sort((e,t)=>e.priority-t.priority),!0)}function i(e,n,o){if(!r(n)||!(n in t[e]))return!1;const i=t[e][n].findIndex(e=>e.callback===o);return i>-1&&(t[e][n].splice(i,1),!0)}e.StarmusHooks={addAction:function(e,t,n=10){o("actions",e,t,n)},removeAction:function(e,t){return i("actions",e,t)},doAction:function(e,...o){r(e)&&(n.add(e),e in t.actions&&t.actions[e].forEach(e=>{try{e.callback(...o)}catch(e){}}))},hasFired:function(e){return r(e)&&n.has(e)},addFilter:function(e,t,n=10){o("filters",e,t,n)},removeFilter:function(e,t){return i("filters",e,t)},applyFilters:function(e,n,...o){let i=n;return r(e)&&e in t.filters&&t.filters[e].forEach(e=>{try{i=e.callback(i,...o)}catch(e){}}),i}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>e.StarmusHooks.doAction("starmus_hooks_ready")):e.StarmusHooks.doAction("starmus_hooks_ready"),e.StarmusHooks.isPWA=()=>e.matchMedia("(display-mode: standalone)").matches||!0===e.navigator.standalone}(window),function(e){"use strict";const t=!(!e.MediaRecorder||!e.navigator.mediaDevices),n=Object.create(null);function r(e){return"string"==typeof e&&/^[A-Za-z0-9_-]{1,100}$/.test(e)}function o(e,t,n){console&&console[e]}function i(t,...n){e.StarmusHooks?.doAction&&e.StarmusHooks.doAction(t,...n)}function s(t,n,...r){return e.StarmusHooks?.applyFilters?e.StarmusHooks.applyFilters(t,n,...r):n}e.StarmusAudioRecorder={init:function(s){return o("info"),function(){if(!e.isStarmusAdmin)return;const t=document.createElement("div");t.textContent="[Starmus Recorder Module] JS Initialized",t.style.cssText="position:fixed;top:48px;left:0;z-index:99999;background:#22a;color:#fff;padding:4px 12px;font:14px monospace;opacity:0.95",document.body.appendChild(t),setTimeout(()=>t.remove(),4e3),o("info")}(),new Promise((a,c)=>{if(!t)return o("error"),c(new Error("MediaRecorder API not supported."));const u=s.formInstanceId;return r(u)?u in n?(o("info"),a(!0)):(i("starmus_before_recorder_init",u,s),void navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:16e3,channelCount:1}}).then(t=>{o("info");const r=new(e.AudioContext||e.webkitAudioContext)({sampleRate:16e3}),s=r.createMediaStreamSource(t),c=r.createAnalyser(),l=r.createGain(),d=r.createDynamicsCompressor(),m=r.createBiquadFilter();c.fftSize=1024,m.type="highpass",m.frequency.value=80,d.threshold.value=-24,d.knee.value=30,d.ratio.value=12,d.attack.value=.003,d.release.value=.25,s.connect(m),m.connect(d),d.connect(c),d.connect(l),n[u]={stream:t,recorder:null,chunks:[],audioBlob:null,isRecording:!1,isPaused:!1,startTime:0,ctx:r,analyser:c,gain:l,compressor:d,filter:m,isCalibrated:!1,volumeMonitorId:null,speechRecognition:null,transcript:[],currentLanguage:null,silenceStart:null,totalSilence:0,peakVolume:0,avgVolume:0,volumeSamples:[],sessionUUID:crypto.randomUUID?crypto.randomUUID():"uuid-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)},o("info",0,n[u]),i("starmus_after_recorder_init",u),a(!0)}).catch(e=>{o("error",0,e.message),i("starmus_recorder_init_failed",u,e),c(new Error("Microphone permission is required."))})):(o("error"),c(new Error("Invalid instance ID.")))})},calibrate:function(e,t){if(!r(e)||!(e in n))return;const o=n[e],a=o.analyser,c=new Float32Array(a.fftSize),u=[],l=performance.now();i("starmus_calibration_started",e),function n(){const r=performance.now()-l,d=Math.ceil((15e3-r)/1e3);t(r<5e3?"Be quiet for background noise ("+d+"s)":r<1e4?"Now speak clearly and loudly ("+d+"s)":"Be quiet again ("+d+"s)"),a.getFloatTimeDomainData(c);let m=0;for(let e=0;e<c.length;e++)m+=c[e]*c[e];const p=Math.sqrt(m/c.length);u.push(p),t(null,Math.min(100,2e3*p)),r<15e3?requestAnimationFrame(n):function(){const n=u.slice(0,Math.floor(.33*u.length)),r=u.slice(Math.floor(.33*u.length),Math.floor(.67*u.length)),a=n.reduce((e,t)=>e+t,0)/n.length,c=r.reduce((e,t)=>e+t,0)/r.length,l=c/Math.max(a,1e-6);let d=l<3?6:Math.max(1,Math.min(4,.1/Math.max(c,1e-6)));d=s("starmus_calibration_gain",d,e,{speechLevel:c,noiseFloor:a,snr:l}),o.gain.gain.setTargetAtTime(d,o.ctx.currentTime,.01),o.isCalibrated=!0,t("Ready to record. Mic calibrated (gain ×"+d.toFixed(1)+", SNR: "+l.toFixed(1)+").",null,!0),i("starmus_calibration_complete",e,{gain:d,snr:l,noiseFloor:a})}()}()},startVolumeMonitoring:function(e,t){if(!r(e)||!(e in n))return;const o=n[e],i=o.analyser,a=new Float32Array(i.fftSize);o.volumeMonitorId=requestAnimationFrame(function n(){if(!o.isRecording||o.isPaused)return void(o.volumeMonitorId=null);i.getFloatTimeDomainData(a);const r=a.reduce((e,t)=>e+t*t,0),c=Math.sqrt(r/a.length),u=Math.min(100,2e3*c);o.volumeSamples.push(u),o.peakVolume=Math.max(o.peakVolume,u),o.avgVolume=o.volumeSamples.reduce((e,t)=>e+t,0)/o.volumeSamples.length;const l=Date.now();u<5?o.silenceStart||(o.silenceStart=l):o.silenceStart&&(o.totalSilence+=l-o.silenceStart,o.silenceStart=null),t(s("starmus_volume_level",u,e)),o.volumeMonitorId=requestAnimationFrame(n)})},startRecording:function(t,s){let a="audio/webm",c="en-US";if("string"==typeof s&&(s.startsWith("audio/")?a=s:c=s),!r(t)||!(t in n)||n[t].isRecording)return;const u=n[t];if(e.SpeechRecognition||e.webkitSpeechRecognition){const n=e.SpeechRecognition||e.webkitSpeechRecognition;u.speechRecognition=new n,u.speechRecognition.continuous=!0,u.speechRecognition.interimResults=!0,u.speechRecognition.lang=c,u.currentLanguage=c,u.speechRecognition.onresult=e=>{const n=Date.now()-u.startTime;for(let r=e.resultIndex;r<e.results.length;r++){const o=e.results[r],s={text:o[0].transcript,confidence:o[0].confidence,timestamp:n,isFinal:o.isFinal,language:u.currentLanguage};o.isFinal&&(u.transcript.push(s),i("starmus_speech_recognized",t,s))}},u.speechRecognition.onerror=e=>{"no-speech"!==e.error&&"language-not-supported"!==e.error||u.transcript.push({text:"[Non-transcribable language detected]",confidence:0,timestamp:Date.now()-u.startTime,isFinal:!0,language:"unknown"})}}try{const e=u.ctx.createMediaStreamDestination();u.gain.connect(e);const n={audioBitsPerSecond:32e3};MediaRecorder.isTypeSupported(a)?n.mimeType=a:MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?n.mimeType="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/mp4")&&(n.mimeType="audio/mp4"),u.recorder=new MediaRecorder(e.stream,n),u.chunks=[],u.audioBlob=null,u.isRecording=!0,u.isPaused=!1,u.startTime=Date.now(),u.recorder.ondataavailable=e=>{e.data.size>0&&u.chunks.push(e.data)},u.recorder.onstop=()=>{let e=n.mimeType||"audio/webm";u.recorder&&u.recorder.mimeType&&u.recorder.mimeType.startsWith("audio/")&&(e=u.recorder.mimeType),u.audioBlob=new Blob(u.chunks,{type:e}),i("starmus_recording_stopped",t,u.audioBlob)},u.recorder.start(),u.speechRecognition&&u.speechRecognition.start(),i("starmus_recording_started",t)}catch(e){o("error",0,e.message),i("starmus_recording_failed",t,e)}},stopRecording:function(e){if(!r(e)||!(e in n))return Promise.reject(new Error("Invalid instance ID for stopRecording."));const t=n[e];return t.recorder&&"inactive"!==t.recorder.state?new Promise(n=>{t.recorder.onstop=()=>{t.audioBlob=new Blob(t.chunks,{type:t.recorder.mimeType||"audio/webm"}),o("info",0,(t.audioBlob.size,t.audioBlob.type)),t.silenceStart&&(t.totalSilence+=Date.now()-t.silenceStart),t.isRecording=!1,t.isPaused=!1,i("starmus_recording_stopped",e,t.audioBlob),n(t.audioBlob)},t.speechRecognition&&"ended"!==t.speechRecognition.readyState&&t.speechRecognition.stop(),t.recorder.stop()}):Promise.resolve()},getRecordingQuality:function(e){if(!r(e)||!(e in n))return null;const t=n[e],o=Date.now()-t.startTime,i=t.totalSilence/o;return{peakVolume:t.peakVolume,avgVolume:t.avgVolume,silenceRatio:i,quality:t.peakVolume>20&&t.avgVolume>10&&i<.7?"good":"poor",warnings:[...t.peakVolume<20?["Low volume detected"]:[],...i>.7?["Too much silence"]:[],...t.isCalibrated?[]:["Microphone not calibrated"]]}},togglePause:function(e){if(!r(e)||!(e in n))return;const t=n[e];t.recorder&&(t.isPaused&&"paused"===t.recorder.state?(t.recorder.resume(),t.isPaused=!1,i("starmus_recording_resumed",e)):"recording"===t.recorder.state&&(t.recorder.pause(),t.isPaused=!0,i("starmus_recording_paused",e)))},isPaused:function(e){return!(!r(e)||!(e in n))&&n[e].isPaused},getSubmissionData:function(t){if(!r(t)||!(t in n))return null;const o=n[t];if(o.audioBlob){let n="";try{const e=document.getElementById("starmus_recorder_form_"+t)||document.querySelector('form[id^="starmus_recorder_form"]');if(e){const t=e.querySelector('input[name="starmus_title"]');t&&t.value&&(n=t.value.trim())}}catch{n=""}n=n?n.replace(/[^a-zA-Z0-9\-_]+/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,""):"recording";const r=crypto.randomUUID?crypto.randomUUID():"sub-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),i=s("starmus_recorder_filename",`${n}-${r}.webm`,t),a=Date.now()-o.startTime;return s("starmus_submission_data",{blob:o.audioBlob,fileName:i,mimeType:o.audioBlob.type||"audio/webm",size:o.audioBlob.size,metadata:{sessionUUID:o.sessionUUID,submissionUUID:r,recordedAt:new Date(o.startTime).toISOString(),recordedAtLocal:new Date(o.startTime).toString(),duration:a,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,sampleRate:o.ctx.sampleRate,channelCount:1,bitDepth:16,codec:o.audioBlob.type,fileSize:o.audioBlob.size,userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,languages:navigator.languages,screenResolution:`${screen.width}x${screen.height}`,deviceMemory:navigator.deviceMemory||"unknown",hardwareConcurrency:navigator.hardwareConcurrency||"unknown",connection:navigator.connection?{effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink,rtt:navigator.connection.rtt}:"unknown",audioProcessing:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,gainApplied:o.gain.gain.value,isCalibrated:o.isCalibrated,compressionUsed:!0,highpassFilter:"80Hz"},quality:{peakVolume:o.peakVolume,avgVolume:o.avgVolume,silenceRatio:o.totalSilence/a,volumeConsistency:o.volumeSamples.length>0?o.volumeSamples.reduce((e,t)=>e+Math.abs(t-o.avgVolume),0)/o.volumeSamples.length:0},transcript:o.transcript.map(e=>({...e,timestampUTC:new Date(o.startTime+e.timestamp).toISOString(),timestampOffset:e.timestamp})),detectedLanguage:o.currentLanguage,hasTranscription:o.transcript.length>0,speechRecognitionAvailable:!(!e.SpeechRecognition&&!e.webkitSpeechRecognition)}},t)}return null},cleanup:function(e){if(!r(e)||!(e in n))return;const t=n[e];t.volumeMonitorId&&cancelAnimationFrame(t.volumeMonitorId),t.stream&&t.stream.getTracks().forEach(e=>e.stop()),i("starmus_recorder_cleanup",e),delete n[e]},validateWestAfricanLanguage:function(e,t="unknown"){if(!r(e)||!(e in n))return{isValid:!1,reason:"Invalid instance"};const o=n[e],i=Date.now()-o.startTime,s=o.transcript.map(e=>e.text).join(" ").toLowerCase().trim(),a=s?s.split(/\s+/).length:0,c=o.transcript.length>0?o.transcript.reduce((e,t)=>e+t.confidence,0)/o.transcript.length:0,u=t.toLowerCase();if(u.includes("word")||i<3e3&&a<=2){const e=/^(hello|yes|no|the|and|is|are|you|me|my|your|good|bad|big|small|one|two|three)$/i.test(s),t=/^(bonjour|oui|non|le|la|les|et|est|vous|moi|mon|votre|bon|mauvais|grand|petit|un|deux|trois)$/i.test(s);return c>.95&&(e||t)?{isValid:!1,reason:`Obvious ${e?"English":"French"} word detected`,recordingType:"word"}:{isValid:!0,reason:"Single word - likely West African",recordingType:"word",avgConfidence:c}}if(u.includes("phrase")||u.includes("proverb")||u.includes("saying")||i<15e3&&a<=15){const e=/\b(the|and|is|in|to|of|a|that|it|with|for|as|was|on|are|you|this|have|they|we|said|do|will|about|then|would|make|what|know|also|your|can|now|when|where|good|come|get|see|way|who|say)\b/g,t=/\b(le|la|les|de|des|du|et|est|dans|pour|avec|sur|sont|vous|que|qui|une|un|ce|ne|pas|tout|être|avoir|faire|dire|aller|voir|savoir|venir|vouloir|donner|parler)\b/g,n=(s.match(e)||[]).length,r=(s.match(t)||[]).length,o=Math.max(n,r)/Math.max(a,1);return o>.6&&c>.8?{isValid:!1,reason:`${Math.round(100*o)}% ${n>r?"English":"French"} phrase patterns`,recordingType:"phrase"}:{isValid:!0,reason:"Phrase/proverb - likely West African",recordingType:"phrase",avgConfidence:c}}const l=(s.match(/\b(the|and|is|in|to|of|a|that|it|with|for|as|was|on|are|you|this|have|from|they|we|been|their|said|which|do|how|will|about|many|then|some|would|make|like|has|more|what|know|first|also|your|work|only|can|should|now|here|when|where|good|come|could|get|new|see|way|who|did|say|too|any)\b/g)||[]).length,d=(s.match(/\b(le|la|les|de|des|du|et|est|dans|pour|avec|sur|sont|vous|que|qui|une|un|ce|se|ne|pas|tout|être|avoir|faire|dire|aller|voir|savoir|prendre|venir|vouloir|pouvoir|croire|donner|parler|porter|finir|partir|sentir|sortir|conduire)\b/g)||[]).length,m=Math.max(l,d)/Math.max(a,1);return m>.4&&c>.7?{isValid:!1,reason:`${Math.round(100*m)}% ${l>d?"English":"French"} patterns detected`,recordingType:"story"}:{isValid:!0,reason:"Recording validated - likely West African language",recordingType:"unknown",avgConfidence:c}},getTranscript:function(e){return r(e)&&e in n&&n[e].transcript||[]},_instances:n}}(window),function(e,t){"use strict";const n=Object.freeze({MIC_ADJUSTMENTS:"mic-rest-adjustments",DEVICE:"device",USER_AGENT:"user_agent"});function r(e,t,n){console&&console[e]}function o(e){return t.getElementById(e)}function i(e){return"string"==typeof e&&/^[A-Za-z0-9_-]{1,100}$/.test(e)}function s(e){return"string"==typeof e?e.replace(/[<>"'&]/g,""):""}function a(t,...n){e.StarmusHooks?.doAction&&e.StarmusHooks.doAction(t,...n)}function c(e){if("string"!=typeof e)return"";let t="";for(let n=0;n<e.length;n+=1){const r=e.charCodeAt(n),o=e.charAt(n);r<32||"<"===o||">"===o||(t+=o)}return t}function u(e,n){if(!i(e)||"string"!=typeof n)return null;const r=function(e){if(!i(e))return null;const n=t.getElementById(e);return n instanceof HTMLFormElement?n:null}(e);if(!r)return null;const o=r.elements.namedItem(n);return o instanceof HTMLInputElement?o:null}function l(e,t,n){const o=u(e,t);if(!o)return;let i="";if("string"==typeof n)i=c(n);else if(n&&"object"==typeof n)try{i=JSON.stringify(n,(e,t)=>"string"==typeof t?c(t):t)}catch(e){r("warn"),i=""}else null!=n&&(i=c(String(n)));i.length>2e3&&(i=i.slice(0,2e3)),o.value=i}function d(){const e=t.querySelectorAll("form.starmus-audio-form"),r=function(){const e=navigator.connection?{effectiveType:navigator.connection.effectiveType||"unknown",downlink:navigator.connection.downlink||"unknown",rtt:navigator.connection.rtt||"unknown"}:"unknown";return{platform:navigator.platform||"unknown",memory:navigator.deviceMemory||"unknown",concurrency:navigator.hardwareConcurrency||"unknown",screen:`${screen.width||0}x${screen.height||0}`,connection:e}}(),o=c(navigator.userAgent||"unknown");e.forEach(e=>{e instanceof HTMLFormElement&&i(e.id)&&(l(e.id,n.DEVICE,r),l(e.id,n.USER_AGENT,o))})}let m=!1;function p(){m||(e.StarmusHooks?.addAction?(e.StarmusHooks.addAction("starmus_calibration_complete",(e,t)=>{if(!i(e)||!t||"object"!=typeof t)return;const r=o(`starmus_recorder_status_${e}`),s={message:r?.textContent?r.textContent.trim():"",gain:"number"==typeof t.gain?Number(t.gain.toFixed(3)):null,snr:"number"==typeof t.snr?Number(t.snr.toFixed(3)):null,noiseFloor:"number"==typeof t.noiseFloor?Number(t.noiseFloor.toFixed(6)):null,recordedAt:(new Date).toISOString()};l(e,n.MIC_ADJUSTMENTS,s)}),m=!0):e.setTimeout(p,200))}function f(e,t,n){if(r("debug"),!i(e))return void r("warn");const s=o("starmus_recorder_status_"+e)||o("starmus_calibration_status_"+e)||o("starmus_step1_usermsg_"+e);s?(s.textContent=String(t||""),s.setAttribute("data-status",n||"info"),r("debug",0,s.id)):r("warn")}const g={db:null,name:"StarmusSubmissions",store:"pendingSubmissions",init:function(){if("indexedDB"in e)try{const e=indexedDB.open(this.name,1),t=this;e.onupgradeneeded=function(e){const n=e.target.result;n.objectStoreNames.contains(t.store)||n.createObjectStore(t.store,{keyPath:"id"})},e.onsuccess=function(e){t.db=e.target.result,r("log")},e.onerror=function(e){r("error")}}catch(e){r("error",0,e.message)}else r("warn")},add:function(e,t,n,o,s){if(this.db&&i(e))try{const i=this.db.transaction([this.store],"readwrite").objectStore(this.store),a=`starmus-offline-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,c={id:a,formInstanceId:e,fileName:n,when:Date.now(),audioBlob:t,formFields:o||{},meta:s||{}},u=i.add(c);u.onsuccess=function(){f(e,"You are offline. Submission saved and will auto-send when you reconnect.","success"),r("info")},u.onerror=function(){f(e,"Failed to save submission for offline sending.","error")}}catch(e){r("error",0,e.message)}else f(e,"Cannot save submission offline.","error")}};function b(t,n,o,a,c){if(r("info"),!i(c))return Promise.reject(new Error("Invalid instanceId for upload"));const u=e.starmusTus||{};if(!e.tus||!u.endpoint){r("warn");const i=e.starmusFormData||{};if(i.rest_url&&i.rest_nonce){const e=new FormData;e.append("_wpnonce",i.rest_nonce),i.user_id&&e.append("user_id",i.user_id),Object.keys(o||{}).forEach(function(t){const n=o[t];null!=n&&""!==n&&e.append(s(t),n)}),e.append("audio_file",t,s(n)||"recording.webm"),a&&e.append("metadata",JSON.stringify(a));const c=i.rest_url.replace("/upload-chunk","/upload-fallback");return r("debug"),fetch(c,{method:"POST",body:e}).then(function(e){return e.ok?(r("info"),e.json()):e.text().then(t=>{throw r("error",0,(e.status,e.statusText)),new Error(`Upload failed: ${e.status} - ${t}`)})})}return Promise.reject(new Error("Fallback REST endpoint not configured."))}return new Promise(function(e,i){const l=Object.assign({},o||{});l.filename=s(n)||"recording",a&&(l.starmus_meta=JSON.stringify(a)),r("info");const d=new tus.Upload(t,{endpoint:u.endpoint,chunkSize:u.chunkSize||5242880,retryDelays:u.retryDelays||[0,3e3,5e3,1e4,2e4],headers:u.headers||{},metadata:l,onError:function(e){r("error"),i(e)},onProgress:function(e,t){const n=Math.round(e/t*100);r("debug"),f(c,"Uploading… "+n+"%","info")},onSuccess:function(){r("info"),f(c,"Upload complete.","success"),e(d.url)}});d.findPreviousUploads().then(function(e){e.length&&(r("info"),d.resumeFromPreviousUpload(e[0])),d.start()}).catch(function(e){r("warn",0,e.message),d.start()})})}function h(e){if(!i(e))return;const t=o("starmus_recorder_container_"+e),n=o("starmus_fallback_container_"+e);t&&(t.style.display="none"),n&&(n.style.display="block"),a("starmus_tier_c_revealed",e)}function y(){r("info"),function(){if(!e.isStarmusAdmin)return;const n=t.createElement("div");n.textContent="[Starmus Submissions Handler] JS Initialized",n.style.cssText="position:fixed;top:24px;left:0;z-index:99999;background:#2a2;color:#fff;padding:4px 12px;font:14px monospace;opacity:0.95",t.body.appendChild(n),setTimeout(()=>n.remove(),4e3),r("info")}(),g.init(),d(),p(),r("info"),a("starmus_submissions_handler_ready")}"loading"===t.readyState?t.addEventListener("DOMContentLoaded",y):y(),e.StarmusSubmissionsHandler={init:y,handleSubmit:function(t,n){if(r("info"),!i(t))return r("warn"),Promise.reject(new Error("Unsafe instanceId"));const s=o(`starmus_submit_btn_${t}`),c=s?.textContent;s&&(s.disabled=!0,s.textContent="Submitting...");const u=e.StarmusAudioRecorder?.getSubmissionData?.(t),l=o("starmus_fallback_input_"+t);let d=null,m="recording.webm";if(u?.blob?(r("info"),d=u.blob,m=u.fileName):l?.files?.length&&(r("info",0,l.files[0]),d=l.files[0],m=l.files[0].name),!d)return r("error"),a("starmus_submission_failed",t,"No audio"),s&&(s.disabled=!1,s.textContent=c||"Submit"),Promise.reject(new Error("No audio blob found"));const p=u?.metadata||{},h=p.duration||0;if(h<1e3)return r("warn"),f(t,"Recording too short. Please record at least 1 second.","error"),a("starmus_submission_failed",t,"Recording too short"),s&&(s.disabled=!1,s.textContent=c||"Submit"),Promise.reject(new Error("Recording too short"));const y=e.StarmusAudioRecorder?.getRecordingQuality?.(t);if("poor"===y?.quality){const e=y.warnings.join(", ");r("warn"),f(t,`Recording quality may be poor: ${e}. Continue anyway?`,"warning"),a("starmus_quality_warning",t,y)}let _=null;const v=Array.isArray(e.starmusSettings?.allowedLanguages)?e.starmusSettings.allowedLanguages.map(e=>String(e).toLowerCase()):[];if(e.starmusSettings&&!0===e.starmusSettings.bypassLanguageValidation){const o=n.querySelector('select[name="recording_type"]'),i=o?.selectedOptions[0]?.text||"unknown",u=o?.value?.toLowerCase()||"";let l=!1,d="";if(v.length>0)l=v.includes(u),d=l?"Language allowed by admin setting.":`Language "${u}" not allowed.`;else{const n=e.StarmusAudioRecorder?.validateWestAfricanLanguage?.(t,i);l=n?.isValid??!1,d=n?.reason||"Validation result from engine."}if(_={isValid:l,reason:d},!l)return r("warn"),f(t,`Warning: ${_.reason}. This corpus is for West African languages only.`,"error"),a("starmus_language_validation_failed",t,_),s&&(s.disabled=!1,s.textContent=c||"Submit"),Promise.reject(new Error("Language validation failed"))}else r("info"),_={isValid:!0,reason:"Bypassed by default."},a("starmus_language_validation_bypassed",t);_?.isValid&&(r("info"),a("starmus_west_african_language_confirmed",t,_));const w=function(e){const t={};return new FormData(e).forEach((e,n)=>t[n]=e),t}(n);p.transcript&&p.transcript.length>0&&(r("info"),w.first_pass_transcription=JSON.stringify({transcript:p.transcript,detectedLanguage:p.detectedLanguage,hasTranscription:p.hasTranscription,recordedAt:p.recordedAt,timezone:p.timezone})),w.recording_metadata=JSON.stringify({identifiers:{sessionUUID:p.sessionUUID,submissionUUID:p.submissionUUID,formInstanceId:t},technical:{duration:p.duration,sampleRate:p.sampleRate,codec:p.codec,fileSize:p.fileSize,audioProcessing:p.audioProcessing},device:{userAgent:p.userAgent,platform:p.platform,screenResolution:p.screenResolution,deviceMemory:p.deviceMemory,hardwareConcurrency:p.hardwareConcurrency,connection:p.connection},linguistic:{browserLanguage:p.language,browserLanguages:p.languages,detectedLanguage:p.detectedLanguage,speechRecognitionAvailable:p.speechRecognitionAvailable,westAfricanValidation:_},temporal:{recordedAt:p.recordedAt,recordedAtLocal:p.recordedAtLocal,timezone:p.timezone,submittedAt:(new Date).toISOString()}});const S={instanceId:t,blob:d,fileName:m,formFields:w,metadata:p};return function(t,n,...r){return e.StarmusHooks?.applyFilters?e.StarmusHooks.applyFilters(t,n,...r):n}("starmus_before_submit",!0,S)?(r("info"),a("starmus_submission_started",t,S),b(d,m,w,p,t).then(n=>(r("info"),a("starmus_upload_success",t,n),function(t,n,r){const o=e.starmusFormData||{};if(!o.rest_url||!o.rest_nonce)return Promise.resolve();const i=new FormData;Object.keys(n||{}).forEach(e=>i.append(e,n[e])),i.append("tus_url",t||""),i.append("metadata",JSON.stringify(r)),n.first_pass_transcription&&i.append("first_pass_transcription",n.first_pass_transcription);const s=o.rest_url.replace("/upload-chunk","/upload-fallback");return fetch(s,{method:"POST",headers:{"X-WP-Nonce":o.rest_nonce},body:i})}(n,w,p))).then(()=>{r("info"),a("starmus_submission_complete",t,S),s&&(s.textContent="Submitted!",setTimeout(()=>{s.disabled=!1,s.textContent=c||"Submit"},2e3))}).catch(e=>{throw r("error"),navigator.onLine?f(t,"Submission failed. The server responded with an error. Please try again later.","error"):(f(t,"You seem to be offline. Your submission has been saved and will be sent automatically when you reconnect.","info"),g.add(t,d,m,w,p)),s&&(s.disabled=!1,s.textContent=c||"Submit Recording"),a("starmus_submission_failed",t,e),e})):(r("info"),a("starmus_submission_queued",t,S),Promise.resolve("Handled by filter"))},initRecorder:function(t){return r("info"),new Promise((n,o)=>{if(!i(t))return r("warn"),void o(new Error("Unsafe instanceId"));const s=e.StarmusAudioRecorder;return s&&"function"==typeof s.init?s._instances&&s._instances[t]?(r("info"),n(!0)):(f(t,"Initializing microphone...","info"),void s.init({formInstanceId:t}).then(function(e){r("info"),e&&"A"===e.tier?f(t,"Recorder ready. Use “Setup Mic” for best results.","info"):f(t,"Recorder ready.","info"),n(e)}).catch(function(e){r("error",0,e&&e.message),h(t),o(e)})):(r("warn"),h(t),void o(new Error("Recorder module missing or invalid")))})},resumableTusUpload:b}}(window,document),function(e,t){"use strict";function n(e,t,n){console&&console[e]}function r(e){return t.getElementById(e)}function o(e){return"string"==typeof e&&/^[A-Za-z0-9_-]{1,100}$/.test(e)}function i(t,...n){e.StarmusHooks?.doAction&&e.StarmusHooks.doAction(t,...n)}function s(e,t,n="info"){if(!o(e))return;const i=r(`starmus_recorder_status_${e}`)||r(`starmus_step1_usermsg_${e}`)||r(`starmus_calibration_status_${e}`);var s;i&&(i.textContent="string"==typeof(s=t)?s.replace(/[<>"'&]/g,"").substring(0,500):"",i.setAttribute("data-status",n),i.style.display=t?"block":"none")}const a={};function c(e){a[e]&&(clearInterval(a[e]),delete a[e])}function u(u){if(!o(u))return;const l=r(`starmus_recorder_container_${u}`);if(!l)return;l.innerHTML=`\n        <div class="starmus-recorder-status" id="starmus_recorder_status_${u}"></div>\n        <div class="starmus-volume-meter">\n            <div id="starmus_volume_level_${u}" class="starmus-volume-level"></div>\n        </div>\n        <div class="starmus-recorder-controls">\n            <div class="starmus-btn-group">\n                <button type="button" id="starmus_calibrate_btn_${u}" class="starmus-btn starmus-btn--secondary">Mic Test</button>\n                <button type="button" id="starmus_record_btn_${u}" class="starmus-btn starmus-btn--record" disabled>Record</button>\n                <button type="button" id="starmus_stop_btn_${u}" class="starmus-btn starmus-btn--stop" style="display:none;">Stop</button>\n                <button type="button" id="starmus_pause_btn_${u}" class="starmus-btn starmus-btn--pause" style="display:none;">Pause</button>\n                <button type="button" id="starmus_delete_btn_${u}" class="starmus-btn starmus-btn--danger" style="display:none;">Delete</button>\n            </div>\n            <div id="starmus_timer_${u}" class="starmus-recorder-timer">00:00</div>\n            <div class="starmus-timer-progress-bar-wrapper">\n                <div id="starmus_timer_progress_${u}" class="starmus-timer-progress-bar"></div>\n            </div>\n        </div>\n    `;const d=r(`starmus_calibrate_btn_${u}`),m=r(`starmus_record_btn_${u}`),p=r(`starmus_stop_btn_${u}`),f=r(`starmus_pause_btn_${u}`),g=r(`starmus_delete_btn_${u}`),b=t.querySelector(`#${u} #starmus_submit_btn_${u}`),h=r(`starmus_recorder_status_${u}`);if(!(d&&m&&p&&f&&g&&b&&h))return;h.textContent="Please run the mic setup for best results.",h.style.display="block";d.addEventListener("click",()=>{d.disabled=!0,m.disabled=!0,i("starmus_calibration_start",u),e.StarmusAudioRecorder.calibrate(u,(e,t,n)=>{e&&(h.textContent=e);const o=r(`starmus_volume_level_${u}`);o&&"number"==typeof t&&(o.style.width=`${t}%`),n&&(d.disabled=!1,m.disabled=!1,i("starmus_calibration_complete",u))})}),m.addEventListener("click",()=>{i("starmus_record_start",u);let n="audio/webm";const s=t.querySelector(`#${u} [name="audio_file_type"]`);s&&s.value&&(n=s.value),e.StarmusAudioRecorder.startRecording(u,n),e.StarmusAudioRecorder.startVolumeMonitoring(u,e=>{const t=r(`starmus_volume_level_${u}`);t&&(t.style.width=`${e}%`)}),d.disabled=!0,m.style.display="none",p.style.display="inline-block",f.style.display="inline-block",g.style.display="inline-block",b.disabled=!0,h.textContent="Recording...",function(t){if(!o(t)||a[t])return;const n=12e5;a[t]=setInterval(()=>{const o=e.StarmusAudioRecorder?._instances?.[t],i=r(`starmus_timer_${t}`),s=r(`starmus_timer_progress_${t}`);if(o?.isRecording&&!o.isPaused&&i&&s){const e=Date.now()-o.startTime,t=Math.floor(e/6e4),r=Math.floor(e%6e4/1e3);i.textContent=String(t).padStart(2,"0")+":"+String(r).padStart(2,"0");const a=Math.min(100,e/n*100);s.style.width=a+"%";const c=(n-e)/1e3;s.style.background=c<=180?"#e74c3c":c<=420?"#f39c12":"#27ae60"}},1e3)}(u)}),p.addEventListener("click",()=>{i("starmus_record_stop",u),h.textContent="Finalizing recording...",b.disabled=!0,e.StarmusAudioRecorder.stopRecording(u).then(e=>{n("info"),c(u),p.style.display="none",f.style.display="none",g.style.display="none",m.textContent="Record Again",m.style.display="inline-block",d.disabled=!1,d.style.display="inline-block",b.disabled=!1,h.textContent="Recording finished. Ready to submit."}).catch(e=>{n("error"),s(u,"Failed to finalize recording. Please try again.","error")})}),g.addEventListener("click",()=>{i("starmus_record_delete",u),e.StarmusAudioRecorder.stopRecording(u),c(u),p.style.display="none",f.style.display="none",g.style.display="none",m.textContent="Record",m.style.display="inline-block",d.disabled=!1,d.style.display="inline-block",b.disabled=!0,h.textContent="Recording canceled. You can start again."}),f.addEventListener("click",()=>{e.StarmusAudioRecorder.togglePause(u);const t=e.StarmusAudioRecorder.isPaused(u);f.textContent=t?"Resume":"Pause",h.textContent=t?"Paused.":"Recording...",i("starmus_record_pause",u,t),t||e.StarmusAudioRecorder.startVolumeMonitoring(u,e=>{const t=r(`starmus_volume_level_${u}`);t&&(t.style.width=`${e}%`)})})}function l(t){if(!o(t))return;const n=r(t),a=r(`starmus_step1_${t}`),c=r(`starmus_step2_${t}`);if(!n||!a||!c)return;let l=!0;for(const e of a.querySelectorAll("[required]"))if(!e.checkValidity()){s(t,"Please complete all required fields.","error"),"function"==typeof e.reportValidity&&e.reportValidity(),l=!1;break}if(l){if(i("starmus_step_continue",t,n),a.style.display="none",c.style.display="block",s(t,"","info"),!e.StarmusSubmissionsHandler?.initRecorder)return s(t,"A critical component is missing. Please reload.","error"),a.style.display="block",void(c.style.display="none");e.StarmusSubmissionsHandler.initRecorder(t).then(()=>{u(t),i("starmus_recorder_ui_built",t)}).catch(e=>{s(t,"Could not initialize microphone. Please check permissions and try again.","error"),a.style.display="block",c.style.display="none",i("starmus_recorder_init_failed",t,e)})}}function d(t){const n=t.id;if(!o(n)||t.getAttribute("data-starmus-bound"))return;t.setAttribute("data-starmus-bound","1"),i("starmus_form_init",n,t);const r=t.querySelector(`#starmus_continue_btn_${n}`);r&&r.addEventListener("click",()=>l(n));let a=!1;t.addEventListener("submit",r=>{r.preventDefault(),a||(e.StarmusSubmissionsHandler?.handleSubmit?(a=!0,i("starmus_form_submit",n,t),e.StarmusSubmissionsHandler.handleSubmit(n,t).finally(()=>{a=!1})):s(n,"Cannot submit. A critical component is missing.","error"))})}function m(){if(e.starmusUiInitialized)return;e.starmusUiInitialized=!0,n("info"),function(){if(!e.isStarmusAdmin)return;const r=t.createElement("div");r.textContent="[Starmus UI Controller] JS Initialized",r.style.cssText="position:fixed;top:0;left:0;z-index:99999;background:#222;color:#fff;padding:4px 12px;font:14px monospace;opacity:0.95",t.body.appendChild(r),setTimeout(()=>r.remove(),4e3),n("info")}();t.querySelectorAll("form.starmus-audio-form").forEach(d),i("starmus_ui_controller_ready")}"loading"===t.readyState?t.addEventListener("DOMContentLoaded",m):m(),e.StarmusUIController={init:m,showUserMessage:s,buildRecorderUI:u,handleContinueClick:l,handleMicError:function(n,r){let o="";o=n&&"NotAllowedError"===n.name?e.starmusTranslations?.micBlocked||"Microphone blocked. Click the lock icon in your browser, allow microphone, then reload.":n&&"NotFoundError"===n.name?e.starmusTranslations?.noMic||"No microphone found. Please use a phone or computer with a microphone.":e.starmusTranslations?.micUnavailable||"We couldn’t access your microphone. Please check if another app is using it or try again.";let i=r.querySelector(".starmus-mic-banner");i||(i=t.createElement("div"),i.className="starmus-mic-banner",r.prepend(i)),i.textContent=o}}}(window,document);