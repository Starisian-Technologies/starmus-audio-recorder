// ==== starmus-audio-recorder-module.js ====
// Build Hash (SHA-1):   5d1d4d6c4c069458c2cc8e38b152089c5ca76a96
// Build Hash (SHA-256): 8514ac4d9bed320da4fe4284ce7fa30d6c96aac0a772e34025f85ca6c9a3f8f6
// Build Time: 2025-09-11T00:24:05.551Z

!function(e){buildHash: '5d1d4d6c4c069458c2cc8e38b152089c5ca76a96',
  "use strict";const t={actions:Object.create(null),filters:Object.create(null)};function r(e){return"string"==typeof e&&e.length>0&&!/[.__proto__constructor]/.test(e)}function n(e,n,o,s=10){return!(!r(n)||"function"!=typeof o)&&(n in t[e]||(t[e][n]=[]),t[e][n].push({callback:o,priority:s}),t[e][n].sort((e,t)=>e.priority-t.priority),!0)}function o(e,n,o){if(!r(n)||!(n in t[e]))return!1;const s=t[e][n].findIndex(e=>e.callback===o);return s>-1&&(t[e][n].splice(s,1),!0)}e.StarmusHooks={addAction:function(e,t,r=10){n("actions",e,t,r)},removeAction:function(e,t){return o("actions",e,t)},doAction:function(e,...n){r(e)&&e in t.actions&&t.actions[e].forEach(e=>{try{e.callback(...n)}catch(e){}})},addFilter:function(e,t,r=10){n("filters",e,t,r)},removeFilter:function(e,t){return o("filters",e,t)},applyFilters:function(e,n,...o){let s=n;return r(e)&&e in t.filters&&t.filters[e].forEach(e=>{try{s=e.callback(s,...o)}catch(e){}}),s}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>e.StarmusHooks.doAction("starmus_hooks_ready")):e.StarmusHooks.doAction("starmus_hooks_ready")}(window),function(e){"use strict";const t=!(!e.MediaRecorder||!e.navigator.mediaDevices),r=Object.create(null);function n(e){return"string"==typeof e&&/^[a-zA-Z0-9_-]{1,100}$/.test(e)}function o(e,t,r){console&&console[e]}function s(t,...r){e.StarmusHooks&&e.StarmusHooks.doAction(t,...r)}function i(t,r,...n){return e.StarmusHooks?e.StarmusHooks.applyFilters(t,r,...n):r}e.StarmusAudioRecorder={init:function(i){return new Promise((a,u)=>{if(!t)return u(new Error("MediaRecorder API not supported."));const c=i.formInstanceId;return n(c)?c in r?a(!0):(s("starmus_before_recorder_init",c,i),void navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{const n=new(e.AudioContext||e.webkitAudioContext),o=n.createMediaStreamSource(t),i=n.createAnalyser(),u=n.createGain();i.fftSize=2048,o.connect(i),i.connect(u),r[c]={stream:t,recorder:null,chunks:[],audioBlob:null,isRecording:!1,isPaused:!1,startTime:0,ctx:n,analyser:i,gain:u,isCalibrated:!1},s("starmus_after_recorder_init",c),a(!0)}).catch(e=>{o("error",0,e.message),s("starmus_recorder_init_failed",c,e),u(new Error("Microphone permission is required."))})):u(new Error("Invalid instance ID."))})},calibrate:function(e,t){if(!n(e)||!(e in r))return;const o=r[e],a=o.analyser,u=new Float32Array(a.fftSize),c=[],d=performance.now();s("starmus_calibration_started",e),function r(){const n=performance.now()-d,l=Math.ceil((1e4-n)/1e3);t(n<3e3?"Be quiet for background noise ("+l+"s)":n<7e3?"Now speak normally ("+l+"s)":"Be quiet again ("+l+"s)"),a.getFloatTimeDomainData(u);let m=0;for(let e=0;e<u.length;e++)m+=u[e]*u[e];const f=Math.sqrt(m/u.length);c.push(f),t(null,Math.min(100,2e3*f)),n<1e4?requestAnimationFrame(r):function(){const r=c.reduce((e,t)=>e+t,0)/Math.max(1,c.length);let n=Math.max(.5,Math.min(8,.05/Math.max(1e-6,r)));n=i("starmus_calibration_gain",n,e,r),o.gain.gain.setTargetAtTime(n,o.ctx.currentTime,.01),o.isCalibrated=!0,t("Mic calibrated (gain ×"+n.toFixed(2)+"). Ready to record.",null,!0),s("starmus_calibration_complete",e,n)}()}()},startVolumeMonitoring:function(e,t){if(!n(e)||!(e in r))return;const o=r[e],s=o.analyser,a=new Float32Array(s.fftSize);!function r(){if(!o.isRecording||o.isPaused)return;s.getFloatTimeDomainData(a);let n=0;for(let e=0;e<a.length;e++)n+=a[e]*a[e];const u=Math.sqrt(n/a.length),c=Math.min(100,2e3*u);t(i("starmus_volume_level",c,e)),requestAnimationFrame(r)}()},startRecording:function(e){if(!n(e)||!(e in r)||r[e].isRecording)return;const t=r[e];try{const r=t.ctx.createMediaStreamDestination();t.gain.connect(r),t.recorder=new MediaRecorder(r.stream),t.chunks=[],t.audioBlob=null,t.isRecording=!0,t.isPaused=!1,t.startTime=Date.now(),t.recorder.ondataavailable=e=>{e.data.size>0&&t.chunks.push(e.data)},t.recorder.onstop=()=>{t.audioBlob=new Blob(t.chunks,{type:t.recorder.mimeType||"audio/webm"}),s("starmus_recording_stopped",e,t.audioBlob)},t.recorder.start(),s("starmus_recording_started",e)}catch(t){o("error",0,t.message),s("starmus_recording_failed",e,t)}},stopRecording:function(e){if(!n(e)||!(e in r)||!r[e].isRecording)return;const t=r[e];t.recorder&&"inactive"!==t.recorder.state&&t.recorder.stop(),t.isRecording=!1,t.isPaused=!1},togglePause:function(e){if(!n(e)||!(e in r)||!r[e].isRecording)return;const t=r[e];t.isPaused?(t.recorder.resume(),t.isPaused=!1,s("starmus_recording_resumed",e)):(t.recorder.pause(),t.isPaused=!0,s("starmus_recording_paused",e))},getSubmissionData:function(e){if(!n(e)||!(e in r))return null;const t=r[e];if(t.audioBlob){return i("starmus_submission_data",{blob:t.audioBlob,fileName:"starmus-recording.webm",mimeType:t.audioBlob.type||"audio/webm",size:t.audioBlob.size,metadata:{recordedAt:new Date(t.startTime).toISOString()}},e)}return null},cleanup:function(e){if(!n(e)||!(e in r))return;const t=r[e];t.stream&&t.stream.getTracks().forEach(e=>e.stop()),s("starmus_recorder_cleanup",e),delete r[e]}}}(window),function(e,t){"use strict";const r={LOG_PREFIX:"[Starmus Submissions]"};function n(e,t,r){console&&console[e]}function o(e){return t.getElementById(e)}function i(e){return"string"==typeof e&&/^[A-Za-z0-9_-]{1,100}$/.test(e)}function a(t,...r){e.StarmusHooks&&e.StarmusHooks.doAction(t,...r)}function u(t,r,...n){return e.StarmusHooks?e.StarmusHooks.applyFilters(t,r,...n):r}function c(e,t,r){if(!i(e))return;const n=o("starmus_recorder_status_"+e)||o("starmus_calibration_status_"+e)||o("starmus_step1_usermsg_"+e);n&&(n.textContent=s(t),n.setAttribute("data-status",r||"info"))}const d={db:null,name:"StarmusSubmissions",store:"pendingSubmissions",init:function(){if("indexedDB"in e)try{const e=indexedDB.open(this.name,1),t=this;e.onupgradeneeded=function(e){const r=e.target.result;r.objectStoreNames.contains(t.store)||r.createObjectStore(t.store,{keyPath:"id",autoIncrement:!0})},e.onsuccess=function(e){t.db=e.target.result,n("log"),t.processQueue()},e.onerror=function(e){n("error",0,e&&e.target&&e.target.errorCode)}}catch(e){n("error",0,e.message)}else n("warn")},add:function(e,t,r,o,s){if(this.db&&i(e))try{const n=this.db.transaction([this.store],"readwrite"),i=n.objectStore(this.store).add({formInstanceId:e,fileName:r,when:Date.now(),audioBlob:t,formFields:o||{},meta:s||{}});i.onsuccess=function(){c(e,"You are offline. Saved and will auto-send later.","success")},i.onerror=function(){c(e,"Failed to save offline.","error")}}catch(e){n("error",0,e.message)}else c(e,"Cannot save offline here.","error")},processQueue:function(){if(this.db&&navigator.onLine)try{const e=this.db.transaction([this.store],"readwrite").objectStore(this.store);let t=0;e.openCursor().onsuccess=function(r){const o=r.target.result;if(o){const r=o.value;setTimeout(function(){l(r.audioBlob,r.fileName,r.formFields,r.meta,r.formInstanceId).then(function(){c(r.formInstanceId,"Queued submission sent.","success"),e.delete(o.key)}).catch(function(e){n("error",0,e&&e.message)})},1e3*t),t++,o.continue()}}}catch(e){n("error",0,e.message)}}};function l(t,r,o,a,u){if(!i(u))return Promise.reject(new Error("Invalid instanceId for upload"));const d=e.starmusTus||{};if(!e.tus||!d.endpoint){const n=e.starmusFormData||{};if(n.rest_url&&n.rest_nonce){const e=new FormData;return Object.keys(o||{}).forEach(function(t){e.append(s(t),o[t])}),e.append("audio_file",t,s(r)||"recording"),a&&e.append("metadata",JSON.stringify(a)),fetch(n.rest_url,{method:"POST",headers:{"X-WP-Nonce":n.rest_nonce},body:e}).then(function(e){if(!e.ok)throw new Error("Direct upload failed: "+e.status);return e})}return Promise.reject(new Error("tus missing and no fallback endpoint configured"))}return new Promise(function(e,i){const l=Object.assign({},o||{});l.filename=s(r)||"recording",a&&(l.starmus_meta=JSON.stringify(a));const m=new tus.Upload(t,{endpoint:d.endpoint,chunkSize:d.chunkSize||5242880,retryDelays:d.retryDelays||[0,3e3,5e3,1e4,2e4],headers:d.headers||{},metadata:l,onError:function(e){i(e)},onProgress:function(e,t){const r=Math.round(e/t*100);c(u,"Uploading… "+r+"%","info")},onSuccess:function(){c(u,"Upload complete.","success"),e(m.url)}});m.findPreviousUploads().then(function(e){e.length&&m.resumeFromPreviousUpload(e[0]),m.start()}).catch(function(e){n("warn",0,e.message),m.start()})})}function m(t){if(!i(t))return;const o=e.StarmusAudioRecorder;o&&"function"==typeof o.init?(c(t,"Initializing microphone...","info"),o.init({formInstanceId:t,srContinuous:r.SPEECH_CONFIG.continuous,language:r.SPEECH_CONFIG.language}).then(function(e){e&&"A"===e.tier?c(t,"Recorder ready. Use “Setup Mic” for best results.","info"):c(t,"Recorder ready.","info")}).catch(function(e){n("error",0,e&&e.message),f(t)})):f(t)}function f(e){if(!i(e))return;const t=o("starmus_recorder_container_"+e),r=o("starmus_fallback_container_"+e);t&&(t.style.display="none"),r&&(r.style.display="block"),a("starmus_tier_c_revealed",e)}function _(e){const t=new FormData(e),r={};return t.forEach(function(e,t){"audio_file"!==t&&(r[s(t)]=e)}),r}function p(t,r){if(!i(t))return;const s=e.StarmusAudioRecorder?.getSubmissionData?.(t),c=o("starmus_fallback_input_"+t);let m=null,f="recording.webm";if(s?.blob?(m=s.blob,f=s.fileName):c?.files?.length&&(m=c.files[0],f=c.files[0].name),!m)return void a("starmus_submission_failed",t,"No audio");const p=_(r),g=s?.metadata||{},b={instanceId:t,blob:m,fileName:f,formFields:p,metadata:g};u("starmus_before_submit",!0,b)?(a("starmus_submission_started",t,b),l(m,f,p,g,t).then(r=>(a("starmus_upload_success",t,r),function(t,r,n){const o=e.starmusFormData||{};if(!o.rest_url||!o.rest_nonce)return Promise.resolve();const s=new FormData;return Object.keys(r||{}).forEach(e=>s.append(e,r[e])),s.append("tus_url",t||""),s.append("metadata",JSON.stringify(n)),fetch(o.rest_url,{method:"POST",headers:{"X-WP-Nonce":o.rest_nonce},body:s})}(r,p,g))).then(()=>{a("starmus_submission_complete",t)}).catch(e=>{n("error"),a("starmus_submission_failed",t,e),d.add(t,m,f,p,g)})):n("log")}function _(e){const t=new FormData(e),r={};return t.forEach((e,t)=>{"audio_file"!==t&&(r[t]=e)}),u("starmus_form_fields",r,e)}function m(t){return new Promise((r,o)=>{if(!e.StarmusAudioRecorder?.init)return f(t),o(new Error("Recorder module missing."));e.StarmusAudioRecorder.init({formInstanceId:t}).then(r).catch(e=>{n("error"),f(t),o(e)})})}function g(){d.init(),e.addEventListener("online",()=>d.processQueue()),a("starmus_submissions_handler_ready")}e.StarmusHooks?e.StarmusHooks.addAction("starmus_hooks_ready",g,5):"loading"===t.readyState?t.addEventListener("DOMContentLoaded",g):g(),e.StarmusSubmissionsHandler={handleSubmit:p,initRecorder:m,Offline:d}}(window,document),function(e,t){"use strict";function r(e){return t.getElementById(e)}function n(e){return"string"==typeof e&&/^[a-zA-Z0-9_-]{1,100}$/.test(e)}const o=e.StarmusHooks;function s(e,t,o="info"){if(!n(e))return;const s=r(`starmus_recorder_status_${e}`)||r(`starmus_step1_usermsg_${e}`);var i;s&&(s.textContent="string"!=typeof(i=t)?"":i.replace(/[\x00-\x1F\x7F<>"'&]/g," ").substring(0,500),s.setAttribute("data-status",o),s.style.display=t?"block":"none")}function i(t){if(!n(t))return;r(`starmus_recorder_container_${t}`);setInterval(()=>{if(!n(t))return;const o=e.StarmusAudioRecorder.instances[t],s=r(`starmus_timer_${t}`);if(o?.isRecording&&!o.isPaused&&s){const e=Date.now()-o.startTime,t=Math.floor(e/6e4),r=Math.floor(e%6e4/1e3);s.textContent=String(t).padStart(2,"0")+":"+String(r).padStart(2,"0")}},1e3)}function a(t){if(!n(t))return;const o=r(`starmus_step1_${t}`),a=r(`starmus_step2_${t}`);let u=!0;for(const e of o.querySelectorAll("[required]"))if(!e.checkValidity()){s(t,"Please complete all required fields.","error"),"function"==typeof e.reportValidity&&e.reportValidity(),u=!1;break}u&&(o.style.display="none",a.style.display="block",s(t,"","info"),e.StarmusSubmissionsHandler.initRecorder(t).then(()=>{i(t)}).catch(e=>{var t;t="error",console&&console[t],o.style.display="block",a.style.display="none"}))}function u(t){const n=t.id;t.getAttribute("data-starmus-bound")||(t.setAttribute("data-starmus-bound","1"),r(`starmus_continue_btn_${n}`).addEventListener("click",()=>a(n)),t.addEventListener("submit",r=>{r.preventDefault(),e.StarmusSubmissionsHandler.handleSubmit(n,t)}))}o.addAction("starmus_hooks_ready",function(){t.querySelectorAll("form.starmus-audio-form").forEach(u),o.doAction("starmus_ui_ready")}),e.StarmusUIController={updateRecorderUI:function(e,t){n(e)},showUserMessage:s,buildRecorderUI:i}}(window,document);