!function(e){"use strict";const r=!(!e.MediaRecorder||!e.navigator.mediaDevices),t=Object.create(null);function n(e){return"string"==typeof e&&/^[a-zA-Z0-9_-]{1,100}$/.test(e)}function i(e,r,t){console&&console[e]&&console[e]("[Starmus Recorder]",r,t||"")}function a(r,...t){e.StarmusHooks&&e.StarmusHooks.doAction(r,...t)}function o(r,t,...n){return e.StarmusHooks?e.StarmusHooks.applyFilters(r,t,...n):t}e.StarmusAudioRecorder={init:function(o){return new Promise((s,c)=>{if(!r)return c(new Error("MediaRecorder API not supported."));const u=o.formInstanceId;return n(u)?u in t?s(!0):(a("starmus_before_recorder_init",u,o),void navigator.mediaDevices.getUserMedia({audio:!0}).then(r=>{const n=new(e.AudioContext||e.webkitAudioContext),i=n.createMediaStreamSource(r),o=n.createAnalyser(),c=n.createGain();o.fftSize=2048,i.connect(o),o.connect(c),t[u]={stream:r,recorder:null,chunks:[],audioBlob:null,isRecording:!1,isPaused:!1,startTime:0,ctx:n,analyser:o,gain:c,isCalibrated:!1},a("starmus_after_recorder_init",u),s(!0)}).catch(e=>{i("error","Microphone access denied.",e.message),a("starmus_recorder_init_failed",u,e),c(new Error("Microphone permission is required."))})):c(new Error("Invalid instance ID."))})},calibrate:function(e,r){if(!n(e)||!(e in t))return;const i=t[e],s=i.analyser,c=new Float32Array(s.fftSize),u=[],d=performance.now();a("starmus_calibration_started",e),function t(){const n=performance.now()-d,l=Math.ceil((1e4-n)/1e3);r(n<3e3?"Be quiet for background noise ("+l+"s)":n<7e3?"Now speak normally ("+l+"s)":"Be quiet again ("+l+"s)"),s.getFloatTimeDomainData(c);let m=0;for(let e=0;e<c.length;e++)m+=c[e]*c[e];const f=Math.sqrt(m/c.length);u.push(f),r(null,Math.min(100,2e3*f)),n<1e4?requestAnimationFrame(t):function(){const t=u.reduce((e,r)=>e+r,0)/Math.max(1,u.length);let n=Math.max(.5,Math.min(8,.05/Math.max(1e-6,t)));n=o("starmus_calibration_gain",n,e,t),i.gain.gain.setTargetAtTime(n,i.ctx.currentTime,.01),i.isCalibrated=!0,r("Mic calibrated (gain Ã—"+n.toFixed(2)+"). Ready to record.",null,!0),a("starmus_calibration_complete",e,n)}()}()},startVolumeMonitoring:function(e,r){if(!n(e)||!(e in t))return;const i=t[e],a=i.analyser,s=new Float32Array(a.fftSize);!function t(){if(!i.isRecording||i.isPaused)return;a.getFloatTimeDomainData(s);let n=0;for(let e=0;e<s.length;e++)n+=s[e]*s[e];const c=Math.sqrt(n/s.length),u=Math.min(100,2e3*c);r(o("starmus_volume_level",u,e)),requestAnimationFrame(t)}()},startRecording:function(e){if(!n(e)||!(e in t)||t[e].isRecording)return;const r=t[e];try{const t=r.ctx.createMediaStreamDestination();r.gain.connect(t),r.recorder=new MediaRecorder(t.stream),r.chunks=[],r.audioBlob=null,r.isRecording=!0,r.isPaused=!1,r.startTime=Date.now(),r.recorder.ondataavailable=e=>{e.data.size>0&&r.chunks.push(e.data)},r.recorder.onstop=()=>{r.audioBlob=new Blob(r.chunks,{type:r.recorder.mimeType||"audio/webm"}),a("starmus_recording_stopped",e,r.audioBlob)},r.recorder.start(),a("starmus_recording_started",e)}catch(r){i("error","Failed to start recording.",r.message),a("starmus_recording_failed",e,r)}},stopRecording:function(e){if(!n(e)||!(e in t)||!t[e].isRecording)return;const r=t[e];r.recorder&&"inactive"!==r.recorder.state&&r.recorder.stop(),r.isRecording=!1,r.isPaused=!1},togglePause:function(e){if(!n(e)||!(e in t)||!t[e].isRecording)return;const r=t[e];r.isPaused?(r.recorder.resume(),r.isPaused=!1,a("starmus_recording_resumed",e)):(r.recorder.pause(),r.isPaused=!0,a("starmus_recording_paused",e))},getSubmissionData:function(e){if(!n(e)||!(e in t))return null;const r=t[e];if(r.audioBlob){return o("starmus_submission_data",{blob:r.audioBlob,fileName:"starmus-recording.webm",mimeType:r.audioBlob.type||"audio/webm",size:r.audioBlob.size,metadata:{recordedAt:new Date(r.startTime).toISOString()}},e)}return null},cleanup:function(e){if(!n(e)||!(e in t))return;const r=t[e];r.stream&&r.stream.getTracks().forEach(e=>e.stop()),a("starmus_recorder_cleanup",e),delete t[e]}}}(window);