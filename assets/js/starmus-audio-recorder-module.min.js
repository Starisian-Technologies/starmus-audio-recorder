function createButtonStateEnforcer(e,t,a,o=console.log){if(!e)return null;const getLiveButton=()=>document.getElementById(e.id),shouldBeEnabled=()=>["granted","prompt"].includes(t?.[a]),r=getLiveButton();r&&(r.disabled=!shouldBeEnabled());const i=new MutationObserver((e=>{const t=getLiveButton();if(t)for(const a of e)if("attributes"===a.type&&"disabled"===a.attributeName){const e=shouldBeEnabled();t.disabled&&e?(o(`StateEnforcer (Mutation): Button for ID ${t.id} was disabled externally — re-enabling.`),t.disabled=!1):t.disabled||e||(o(`StateEnforcer (Mutation): Button for ID ${t.id} enabled while permission is denied — disabling.`),t.disabled=!0);}}));return i.observe(e,{attributes:!0,attributeFilter:["disabled"]}),o(`StateEnforcer: MutationObserver is now active on button ID "${e.id}".`),[1500,3e3,5e3].forEach((e=>{setTimeout((()=>{const e=getLiveButton();e&&(e.disabled=!shouldBeEnabled());}),e);})),i;}const StarmusAudioRecorder=function(){"use strict";let e,t,a={recordButtonId:"recordButton",pauseButtonId:"pauseButton",deleteButtonId:"deleteButton",timerDisplayId:"sparxstar_timer",audioPlayerId:"sparxstar_audioPlayer",statusDisplayId:"sparxstar_status",levelBarId:"sparxstar_audioLevelBar",audioLevelTextId:"sparxstar_audioLevelText",levelBarWrapId:"sparxstar_audioLevelWrap",uuidFieldId:"audio_uuid",fileInputId:"audio_file",downloadLinkId:"downloadLink",submitButtonId:"submit_button",recorderContainerSelector:"[data-enabled-recorder]",maxRecordingTime:12e5,buildHash:"7093e4fb8fac4967d14f42cdd86673cb0359bbf1",logPrefix:"STARMUS:"},o={},r={micPermission:"prompt"},i={},n=null,s=[],d=!1,u=!1,l=0;function _log(...e){}function _updateStatus(e){if(o.statusDisplay&&"string"==typeof e){const t=String(e).replace(/[<>"'&\r\n]/g,(e=>({"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","&":"&amp;","\r":" ","\n":" "}[e]||e)));(o.statusDisplay.querySelector(".sparxstar_status__text")||o.statusDisplay).textContent=t,o.statusDisplay.classList.remove("sparxstar_visually_hidden");}}function _attachAudioToForm(e,t){const a=function(){try{if(crypto&&crypto.randomUUID)return crypto.randomUUID();if(crypto&&crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const U=t=>e[t].toString(16).padStart(2,"0");return`${U(0)}${U(1)}${U(2)}${U(3)}-${U(4)}${U(5)}-${U(6)}${U(7)}-${U(8)}${U(9)}-${U(10)}${U(11)}${U(12)}${U(13)}${U(14)}${U(15)}`;}}catch(t){}let e=(new Date).getTime();return e+=performance&&performance.now?performance.now():0,"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const a=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?a:3&a|8).toString(16);}));}(),r=`audio_${a}.${t}`;if(o.uuidField&&(o.uuidField.value=a),!o.fileInput)return;try{const t=new DataTransfer,a=new File([e],r,{type:e.type});t.items.add(a),o.fileInput.files=t.files,o.fileInput.files.length>0&&o.submitButton&&(o.submitButton.disabled=!1);}catch(n){_updateStatus("Error attaching file. Your browser may not be supported.");}const i=new CustomEvent("starmusAudioReady",{detail:{audioId:a,fileName:r,durationMs:l}});o.container.dispatchEvent(i);}function _handleRecordingReady(){o.recordButton&&(o.recordButton.disabled=!["granted","prompt"].includes(r.micPermission),o.recordButton.textContent="Record",o.recordButton.setAttribute("aria-pressed","false")),o.pauseButton&&(o.pauseButton.disabled=!0),o.deleteButton&&o.deleteButton.classList.add("sparxstar_visually_hidden"),o.submitButton&&(o.submitButton.disabled=!0),o.audioPlayer&&(o.audioPlayer.src&&o.audioPlayer.src.startsWith("blob:")&&URL.revokeObjectURL(o.audioPlayer.src),o.audioPlayer.src="",o.audioPlayer.classList.add("sparxstar_visually_hidden")),_updateStatus("Ready to record.");}function _handleDataAvailable(e){e.data.size>0&&s.push(e.data);}function _handleStop(){if(!e||0===s.length)return _updateStatus("Recording stopped, no audio captured."),void c.cleanup();const a=e.mimeType,i=a.includes("opus")||a.includes("webm")?"webm":"m4a",n=new Blob(s,{type:a}),l=URL.createObjectURL(n);o.audioPlayer&&(o.audioPlayer.src&&o.audioPlayer.src.startsWith("blob:")&&URL.revokeObjectURL(o.audioPlayer.src),o.audioPlayer.src=l,o.audioPlayer.setAttribute("controls",""),o.audioPlayer.classList.remove("sparxstar_visually_hidden")),_attachAudioToForm(n,i),d=!1,u=!1,o.recordButton&&(o.recordButton.disabled=!["granted","prompt"].includes(r.micPermission)),o.pauseButton&&(o.pauseButton.disabled=!0),o.deleteButton&&(o.deleteButton.disabled=!1,o.deleteButton.classList.remove("sparxstar_visually_hidden")),t&&(t.getTracks().forEach((e=>e.stop())),t=null);}const c={init:async function(e={}){return Object.assign(a,e),!!a.formInstanceId&&(!!function(){const id=e=>`${e}_${a.formInstanceId}`,e={container:`starmus_audioWrapper_${a.formInstanceId}`,recordButton:id(a.recordButtonId),pauseButton:id(a.pauseButtonId),deleteButton:id(a.deleteButtonId),timerDisplay:id(a.timerDisplayId),audioPlayer:id(a.audioPlayerId),statusDisplay:id(a.statusDisplayId),levelBar:id(a.levelBarId),audioLevelText:id(a.audioLevelTextId),levelBarWrap:id(a.levelBarWrapId),uuidField:id(a.uuidFieldId),fileInput:id(a.fileInputId),downloadLink:id(a.downloadLinkId),submitButton:id(a.submitButtonId)};return Object.keys(e).forEach((t=>{o[t]=document.getElementById(e[t]);})),o.container&&o.recordButton&&o.pauseButton&&o.timerDisplay&&o.audioPlayer&&o.statusDisplay;}()&&(this.setupEventListeners(),this.setupPermissionsAndUI()));},setupEventListeners:function(e=!1){if(!o.recordButton)return;i.recordClick=i.recordClick||(()=>{d?this.stop():this.start();}),i.pauseClick=i.pauseClick||(()=>{d&&(u?this.resume():this.pause());}),i.deleteClick=i.deleteClick||(()=>this.cleanup());const t=e?"removeEventListener":"addEventListener";o.recordButton[t]("click",i.recordClick),o.pauseButton[t]("click",i.pauseClick),o.deleteButton[t]("click",i.deleteClick);},setupPermissionsAndUI:async function(){if(!a.formInstanceId||!o.recordButton)return!1;if(_handleRecordingReady(),!navigator.permissions?.query)return r.micPermission="prompt",o.recordButton.disabled=!1,!0;try{const e=await navigator.permissions.query({name:"microphone"});return r.micPermission=e.state,r.micPermission,e.onchange=()=>{r.micPermission=e.state,r.micPermission,o.recordButton.disabled=!["granted","prompt"].includes(r.micPermission);},n&&n.disconnect(),n=createButtonStateEnforcer(o.recordButton,r,"micPermission",_log),!0;}catch(e){return r.micPermission="prompt",o.recordButton.disabled=!1,!1;}},start:async function(){if(navigator.mediaDevices?.getUserMedia&&window.MediaRecorder)try{const a=await navigator.mediaDevices.getUserMedia({audio:!0});t=a,s=[];const r=["audio/webm;codecs=opus","audio/mp4"].find((e=>MediaRecorder.isTypeSupported(e)))||"audio/webm";e=new MediaRecorder(a,{mimeType:r}),e.ondataavailable=_handleDataAvailable,e.onstop=_handleStop,e.start(),d=!0,u=!1,o.recordButton&&(o.recordButton.textContent="Stop"),o.pauseButton&&(o.pauseButton.disabled=!1);}catch(a){a.name,_updateStatus("NotAllowedError"===a.name?"Microphone permission denied.":"No microphone found.");}else _updateStatus("Audio recording is not supported on your browser.");},stop:function(){d&&"inactive"!==e?.state&&e.stop();},pause:function(){d&&!u&&"recording"===e?.state&&(e.pause(),u=!0,o.pauseButton&&(o.pauseButton.textContent="Resume"),_updateStatus("Recording paused."));},resume:function(){d&&u&&"paused"===e?.state&&(e.resume(),u=!1,o.pauseButton&&(o.pauseButton.textContent="Pause"),_updateStatus("Recording resumed."));},cleanup:function(){d&&this.stop(),t&&t.getTracks().forEach((e=>e.stop())),s=[],d=!1,u=!1,_handleRecordingReady(),o.uuidField&&(o.uuidField.value=""),o.fileInput&&(o.fileInput.value="");},destroy:function(){this.cleanup(),this.setupEventListeners(!0),o.audioPlayer&&o.audioPlayer.src&&o.audioPlayer.src.startsWith("blob:")&&URL.revokeObjectURL(o.audioPlayer.src),n?.disconnect(),n=null,o={};},getAudioId:function(){return o.uuidField?o.uuidField.value:null;}};return window.addEventListener("offline",(()=>{d&&(_updateStatus("Network offline. Recording paused."),c.pause());})),window.addEventListener("online",(()=>{s.length>0&&_updateStatus("Network restored. You can now submit your recording.");})),c;}();
//# sourceMappingURL=starmus-audio-recorder-module.min.js.map