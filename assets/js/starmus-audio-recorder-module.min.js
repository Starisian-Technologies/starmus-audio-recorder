// ==== starmus-audio-recorder-module.js ====
// Build Hash (SHA-1):   4ffbc2dda8e6fb2fa03312a3d32c0f2cf8cd3922
// Build Hash (SHA-256): cc4f1471292435a1d78c9a9e4269ba1d0839a80c4166d7b2687935aa694d5f99
// Build Time: 2025-09-10T21:14:04.881Z

!function(e){buildHash: '4ffbc2dda8e6fb2fa03312a3d32c0f2cf8cd3922',
  "use strict";var t=!(!e.MediaRecorder||!e.navigator.mediaDevices),r=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg","audio/mpeg","audio/wav"];function n(t){try{return!(!e.MediaRecorder||"function"!=typeof MediaRecorder.isTypeSupported||!MediaRecorder.isTypeSupported(t))}catch(e){return!1}}function a(e){return!("string"!=typeof e||0===e.length||e.length>100)&&/^[a-zA-Z0-9_-]+$/.test(e)}function s(e){return"string"!=typeof e?String(e):e.replace(/[\u0020-\u007E]/g,function(e){return/[<>"'&]/.test(e)?" ":e}).substring(0,200)}function i(e,t,r){if("undefined"!=typeof console&&console[e]){var n=s(t),a=r?s(String(r)):"";console[e]("[Starmus Recorder]",n,a)}}function o(e){if(!(e instanceof Blob))return!1;for(var t=!1,n=0;n<r.length;n++)if(e.type.startsWith(r[n].split(";")[0])){t=!0;break}return t&&e.size>=100&&e.size<=52428800}e.StarmusAudioRecorder={instances:{},init:function(r){var n=this;return new Promise(function(s,o){if(!t){var d=new Error("MediaRecorder API is not supported in this browser.");return i("error",d.message),o(d)}if(!r||!a(r.formInstanceId)){var c=new Error("Invalid or unsafe form instance ID provided.");return i("error",c.message),o(c)}var u=r.formInstanceId;if(n.instances[u])return i("warn","Instance already exists, skipping re-initialization.",u),s(!0);navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){var r=new(e.AudioContext||e.webkitAudioContext),a=r.createMediaStreamSource(t),i=r.createAnalyser(),o=r.createGain();i.fftSize=2048,a.connect(i),i.connect(o),n.instances[u]={stream:t,recorder:null,chunks:[],audioBlob:null,isRecording:!1,isPaused:!1,startTime:0,timerInterval:null,ctx:r,analyser:i,gain:o,isCalibrated:!1,tier:"A"},n.setupUI(u),s({ok:!0,tier:"A"})}).catch(function(e){i("error","Microphone access was denied.",e.message);var t=new Error("Microphone permission is required to record audio."),r=document.getElementById("starmus_recorder_status_"+u);r&&(r.textContent=t.message),o(t)})})},setupUI:function(e){if(a(e)){var t=document.getElementById("starmus_recorder_container_"+e);if(t){t.textContent="";var r=document.createElement("div");r.className="starmus-recorder-status",r.id="starmus_recorder_status_"+e,r.textContent="Ready to record";var n=document.createElement("div");n.className="starmus-recorder-timer",n.id="starmus_timer_"+e,n.textContent="00:00";var s=document.createElement("div");s.className="starmus-recorder-controls";var o=document.createElement("button");o.type="button",o.id="starmus_calibrate_btn_"+e,o.className="starmus-btn starmus-calibrate-btn",o.textContent="Test Microphone";var d=document.createElement("div");d.id="starmus_calibration_status_"+e,d.className="starmus-calibration-status",d.textContent='Click "Test Microphone" to calibrate audio levels';var c=document.createElement("div");c.className="starmus-volume-meter",c.style.cssText="width:100%;height:20px;background:#f0f0f0;border:1px solid #ccc;margin:10px 0;position:relative;display:none";var u=document.createElement("div");u.id="starmus_volume_bar_"+e,u.style.cssText="height:100%;background:linear-gradient(to right,#4CAF50 0%,#FFEB3B 70%,#F44336 100%);width:0%;transition:width 0.1s";var l=document.createElement("div");l.style.cssText="position:absolute;top:2px;left:5px;font-size:12px;color:#333",l.textContent="Volume Level",c.appendChild(u),c.appendChild(l);var m=document.createElement("button");m.type="button",m.id="starmus_record_btn_"+e,m.className="starmus-btn starmus-record-btn",m.textContent="Record",m.disabled=!0;var p=document.createElement("button");p.type="button",p.id="starmus_pause_btn_"+e,p.className="starmus-btn starmus-pause-btn",p.style.display="none",p.textContent="Pause";var g=document.createElement("button");g.type="button",g.id="starmus_stop_btn_"+e,g.className="starmus-btn starmus-stop-btn",g.disabled=!0,g.textContent="Stop";var f=document.createElement("button");f.type="button",f.id="starmus_play_btn_"+e,f.className="starmus-btn starmus-play-btn",f.disabled=!0,f.textContent="Play";var b=document.createElement("audio");b.id="starmus_audio_preview_"+e,b.controls=!0,b.style.display="none",b.style.width="100%",b.style.marginTop="10px",s.appendChild(o),s.appendChild(m),s.appendChild(p),s.appendChild(g),s.appendChild(f),t.appendChild(r),t.appendChild(d),t.appendChild(c),t.appendChild(n),t.appendChild(s),t.appendChild(b),this.bindEvents(e)}else i("error","UI container not found for instanceId:",e)}},bindEvents:function(e){if(a(e)){var t=this,r=document.getElementById("starmus_calibrate_btn_"+e),n=document.getElementById("starmus_record_btn_"+e),s=document.getElementById("starmus_stop_btn_"+e),i=document.getElementById("starmus_play_btn_"+e),o=document.getElementById("starmus_pause_btn_"+e);r&&r.addEventListener("click",function(){t.calibrate(e)}),n&&n.addEventListener("click",function(){t.startRecording(e)}),s&&s.addEventListener("click",function(){t.stopRecording(e)}),i&&i.addEventListener("click",function(){t.playRecording(e)}),o&&o.addEventListener("click",function(){t.togglePause(e)})}},calibrate:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e];if("A"===t.tier){var r=document.getElementById("starmus_calibration_status_"+e),n=document.querySelector("#"+e+" .starmus-volume-meter"),s=document.getElementById("starmus_volume_bar_"+e),o=t.analyser,d=new Float32Array(o.fftSize);n&&(n.style.display="block");var c=[],u=performance.now();!function a(){var l=performance.now()-u;!function(e){var t=Math.ceil((1e4-e)/1e3);e<3e3?r&&(r.textContent="Be quiet for background noise ("+t+"s)"):e<7e3?r&&(r.textContent="Now speak normally ("+t+"s)"):r&&(r.textContent="Be quiet again ("+t+"s)")}(l),o.getFloatTimeDomainData(d);for(var m=0,p=0;p<d.length;p++)m+=d[p]*d[p];var g=Math.sqrt(m/d.length);c.push(g);var f=Math.min(100,2e3*g);s&&(s.style.width=f+"%"),l<1e4?requestAnimationFrame(a):function(){var a=c.reduce(function(e,t){return e+t},0)/Math.max(1,c.length),s=.05,o=Math.max(.5,Math.min(8,s/Math.max(1e-6,a)));t.gain.gain.setTargetAtTime(o,t.ctx.currentTime,.01),t.isCalibrated=!0,r&&(r.textContent="Mic calibrated (gainÃ—"+o.toFixed(2)+"). Ready to record.");n&&(n.style.display="none");var d=document.getElementById("starmus_record_btn_"+e);d&&(d.disabled=!1);i("log","Calibration complete: avgRMS="+a.toFixed(4)+" gain="+o.toFixed(2))}()}()}}},startRecording:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e];if(!t.isRecording&&t.isCalibrated){var r=document.querySelector("#"+e+" .starmus-volume-meter");r&&(r.style.display="block"),this.startVolumeMonitoring(e);try{var s=function(){for(var e=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/ogg"],t=0;t<e.length;t++)if(n(e[t]))return e[t];return""}(),d=s?{mimeType:s}:{};try{t.recorder=new MediaRecorder(t.stream,d)}catch(e){t.recorder=new MediaRecorder(t.stream)}t.chunks=[],t.audioBlob=null,t.isRecording=!0,t.isPaused=!1,t.startTime=Date.now(),t.recorder.ondataavailable=function(e){e.data&&e.data.size>0&&t.chunks.push(e.data)};var c=this;t.recorder.onerror=function(r){i("error","MediaRecorder error",r.error?r.error.message:"Unknown error"),t.isRecording=!1,c.updateUI(e,"error")};c=this;t.recorder.onstop=function(){try{var r=t.recorder&&t.recorder.mimeType||s||"audio/webm",n=new Blob(t.chunks,{type:r});if(o(n)){t.audioBlob=n;var a=document.getElementById("starmus_audio_preview_"+e);if(a){if(a.src&&0===a.src.indexOf("blob:"))try{URL.revokeObjectURL(a.src)}catch(e){i("warn","Failed to revoke blob URL",e.message)}a.src=URL.createObjectURL(n)}}else i("error","Generated audio blob invalid/too large"),c.updateUI(e,"error")}catch(t){i("error","Error processing recorded audio",t.message),c.updateUI(e,"error")}},t.recorder.start(1e3),this.startTimer(e),this.updateUI(e,"recording")}catch(r){i("error","Failed to start recording.",r.message),t.isRecording=!1,this.updateUI(e,"error")}}}},stopRecording:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e];if(t.isRecording&&t.recorder)try{t.recorder&&"inactive"!==t.recorder.state&&t.recorder.stop(),t.isRecording=!1,t.isPaused=!1,this.stopTimer(e),this.stopVolumeMonitoring(e);var r=document.querySelector("#"+e+" .starmus-volume-meter");r&&(r.style.display="none"),this.updateUI(e,"stopped")}catch(e){i("error","Failed to stop recording.",e.message)}}},startVolumeMonitoring:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e],r=document.getElementById("starmus_volume_bar_"+e);if(r&&t.analyser){var n=new Float32Array(t.analyser.fftSize);!function e(){if(t.isRecording){t.analyser.getFloatTimeDomainData(n);for(var a=0,s=0;s<n.length;s++)a+=n[s]*n[s];var i=Math.sqrt(a/n.length),o=Math.min(100,2e3*i);r.style.width=o+"%",requestAnimationFrame(e)}}()}}},stopVolumeMonitoring:function(e){return!0},togglePause:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e];t.isRecording&&(t.isPaused?this.resumeRecording(e):this.pauseRecording(e))}},pauseRecording:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e];t.recorder&&"recording"===t.recorder.state&&(t.recorder.pause(),t.isPaused=!0,this.stopTimer(e),this.updateUI(e,"paused"))}},resumeRecording:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e];t.recorder&&"paused"===t.recorder.state&&(t.recorder.resume(),t.isPaused=!1,this.startTimer(e),this.updateUI(e,"recording"))}},playRecording:function(e){if(a(e)){var t=document.getElementById("starmus_audio_preview_"+e);t&&t.src&&(t.ended&&(t.currentTime=0),t.play().catch(function(t){i("error","Audio playback failed.",t.message);var r=document.getElementById("starmus_recorder_status_"+e);r&&(r.textContent=s("Playback failed. Please try again."))}))}},startTimer:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e],r=this;this.stopTimer(e),t.timerInterval=setInterval(function(){r.updateTimer(e)},1e3)}},stopTimer:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e];t.timerInterval&&(clearInterval(t.timerInterval),t.timerInterval=null)}},updateTimer:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e],r=document.getElementById("starmus_timer_"+e);if(r){var n=Math.max(0,Date.now()-t.startTime),s=Math.floor(n/6e4),i=Math.floor(n%6e4/1e3);r.textContent=String(s).padStart(2,"0")+":"+String(i).padStart(2,"0")}}},updateUI:function(e,t){if(a(e)){var r={recordBtn:document.getElementById("starmus_record_btn_"+e),stopBtn:document.getElementById("starmus_stop_btn_"+e),playBtn:document.getElementById("starmus_play_btn_"+e),pauseBtn:document.getElementById("starmus_pause_btn_"+e),status:document.getElementById("starmus_recorder_status_"+e),timer:document.getElementById("starmus_timer_"+e),audioPreview:document.getElementById("starmus_audio_preview_"+e)},n=!0;for(var s in r)if(!r[s]){n=!1;break}if(n){var i={recording:"Recording...",paused:"Paused",stopped:"Recording complete. Ready for submission.",error:"An error occurred. Please refresh and try again.",ready:"Ready to record"};switch(r.recordBtn.disabled=!1,r.stopBtn.disabled=!0,r.playBtn.disabled=!0,r.pauseBtn.style.display="none",r.audioPreview.style.display="none",t){case"recording":r.recordBtn.disabled=!0,r.stopBtn.disabled=!1,r.pauseBtn.disabled=!1,r.pauseBtn.textContent="Pause",r.pauseBtn.style.display="inline-block";break;case"paused":r.recordBtn.disabled=!0,r.stopBtn.disabled=!1,r.pauseBtn.disabled=!1,r.pauseBtn.textContent="Resume",r.pauseBtn.style.display="inline-block";break;case"stopped":r.playBtn.disabled=!1,r.audioPreview.style.display="block";break;case"error":r.recordBtn.disabled=!0;break;default:r.timer.textContent="00:00"}r.status.textContent=i[t]||i.ready}}},getSubmissionData:function(e){if(!a(e)||!this.instances[e])return null;var t=this.instances[e];if(t.audioBlob&&o(t.audioBlob)){var r=t.audioBlob.type||"",n="webm";r.indexOf("ogg")>=0?n="ogg":r.indexOf("mpeg")>=0?n="mp3":r.indexOf("wav")>=0?n="wav":r.indexOf("webm")>=0&&(n="webm");var s=t.startTime?new Date(t.startTime).toISOString():null,i=t.startTime?Math.max(0,Date.now()-t.startTime):null;return{blob:t.audioBlob,fileName:"starmus-recording."+n,mimeType:r||"audio/webm",size:t.audioBlob.size,metadata:{startedAt:s,durationMs:i}}}return null},cleanup:function(e){if(a(e)&&this.instances[e]){var t=this.instances[e];if(t.stream&&t.stream.getTracks().forEach(function(e){e.stop()}),t.recorder)try{"inactive"!==t.recorder.state&&t.recorder.stop()}catch(e){i("warn","Error stopping recorder during cleanup",e.message)}var r=document.getElementById("starmus_audio_preview_"+e);r&&r.src&&r.src.startsWith("blob:")&&URL.revokeObjectURL(r.src),this.stopTimer(e),this.stopVolumeMonitoring(e),this.instances[e]=null,delete this.instances[e]}}}}(window);