document.addEventListener("DOMContentLoaded",(()=>{"use strict";new URLSearchParams(window.location.search).has("starmus_debug");const e="starmus_audio_queue",t="queue",a=524288;let n="indexedDB"in window;const r=n?new Promise((a=>{const r=indexedDB.open(e,1);r.onupgradeneeded=e=>{const a=e.target.result;a.objectStoreNames.contains(t)||a.createObjectStore(t,{keyPath:"id"})},r.onsuccess=()=>a(r.result),r.onerror=e=>{n=!1,a(null)}})):Promise.resolve(null);function o(e){const t=e.split(","),a=t[0].match(/:(.*?);/)[1],n=atob(t[1]),r=new Uint8Array(n.length);for(let o=0;o<n.length;o++)r[o]=n.charCodeAt(o);return new Blob([r],{type:a})}async function s(a){if(n){const e=await r;return new Promise(((n,r)=>{const o=e.transaction(t,"readwrite");o.objectStore(t).put(a),o.oncomplete=n,o.onerror=()=>r(o.error)}))}const o=JSON.parse(localStorage.getItem(e)||"[]"),s=await async function(e){return new Promise(((t,a)=>{const n=new FileReader;n.onloadend=()=>t(n.result),n.onerror=a,n.readAsDataURL(e)}))}(a.audio),i=o.findIndex((e=>e.id===a.id)),d={...a,audioData:s,audio:void 0};i>-1?o[i]=d:o.push(d),localStorage.setItem(e,JSON.stringify(o))}async function i(){if(n){const e=await r;return new Promise(((a,n)=>{const r=e.transaction(t,"readonly").objectStore(t).getAll();r.onsuccess=()=>a(r.result||[]),r.onerror=()=>n(r.error)}))}return JSON.parse(localStorage.getItem(e)||"[]").map((e=>({...e,audio:o(e.audioData)})))}async function d(o){let i=o.uploadedBytes||0;for(;i<o.audio.size;){if(!navigator.onLine)return await s({...o,uploadedBytes:i}),!1;const e=o.audio.slice(i,i+a),t=new FormData;for(const a in o.meta)t.append(a,o.meta[a]);t.append(o.audioField,e,o.meta.fileName||"audio.webm"),t.append("chunk_offset",i),t.append("total_size",o.audio.size);try{const a=await fetch(o.ajaxUrl,{method:"POST",body:t}),n=await a.json();if(!a.ok||!n.success)throw new Error(n?.message||"Server returned an error");i+=e.size}catch(d){try{await s({...o,uploadedBytes:i})}catch(u){n=!1,await s({...o,uploadedBytes:i})}return!1}}return await async function(a){if(n){const e=await r;return new Promise(((n,r)=>{const o=e.transaction(t,"readwrite");o.objectStore(t).delete(a),o.oncomplete=n,o.onerror=()=>r(o.error)}))}const o=JSON.parse(localStorage.getItem(e)||"[]");localStorage.setItem(e,JSON.stringify(o.filter((e=>e.id!==a))))}(o.id),!0}let u=!1;async function c(){if(u||!navigator.onLine)return;u=!0;const e=document.getElementById("starmus_queue_retry");e&&(e.disabled=!0);const t=await i();for(const a of t){if(!await d(a))break}u=!1,e&&(e.disabled=!1),m()}const l=document.createElement("div");async function m(){const e=await i(),t=document.getElementById("starmus_queue_count");e.length>0?(t.textContent=`${e.length} recording${e.length>1?"s are":" is"} pending upload.`,l.classList.remove("sparxstar_visually_hidden")):l.classList.add("sparxstar_visually_hidden")}l.id="starmus_queue_banner",l.className="sparxstar_status sparxstar_visually_hidden",l.setAttribute("aria-live","polite"),l.innerHTML='<span class="sparxstar_status__text" id="starmus_queue_count"></span> <button type="button" id="starmus_queue_retry" class="button">Retry Uploads</button>',document.body.appendChild(l),document.getElementById("starmus_queue_retry").addEventListener("click",c),window.addEventListener("online",c),m(),navigator.onLine&&c();const p=document.querySelectorAll("[data-enabled-recorder]");0!==p.length&&p.forEach((e=>{const t=e.id.substring(21),a=document.getElementById(t),n=(e,a="info",n=!0,r=!1)=>{const o=document.getElementById(`sparxstar_status_${t}`);if(o){const t=o.querySelector(".sparxstar_status__text");t&&(t.textContent=e),o.className=`sparxstar_status ${a}`,n&&o.classList.remove("sparxstar_visually_hidden")}if(r){const e=document.getElementById(`submit_button_${t}`);e&&(e.disabled=!1)}};a&&("function"==typeof StarmusAudioRecorder?.init?StarmusAudioRecorder.init({formInstanceId:t}).then((e=>{e||n("Recorder failed to load.","error")})):n("Critical error: Recorder unavailable.","error"),a.addEventListener("submit",(async e=>{e.preventDefault();const r=document.getElementById(`audio_uuid_${t}`),o=document.getElementById(`audio_file_${t}`),s=document.getElementById(`audio_consent_${t}`),i=document.getElementById(`submit_button_${t}`),u=document.getElementById(`sparxstar_loader_overlay_${t}`);if(!r?.value||!o?.files?.length)return n("Error: No audio file has been recorded to submit.","error");if(s&&!s.checked)return n("Error: You must provide consent to submit.","error");i&&(i.disabled=!0),u&&u.classList.remove("sparxstar_visually_hidden");const c=new FormData(a),l={};c.forEach(((e,t)=>{e instanceof File||(l[t]=e)})),starmusFormData?.action&&(l.action=starmusFormData.action),starmusFormData?.nonce&&(l.nonce=starmusFormData.nonce);const p={id:r.value,meta:l,audio:o.files[0],ajaxUrl:starmusFormData?.ajax_url||"/wp-admin/admin-ajax.php",audioField:o.name,uploadedBytes:0},y=await d(p);u&&u.classList.add("sparxstar_visually_hidden"),y?(n("Successfully submitted!","success"),a.reset(),StarmusAudioRecorder?.cleanup(),"function"==typeof window.onStarmusSubmitSuccess&&window.onStarmusSubmitSuccess(t,{message:"Success"})):(n("Connection issue. Your recording has been saved and will be uploaded automatically when you are back online.","info",!0,!0),a.reset(),StarmusAudioRecorder?.cleanup(),m())})))}))}));
//# sourceMappingURL=starmus-audio-editor.min.js.map