document.addEventListener("DOMContentLoaded",(()=>{const e=new URLSearchParams(window.location.search).has("starmus_debug"),t="starmus_audio_queue",a="queue",n=524288;let o="indexedDB"in window;const r=o?new Promise((e=>{const n=indexedDB.open(t,1);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(a)||t.createObjectStore(a,{keyPath:"id"});},n.onsuccess=()=>e(n.result),n.onerror=t=>{o=!1,e(null);};})):Promise.resolve(null);function base64ToBlob(e){const t=e.split(","),a=t[0].match(/:(.*?);/)[1],n=atob(t[1]),o=new Uint8Array(n.length);for(let r=0;r<n.length;r++)o[r]=n.charCodeAt(r);return new Blob([o],{type:a});}async function enqueue(e){if(o){const t=await r;return new Promise(((n,o)=>{const r=t.transaction(a,"readwrite");r.objectStore(a).put(e),r.oncomplete=n,r.onerror=()=>o(r.error);}));}const n=JSON.parse(localStorage.getItem(t)||"[]"),s=await async function(e){return new Promise(((t,a)=>{const n=new FileReader;n.onloadend=()=>t(n.result),n.onerror=a,n.readAsDataURL(e);}));}(e.audio),u=n.findIndex((t=>t.id===e.id)),i={...e,audioData:s,audio:void 0};u>-1?n[u]=i:n.push(i),localStorage.setItem(t,JSON.stringify(n));}async function getAllItems(){if(o){const e=await r;return new Promise(((t,n)=>{const o=e.transaction(a,"readonly").objectStore(a).getAll();o.onsuccess=()=>t(o.result||[]),o.onerror=()=>n(o.error);}));}return JSON.parse(localStorage.getItem(t)||"[]").map((e=>({...e,audio:base64ToBlob(e.audioData)})));}async function uploadSubmission(e){let s=e.uploadedBytes||0;for(;s<e.audio.size;){if(!navigator.onLine)return await enqueue({...e,uploadedBytes:s}),!1;const t=e.audio.slice(s,s+n),a=new FormData;for(const n in e.meta)a.append(n,e.meta[n]);a.append(e.audioField,t,e.meta.fileName||"audio.webm"),a.append("chunk_offset",s),a.append("total_size",e.audio.size);try{const n=await fetch(e.ajaxUrl,{method:"POST",body:a}),o=await n.json();if(!n.ok||!o.success)throw new Error(o.message||"Server returned an error");s+=t.size;}catch(u){return await enqueue({...e,uploadedBytes:s}),!1;}}return await async function(e){if(o){const t=await r;return new Promise(((n,o)=>{const r=t.transaction(a,"readwrite");r.objectStore(a).delete(e),r.oncomplete=n,r.onerror=()=>o(r.error);}));}const n=JSON.parse(localStorage.getItem(t)||"[]");localStorage.setItem(t,JSON.stringify(n.filter((t=>t.id!==e))));}(e.id),!0;}let s=!1;async function processQueue(){if(s||!navigator.onLine)return;s=!0;const e=await getAllItems();for(const t of e){if(!await uploadSubmission(t))break;}s=!1,updateQueueUI();}const u=document.createElement("div");async function updateQueueUI(){const e=await getAllItems(),t=document.getElementById("starmus_queue_count");e.length>0?(t.textContent=`${e.length} recording${e.length>1?"s are":" is"} pending upload.`,u.classList.remove("sparxstar_visually_hidden")):u.classList.add("sparxstar_visually_hidden");}u.id="starmus_queue_banner",u.className="sparxstar_status sparxstar_visually_hidden",u.innerHTML='<span class="sparxstar_status__text" id="starmus_queue_count"></span> <button type="button" id="starmus_queue_retry" class="button">Retry Uploads</button>',document.body.appendChild(u),document.getElementById("starmus_queue_retry").addEventListener("click",processQueue),window.addEventListener("online",processQueue),updateQueueUI(),navigator.onLine&&processQueue();const i=document.querySelectorAll("[data-enabled-recorder]");0!==i.length&&i.forEach((t=>{const a=t.id.substring(21),n=document.getElementById(a),_updateStatus=(e,t="info",n=!0,o=!1)=>{const r=document.getElementById(`sparxstar_status_${a}`),s=r?.querySelector(".sparxstar_status__text");if(s&&(s.textContent=e,s.className="sparxstar_status__text "+t),r&&n&&r.classList.remove("sparxstar_visually_hidden"),o){const e=document.getElementById(`submit_button_${a}`);e&&(e.disabled=!1);}};n&&("function"==typeof StarmusAudioRecorder?.init?StarmusAudioRecorder.init({formInstanceId:a,recorderContainerSelector:`#starmus_audioWrapper_${a}`}).then((e=>{e||_updateStatus("Recorder failed to load.","error");})):_updateStatus("Critical error: Recorder unavailable.","error"),n.addEventListener("submit",(async t=>{t.preventDefault();const o=document.getElementById(`audio_uuid_${a}`),r=document.getElementById(`audio_file_${a}`),s=document.getElementById(`audio_consent_${a}`),u=document.getElementById(`submit_button_${a}`),i=document.getElementById(`sparxstar_loader_overlay_${a}`);if(!o?.value||!r?.files?.length)return void _updateStatus("Error: No audio file has been recorded to submit.","error");if(s&&!s.checked)return void _updateStatus("Error: You must provide consent to submit.","error");u&&(u.disabled=!0),i&&i.classList.remove("sparxstar_visually_hidden");const d=new FormData(n),c={};d.forEach(((e,t)=>{e instanceof File||(c[t]=e);}));const l={id:o.value,meta:c,audio:r.files[0],ajaxUrl:starmusFormData?.ajax_url||"/wp-admin/admin-ajax.php",audioField:r.name,uploadedBytes:0};if(e){const e=document.getElementById("debug_output")||document.createElement("pre");e.id="debug_output",e.textContent=JSON.stringify(l.meta,null,2),document.body.appendChild(e);}const m=await uploadSubmission(l);i&&i.classList.add("sparxstar_visually_hidden"),m?(_updateStatus("Successfully submitted!","success"),n.reset(),StarmusAudioRecorder?.cleanup(),"function"==typeof window.onStarmusSubmitSuccess&&window.onStarmusSubmitSuccess(a,{message:"Success"})):(_updateStatus("Connection issue. Your recording has been saved and will be uploaded automatically when you are back online.","info",!0,!0),n.reset(),StarmusAudioRecorder?.cleanup(),updateQueueUI());})));}));}));
//# sourceMappingURL=starmus-audio-recorder-submissions.min.js.map