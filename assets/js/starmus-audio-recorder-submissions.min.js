document.addEventListener("DOMContentLoaded",(()=>{"use strict";const e={LOG_PREFIX:"STARMUS_FORM:",DB_NAME:"starmus_audio_queue",STORE_NAME:"queue",CHUNK_SIZE:524288,DEBUG_MODE:new URLSearchParams(window.location.search).has("starmus_debug")};e.DEBUG_MODE&&console.log(e.LOG_PREFIX,"DOM fully loaded. Initializing audio form submissions in debug mode.");let t="indexedDB"in window;const o=t?new Promise((o=>{const a=indexedDB.open(e.DB_NAME,1);a.onupgradeneeded=t=>{const o=t.target.result;o.objectStoreNames.contains(e.STORE_NAME)||o.createObjectStore(e.STORE_NAME,{keyPath:"id"})},a.onsuccess=()=>o(a.result),a.onerror=a=>{console.error(e.LOG_PREFIX,"IndexedDB failed to open. Falling back to localStorage.",a.target.error),t=!1,o(null)}})):Promise.resolve(null);function a(e){const t=e.split(","),o=t[0].match(/:(.*?);/)[1],a=atob(t[1]),r=new Uint8Array(a.length);for(let n=0;n<a.length;n++)r[n]=a.charCodeAt(n);return new Blob([r],{type:o})}async function r(a){if(t)try{const t=(await o).transaction(e.STORE_NAME,"readwrite");return t.objectStore(e.STORE_NAME).put(a),new Promise(((e,o)=>{t.oncomplete=e,t.onerror=()=>o(t.error)}))}catch(d){console.error(e.LOG_PREFIX,"IndexedDB put failed. Retrying with localStorage.",d),t=!1}const r=JSON.parse(localStorage.getItem(e.DB_NAME)||"[]"),n=await async function(e){return new Promise(((t,o)=>{const a=new FileReader;a.onloadend=()=>t(a.result),a.onerror=o,a.readAsDataURL(e)}))}(a.audio),s={...a,audioData:n,audio:void 0},i=r.findIndex((e=>e.id===a.id));i>-1?r[i]=s:r.push(s),localStorage.setItem(e.DB_NAME,JSON.stringify(r))}async function n(){if(t)try{const t=await o;return new Promise(((o,a)=>{const r=t.transaction(e.STORE_NAME,"readonly").objectStore(e.STORE_NAME).getAll();r.onsuccess=()=>o(r.result||[]),r.onerror=()=>a(r.error)}))}catch(r){console.error(e.LOG_PREFIX,"IndexedDB getAll failed. Retrying with localStorage.",r),t=!1}return JSON.parse(localStorage.getItem(e.DB_NAME)||"[]").map((e=>({...e,audio:a(e.audioData)})))}async function s(a){if(t)try{const t=(await o).transaction(e.STORE_NAME,"readwrite");return t.objectStore(e.STORE_NAME).delete(a),new Promise(((e,o)=>{t.oncomplete=e,t.onerror=()=>o(t.error)}))}catch(n){console.error(e.LOG_PREFIX,"IndexedDB delete failed. Retrying with localStorage.",n),t=!1}const r=JSON.parse(localStorage.getItem(e.DB_NAME)||"[]");localStorage.setItem(e.DB_NAME,JSON.stringify(r.filter((e=>e.id!==a))))}async function i(t,o){let a=t.uploadedBytes||0;for(;a<t.audio.size;){if(!navigator.onLine)return console.warn(e.LOG_PREFIX,"Upload paused: connection lost."),await r({...t,uploadedBytes:a}),{success:!1,queued:!0};const o=t.audio.slice(a,a+e.CHUNK_SIZE),i=new FormData;Object.keys(t.wordpressData).forEach((e=>i.append(e,t.wordpressData[e]))),Object.keys(t.meta).forEach((e=>i.append(e,t.meta[e]))),i.append(t.audioField,o,t.meta.fileName||"audio.webm"),i.append("chunk_offset",a),i.append("total_size",t.audio.size);try{const r=await fetch(t.ajaxUrl,{method:"POST",body:i});if(!r.ok){const e=await r.json().catch((()=>null));throw new Error(e?.data?.message||`Server responded with status ${r.status}`)}const n=await r.json();if(!n.success)throw new Error(n?.data?.message||"Server returned a failure response.");if(a+=o.size,e.DEBUG_MODE&&console.log(e.LOG_PREFIX,`Chunk uploaded. Progress: ${a}/${t.audio.size}`),a>=t.audio.size)return await s(t.id),{success:!0,queued:!1,redirectUrl:n.data?.redirect_url}}catch(n){return console.error(e.LOG_PREFIX,"Chunk upload failed. Queuing submission for later.",n),await r({...t,uploadedBytes:a}),{success:!1,queued:!0}}}return await s(t.id),{success:!0,queued:!1}}let d=!1;async function u(){if(d||!navigator.onLine)return;d=!0;const t=document.getElementById("starmus_queue_retry");t&&(t.disabled=!0),console.log(e.LOG_PREFIX,"Processing offline queue...");const o=await n();if(o.length>0)for(const a of o){if(!(await i(a)).success){console.warn(e.LOG_PREFIX,"Queue processing paused due to an upload failure.");break}}d=!1,t&&(t.disabled=!1),await l()}const c=document.createElement("div");async function l(){const e=await n(),t=document.getElementById("starmus_queue_count");e.length>0?(t.textContent=`${e.length} recording${e.length>1?"s are":" is"} pending upload.`,c.classList.remove("starmus_visually_hidden")):c.classList.add("starmus_visually_hidden")}c.id="starmus_queue_banner",c.className="starmus_status starmus_visually_hidden",c.setAttribute("aria-live","polite"),c.innerHTML='<span class="starmus_status__text" id="starmus_queue_count"></span> <button type="button" id="starmus_queue_retry" class="sparxstar_button">Retry Uploads</button>',document.body.appendChild(c),document.getElementById("starmus_queue_retry")?.addEventListener("click",u),window.addEventListener("online",u),l(),navigator.onLine&&setTimeout(u,2e3);const m=document.querySelectorAll("[data-enabled-recorder]");0!==m.length&&m.forEach((t=>{const o=t.id.substring(21),a=document.getElementById(o);if(!a)return console.error(e.LOG_PREFIX,`Form element not found for instance ID: ${o}.`);const r=a.querySelector(`#starmus_step_1_${o}`),n=a.querySelector(`#starmus_step_2_${o}`),s=a.querySelector(`#starmus_continue_btn_${o}`);if(!r||!n||!s)return console.error(e.LOG_PREFIX,"Multi-step form elements are missing. Defaulting to show recorder."),r&&(r.style.display="none"),n&&(n.style.display="block"),void u(o);function d(){r.style.display="none",n.style.display="block";const e=a.querySelector(`#sparxstar_audioRecorderHeading_${o}`);e&&(e.setAttribute("tabindex","-1"),e.focus()),u(o)}function u(t){"function"==typeof StarmusAudioRecorder?.init?StarmusAudioRecorder.init({formInstanceId:t}).then((o=>{o&&e.DEBUG_MODE&&console.log(e.LOG_PREFIX,`Recorder module initialized for ${t}.`)})):console.error(e.LOG_PREFIX,"StarmusAudioRecorder module is not available.")}s.addEventListener("click",(function(t){t.preventDefault();const r=a.querySelector(`#starmus_step_1_error_${o}`),n=[{id:`audio_title_${o}`,name:"Title",type:"text"},{id:`language_${o}`,name:"Language",type:"select"},{id:`recording_type_${o}`,name:"Recording Type",type:"select"},{id:`audio_consent_${o}`,name:"Consent",type:"checkbox"}];r.style.display="none",r.textContent="",n.forEach((e=>document.getElementById(e.id)?.removeAttribute("aria-describedby")));for(const e of n){const t=document.getElementById(e.id);if(!t)continue;let a=!0;if("text"===e.type&&(a=""!==t.value.trim()),"select"===e.type&&(a=""!==t.value),"checkbox"===e.type&&(a=t.checked),!a)return r.textContent=`Please complete the "${e.name}" field.`,r.style.display="block",r.id=`starmus_step_1_error_${o}`,t.focus(),void t.setAttribute("aria-describedby",r.id)}"geolocation"in navigator?navigator.geolocation.getCurrentPosition((t=>{a.querySelector(`#gps_latitude_${o}`).value=t.coords.latitude,a.querySelector(`#gps_longitude_${o}`).value=t.coords.longitude,e.DEBUG_MODE&&console.log(e.LOG_PREFIX,"GPS Location captured."),d()}),(t=>{console.warn(e.LOG_PREFIX,`Geolocation error (${t.code}): ${t.message}`),d()})):(console.log(e.LOG_PREFIX,"Geolocation is not available."),d())})),a.addEventListener("submit",(async t=>{t.preventDefault();const r=document.getElementById(`audio_uuid_${o}`),n=document.getElementById(`audio_file_${o}`),s=document.getElementById(`submit_button_${o}`),d=document.getElementById(`sparxstar_loader_overlay_${o}`);if(!r?.value||!n?.files?.length)return void alert("Error: No audio file has been recorded to submit.");s&&(s.disabled=!0),d&&d.classList.remove("sparxstar_visually_hidden");const u=new FormData(a),c={};u.forEach(((e,t)=>{e instanceof File||(c[t]=e)}));const m={action:starmusFormData?.action,nonce:starmusFormData?.nonce},_={id:r.value,meta:c,wordpressData:m,audio:n.files[0],ajaxUrl:starmusFormData?.ajax_url||"/wp-admin/admin-ajax.php",audioField:n.name,uploadedBytes:0};e.DEBUG_MODE&&console.log(e.LOG_PREFIX,"--- Submission Data ---",_);const p=await i(_);d&&d.classList.add("sparxstar_visually_hidden"),p.success?p.redirectUrl?window.location.href=p.redirectUrl:(alert("Successfully submitted!"),a.reset(),"function"==typeof StarmusAudioRecorder?.cleanup&&StarmusAudioRecorder.cleanup(o)):p.queued?(alert("Connection issue. Your recording has been saved and will be uploaded automatically when you are back online."),a.reset(),"function"==typeof StarmusAudioRecorder?.cleanup&&StarmusAudioRecorder.cleanup(o),await l()):(alert("An unknown error occurred during upload."),s&&(s.disabled=!1))}))}))}));
//# sourceMappingURL=starmus-audio-recorder-submissions.min.js.map
