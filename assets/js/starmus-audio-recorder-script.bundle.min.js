!function(e){var t=!(!e.starmusConfig||!e.starmusConfig.debug);function r(){if(t)try{(console.log||function(){}).apply(console,arguments)}catch(e){}}var n="function"==typeof Set,a={},i={};void 0===e.StarmusHooks&&(e.StarmusHooks={}),e.StarmusHooks.subscribe=function(e,t){var r,i;return a[e]||(a[e]=n?new Set:[]),r=a[e],i=t,n?r.add(i):-1===r.indexOf(i)&&r.push(i),function(){a[e]&&function(e,t){if(n)e.delete(t);else{var r=e.indexOf(t);-1!==r&&e.splice(r,1)}}(a[e],t)}},e.StarmusHooks.dispatch=function(e,t,o){t=t||{};var s=e+"::"+((o=o||{}).instanceId||"");if(i[s])r("Prevented recursive dispatch:",e);else{i[s]=!0;try{var c=a[e];if(!c)return;!function(e,t){if(n)e.forEach(t);else for(var r=e.slice(),a=0;a<r.length;a++)t(r[a])}(c,function(r){try{r(t,o)}catch(t){console.error("Error executing handler for command "+e+":",t)}})}finally{delete i[s]}}},e.StarmusHooks.debugLog=r}("undefined"!=typeof window?window:globalThis);const e="undefined"!=typeof window?window:globalThis,t=e.StarmusHooks&&e.StarmusHooks.debugLog||function(){};var r,n,a={exports:{}};function i(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}r||(r=1,n=a,function(e){var t={instanceId:null,env:{},tier:null,status:"uninitialized",error:null,source:{kind:null,blob:null,file:null,fileName:"",transcript:"",interimTranscript:""},calibration:{phase:null,message:"",volumePercent:0,complete:!1,gain:1},recorder:{duration:0,amplitude:0,isPlaying:!1,isPaused:!1},submission:{progress:0,isQueued:!1}};function r(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}function a(e,t){var n=r(e);for(var a in t)t.hasOwnProperty(a)&&(n[a]=t[a]);return n}function i(e){var n=a(t,e||{}),i=[];return{getState:function(){return n},dispatch:function(e){n=function(e,n){if(!n||!n.type)return e;switch(!e.instanceId&&n.payload&&n.payload.instanceId&&(e=a(e,{instanceId:n.payload.instanceId})),n.type){case"starmus/tier-ready":return e.tier?e:a(e,{tier:n.payload&&n.payload.tier?n.payload.tier:e.tier});case"starmus/init":return a(e,a(n.payload||{},{status:"idle",error:null}));case"starmus/ui/step-continue":return a(e,{status:"ready_to_record",error:null});case"starmus/calibration-start":return a(e,{status:"calibrating"});case"starmus/calibration-update":return a(e,{calibration:a(e.calibration,{message:n.message,volumePercent:n.volumePercent})});case"starmus/calibration-complete":return a(e,{status:"ready",calibration:a(e.calibration,a(n.calibration||{},{complete:!0}))});case"starmus/mic-start":return a(e,{status:"recording",error:null,recorder:a(e.recorder,{duration:0,amplitude:0,isPaused:!1})});case"starmus/mic-pause":return a(e,{status:"paused",recorder:a(e.recorder,{isPaused:!0})});case"starmus/mic-resume":return a(e,{status:"recording",recorder:a(e.recorder,{isPaused:!1})});case"starmus/mic-stop":return a(e,{status:"processing"});case"starmus/recorder-tick":return a(e,{recorder:a(e.recorder,{duration:n.duration,amplitude:n.amplitude})});case"starmus/recording-available":return a(e,{status:"ready_to_submit",source:a(e.source,{kind:"blob",blob:n.payload.blob,fileName:n.payload.fileName})});case"starmus/recorder-playback-state":return a(e,{recorder:a(e.recorder,{isPlaying:n.isPlaying})});case"starmus/transcript-update":return a(e,{source:a(e.source,{transcript:n.transcript})});case"starmus/transcript-interim":return a(e,{source:a(e.source,{interimTranscript:n.interim})});case"starmus/env-update":return a(e,{env:a(e.env,n.payload||{}),tier:n.tier||e.tier});case"starmus/file-attached":return a(e,{status:"ready_to_submit",source:{kind:"file",file:n.file,fileName:n.file.name}});case"starmus/submit-start":return a(e,{status:"submitting",error:null});case"starmus/submit-progress":return a(e,{submission:a(e.submission,{progress:n.progress})});case"starmus/submit-complete":return a(e,{status:"complete",submission:{progress:1,isQueued:!1}});case"starmus/submit-queued":return a(e,{status:"complete",submission:{progress:0,isQueued:!0}});case"starmus/error":return a(e,{error:n.error||n.payload});case"starmus/reset":return a(r(t),{instanceId:e.instanceId,env:e.env,tier:e.tier,status:"idle",source:{kind:null,blob:null,file:null,fileName:"",transcript:"",interimTranscript:""}});default:return e}}(n,e);for(var o=0;o<i.length;o++)try{i[o](n)}catch(e){console.error(e)}},subscribe:function(e){return-1===i.indexOf(e)&&i.push(e),function(){var t=i.indexOf(e);-1!==t&&i.splice(t,1)}}}}n.exports?n.exports={createStore:i}:(e.StarmusStore=e.StarmusStore||{},e.StarmusStore.createStore=i)}("undefined"!=typeof window?window:globalThis),"undefined"!=typeof window&&(window.initStateStore=createStore));const s=window.StarmusHooks.debugLog,c={chunkSize:1048576,retryDelays:[0,3e3,5e3,1e4,2e4,6e4],maxChunkRetries:3},d=()=>window.starmusConfig||{};function u(e){return(e=(e="string"==typeof e?e:String(e)).replace(/[\r\n\t]/g," ")).length>500?e.slice(0,497)+"...":e}async function l(e,t,r,n,a,l){var m,p,f,y;const g=d(),v=(null===(m=window.tus)||void 0===m?void 0:m.Upload)&&(null===(p=g.endpoints)||void 0===p?void 0:p.tusUpload),h=null===(f=g.endpoints)||void 0===f?void 0:f.chunkedUpload,b=null===(y=g.endpoints)||void 0===y?void 0:y.directUpload;if(v)try{const r=await function(e,t,r,n,a){var l,m;if(null===(l=window.tus)||void 0===l||!l.Upload)throw new Error("TUS library not present");const p=window.starmusTus||{},f=p.endpoint||(null===(m=d().endpoints)||void 0===m?void 0:m.tusUpload);if(!f)throw new Error("TUS endpoint missing");const y=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach(function(t){i(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({filename:u(t),filetype:e.type||"audio/webm"},Object.entries({}).reduce((e,t)=>{let[r,n]=t;return e[r]=u(n),e},{}));return new Promise((t,r)=>{let n;const i={endpoint:f,chunkSize:p.chunkSize||c.chunkSize,retryDelays:p.retryDelays||c.retryDelays,metadata:y,fingerprint:e=>["starmus",a,e.size,e.lastModified||""].join("-"),onProgress(e,t){},onError:r,async onSuccess(){var r,a;s("[TUS] Success:",n.url);const o=(null===(r=window.tus)||void 0===r||null===(r=r.defaultOptions)||void 0===r?void 0:r.removeFingerprint)||(null===(a=window.tus)||void 0===a||null===(a=a.Upload)||void 0===a||null===(a=a.prototype)||void 0===a||null===(a=a.options)||void 0===a?void 0:a.removeFingerprint);if(p.removeFingerprintOnSuccess&&o)try{const t=await window.tus.defaultOptions.fingerprint(e,i);await o(t)}catch(e){}t(n.url)}};n=new window.tus.Upload(e,i),n.findPreviousUploads().then(e=>e.length&&n.resumeFromPreviousUpload(e[0])).finally(()=>n.start())})}(e,t,0,0,a);return{method:"tus",url:r}}catch(e){s("[Priority] TUS failed:",e.message)}if(h)try{const r=await function(e,t,r,n,a){var i,o;const s=d(),u=null===(i=s.endpoints)||void 0===i?void 0:i.chunkedUpload,l=s.nonce||"";if(!u)throw new Error("Chunked REST endpoint missing");if(!l)throw new Error("Nonce missing");const m={},p=s.chunkSize||c.chunkSize,f=Math.ceil(e.size/p),y=window.localStorage||window.sessionStorage,g=(v=a,h=t,b=e.size,"starmus_chunked_".concat(v,"_").concat(h,"_").concat(b));var v,h,b;let w=y.getItem(g)||null;const S=null!==(o=s.maxChunkRetries)&&void 0!==o?o:c.maxChunkRetries;return new Promise(async(r,n)=>{try{for(let t=0;t<f;t++){let r=0,n=!1;const i=t*p,o=Math.min(i+p,e.size),s=e.slice(i,o);for(;!n&&r<S;){r++;try{await a(t,s,i),n=!0}catch(e){if(r===S)throw e;await new Promise(e=>setTimeout(e,300*r*r))}}}const t=new FormData;t.append("upload_id",w),t.append("finalize","1");const n=await fetch(u,{method:"POST",headers:{"X-WP-Nonce":l},body:t});if(!n.ok)throw new Error("Finalization failed: ".concat(n.status));const i=await n.json();y.removeItem(g),r(i)}catch(e){n(e)}function a(e,r,n){return new Promise((n,a)=>{const i=new FormData;i.append("audio_chunk",r,"".concat(t,".part").concat(e)),i.append("chunk_index",e),i.append("total_chunks",f),w?i.append("upload_id",w):i.append("create_upload_id","1"),Object.entries(m).forEach(e=>{let[t,r]=e;return i.append(t,r)});const o=new XMLHttpRequest;o.open("POST",u,!0),o.setRequestHeader("X-WP-Nonce",l),o.upload.onprogress=e=>!1,o.onload=()=>{if(o.status<200||o.status>=300)return a(new Error("Chunk ".concat(e," failed: ").concat(o.status)));try{const e=JSON.parse(o.responseText);!w&&e.upload_id&&(w=e.upload_id,y.setItem(g,w)),n(e)}catch(e){a(new Error("Invalid JSON response"))}},o.onerror=()=>a(new Error("Network error")),o.send(i)})}})}(e,t,0,0,a);return{method:"chunked_rest",result:r}}catch(e){s("[Priority] Chunked REST failed:",e.message)}if(b){const r=await function(e,t){var r;const n=d(),a=null===(r=n.endpoints)||void 0===r?void 0:r.directUpload,i=n.nonce||"";if(!a)throw new Error("Direct upload endpoint missing");const o={};return new Promise((r,n)=>{const s=new FormData;Object.entries(o).forEach(e=>{let[t,r]=e;return s.append(t,r)}),s.append("audio_file",e,t);const c=new XMLHttpRequest;c.open("POST",a,!0),c.setRequestHeader("X-WP-Nonce",i),c.upload.onprogress=e=>!1,c.onload=()=>{if(c.status<200||c.status>=300)return n(new Error("Upload failed: ".concat(c.status)));try{r(JSON.parse(c.responseText))}catch(e){n(new Error("Invalid JSON response"))}},c.onerror=()=>n(new Error("Network error")),c.send(s)})}(e,t);return{method:"fallback_post",result:r}}throw new Error("All upload methods failed or missing endpoints")}const m={dbName:"StarmusSubmissions",storeName:"pendingSubmissions",dbVersion:1,maxRetries:10,retryDelays:[0,5e3,1e4,3e4,6e4,12e4,3e5,6e5,12e5,18e5],maxBlobSize:41943040};const p=new class{constructor(){this.db=null,this.isProcessing=!1}async init(){if(window.indexedDB)return new Promise(e=>{const r=indexedDB.open(m.dbName,m.dbVersion);r.onerror=r=>{t("[Offline] DB open failed",r),e()},r.onblocked=()=>{t("[Offline] DB open blocked — close other tabs")},r.onsuccess=r=>{this.db=r.target.result,this.db.onversionchange=()=>{this.db.close(),t("[Offline] DB version change — closed connection")},t("[Offline] IndexedDB ready"),e()},r.onupgradeneeded=e=>{const r=e.target.result;if(!r.objectStoreNames.contains(m.storeName)){const e=r.createObjectStore(m.storeName,{keyPath:"id"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("retryCount","retryCount",{unique:!1}),t("[Offline] Created object store",m.storeName)}}});console.error("[Offline] IndexedDB not supported — offline queue disabled.")}async add(e,r,n,a,i){if(!this.db)throw new Error("IndexedDB not initialized");const o="starmus-offline-".concat(Date.now(),"-").concat(Math.random().toString(36).slice(2,10)),s=r.size>m.maxBlobSize?null:"function"==typeof structuredClone?structuredClone(r):new Blob([r],{type:r.type});if(!s)throw new Error("Blob too large for offline storage (".concat((r.size/1024/1024).toFixed(2),"MB)"));const c={id:o,instanceId:e,fileName:n,timestamp:Date.now(),audioBlob:s,formFields:a||{},metadata:i||{},retryCount:0,lastAttempt:null,error:null};return new Promise((e,r)=>{const n=this.db.transaction([m.storeName],"readwrite");n.objectStore(m.storeName).add(c),n.oncomplete=()=>{t("[Offline] Queued submission",o),e(o)},n.onerror=e=>{const t=e.target.error;"QuotaExceededError"===(null==t?void 0:t.name)?r(new Error("IndexedDB quota exceeded — cannot queue submission offline.")):r(t)}})}async getAll(){return this.db?new Promise((e,t)=>{const r=this.db.transaction([m.storeName],"readonly").objectStore(m.storeName).getAll();r.onsuccess=()=>e(r.result||[]),r.onerror=()=>t(r.error)}):[]}async remove(e){if(this.db)return new Promise((r,n)=>{const a=this.db.transaction([m.storeName],"readwrite");a.objectStore(m.storeName).delete(e),a.oncomplete=()=>{t("[Offline] Removed from queue",e),r()},a.onerror=e=>n(e.target.error)})}async _updateRetry(e,t,r){if(this.db)return new Promise((n,a)=>{const i=this.db.transaction([m.storeName],"readwrite"),o=i.objectStore(m.storeName),s=o.get(e);s.onsuccess=()=>{const e=s.result;e&&(e.retryCount=t,e.lastAttempt=Date.now(),e.error=r||null,o.put(e))},i.oncomplete=n,i.onerror=()=>a(i.error)})}async processQueue(){if(!this.isProcessing&&navigator.onLine){this.isProcessing=!0,t("[Offline] Processing queue...");try{const e=await this.getAll();t("[Offline] Pending submissions:",e.length);for(const r of e){const{id:e,audioBlob:n,fileName:a,formFields:i,metadata:o,retryCount:s,instanceId:c}=r;if(s>=m.maxRetries)t("[Offline] Max retries reached for",e);else try{t("[Offline] Attempt ".concat(s+1," for"),e),await l({blob:n,fileName:a,formFields:i,metadata:o,instanceId:c,background:!0}),await this.remove(e),t("[Offline] Upload succeeded:",e)}catch(r){const n=(null==r?void 0:r.message)||"Unknown upload error";if(t("[Offline] Upload failed:",e,n),n.includes("400")||n.includes("Invalid JSON")||n.includes("QuotaExceeded")){t("[Offline] Non-retryable error — leaving item in queue");continue}await this._updateRetry(e,s+1,n);const a=m.retryDelays[Math.min(s,m.retryDelays.length-1)];t("[Offline] Retrying ".concat(e," after ").concat(a,"ms...")),await new Promise(e=>setTimeout(e,a))}}}catch(e){console.error("[Offline] Fatal queue processing error",e)}finally{this.isProcessing=!1}}}setupNetworkListeners(){window.addEventListener("online",()=>{t("[Offline] Online — resuming queue"),this.processQueue()}),window.addEventListener("offline",()=>{t("[Offline] Offline — pausing queue")}),setInterval(()=>{navigator.onLine&&this.processQueue().catch(e=>t("[Offline] Retry loop error",e))},6e4)}};async function f(){return p.db||(await p.init(),p.setupNetworkListeners()),p}"undefined"!=typeof window&&(window.initOffline=function(){return f()});let y=!1;function g(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function v(e,t){const{status:r,error:n,source:a={},submission:i={},calibration:o={},recorder:s={},instanceId:c}=e;if("C"===e.tier||!0===e.fallbackActive)return["recordBtn","pauseBtn","resumeBtn","stopBtn","recorderContainer"].forEach(e=>{t[e]&&(t[e].style.display="none")}),void(t.fallbackContainer&&(t.fallbackContainer.style.display="block"));if(t.step1&&t.step2){if("uninitialized"===r)return t.step1.style.display="block",void(t.step2.style.display="none");const e="idle"!==r&&"uninitialized"!==r;t.step1.style.display=e?"none":"block",t.step2.style.display=e?"block":"none"}if(t.timer||t.timerElapsed){const e=function(e){if(!Number.isFinite(e))return"00m 00s";const t=Math.floor(e/60),r=Math.floor(e%60);return"".concat(t.toString().padStart(2,"0"),"m ").concat(r.toString().padStart(2,"0"),"s")}(s.duration||0);t.timerElapsed?t.timerElapsed.textContent=e:t.timer&&(t.timer.textContent=e),t.timer&&("recording"===r?t.timer.classList.add("starmus-timer--recording"):t.timer.classList.remove("starmus-timer--recording"))}if(t.durationProgress){const e=s.duration||0,n="recording"===r||"paused"===r||"calibrating"===r;if(t.durationProgress.parentElement&&(t.durationProgress.parentElement.style.display=n?"block":"none"),n){const n=Math.min(100,e/1200*100);t.durationProgress.style.setProperty("--starmus-recording-progress","".concat(n,"%")),t.durationProgress.setAttribute("aria-valuenow",Math.floor(e)),e>=1020?t.durationProgress.setAttribute("data-level","danger"):e>=900?t.durationProgress.setAttribute("data-level","warning"):t.durationProgress.setAttribute("data-level","safe"),e>=1200&&"recording"===r&&window.CommandBus&&window.CommandBus.dispatch("stop-mic",{},{instanceId:c})}}if(t.volumeMeter){const e="recording"===r||"paused"===r||"calibrating"===r;if(t.volumeMeter.parentElement&&(t.volumeMeter.parentElement.style.display=e?"block":"none"),e){const e=Math.max(0,Math.min(100,"calibrating"===r?o.volumePercent||0:s.amplitude||0));t.volumeMeter.style.setProperty("--starmus-audio-level","".concat(e,"%"));const n=e/100;n<.6?t.volumeMeter.setAttribute("data-level","safe"):n<.85?t.volumeMeter.setAttribute("data-level","hot"):t.volumeMeter.setAttribute("data-level","clip"),"recording"===r&&function(e,t){if(e>=.85&&!y){y=!0;const e=t.messageBox||document.querySelector("[data-starmus-message-box]");e&&(e.textContent="⚠️ Your microphone is too loud. Move back 6–12 inches or speak softer for a cleaner recording.",e.style.display="block",e.setAttribute("role","alert"),e.setAttribute("aria-live","assertive"),setTimeout(()=>{e.style.display="none",e.removeAttribute("role"),e.removeAttribute("aria-live")},6e3))}}(n,t)}else t.volumeMeter.style.setProperty("--starmus-audio-level","0%"),t.volumeMeter.removeAttribute("data-level")}const d="recording"===r,u="paused"===r,l="ready"===r,m="calibrating"===r,p="ready_to_submit"===r,f=o&&!0===o.complete,v=d||u||m;if(t.recordBtn&&(t.recordBtn.style.display=l&&f&&!v&&!p?"inline-flex":"none"),t.pauseBtn&&(t.pauseBtn.style.display=d?"inline-flex":"none"),t.resumeBtn&&(t.resumeBtn.style.display=u?"inline-flex":"none"),t.stopBtn&&(t.stopBtn.style.display=v?"inline-flex":"none",t.stopBtn.disabled=m,t.stopBtn.innerHTML=m?'<span class="dashicons dashicons-update"></span> Calibrating...':'<span class="dashicons dashicons-media-default"></span> Stop'),t.submitBtn&&(t.submitBtn.disabled="ready_to_submit"!==r,t.submitBtn.textContent="submitting"===r?"Uploading…":"Submit Recording"),t.transcriptBox){var h,b;const e=(null===(h=a.transcript)||void 0===h?void 0:h.length)>0,r=(null===(b=a.interimTranscript)||void 0===b?void 0:b.length)>0;e||r?(t.transcriptBox.style.display="block",t.transcriptBox.innerHTML=(e?'<span class="starmus-transcript--final">'.concat(g(a.transcript),"</span>"):"")+(r?' <span class="starmus-transcript--interim">'.concat(g(a.interimTranscript),"</span>"):"")):t.transcriptBox.style.display="none"}if(t.statusEl){const e=t.statusEl;let a="",o="starmus-status";if(n)a=n.message||"An error occurred.",o+=" starmus-status--error";else switch(r){case"ready":a="Mic calibrated. Click Start Recording.",o+=" starmus-status--success";break;case"recording":a="Recording...",o+=" starmus-status--recording";break;case"paused":a="Paused — Resume or Stop.";break;case"submitting":a="Uploading ".concat(Math.round(100*i.progress),"%");break;case"complete":a="Upload successful!",o+=" starmus-status--success";break;default:a=""}e.className=o,e.textContent=a,e.style.display=a?"block":"none"}}"undefined"!=typeof window&&(window.initUI=function(e,t){var r,n,a,i,o,s,c;const d=e.getState().instanceId,u=window.CommandBus||window.StarmusHooks;function l(e){if(!u)return console.warn("[StarmusUI] No CommandBus detected.");u.dispatch(e,{},{instanceId:d})}null===(r=t.recordBtn)||void 0===r||r.addEventListener("click",()=>l("start-recording")),null===(n=t.pauseBtn)||void 0===n||n.addEventListener("click",()=>l("pause-mic")),null===(a=t.resumeBtn)||void 0===a||a.addEventListener("click",()=>l("resume-mic")),null===(i=t.stopBtn)||void 0===i||i.addEventListener("click",()=>l("stop-mic")),null===(o=t.submitBtn)||void 0===o||o.addEventListener("click",()=>l("submit")),null===(s=t.resetBtn)||void 0===s||s.addEventListener("click",()=>l("reset")),null===(c=t.setupMicBtn)||void 0===c||c.addEventListener("click",()=>l("setup-mic")),t.fileInput&&t.fileInput.addEventListener("change",e=>{var t;const r=null===(t=e.target.files)||void 0===t?void 0:t[0];r&&u.dispatch("file-attached",{file:r},{instanceId:d})});const m=e.subscribe(e=>v(e,t));return v(e.getState(),t),m});var h=window.StarmusHooks||{},b=h.subscribe||function(){},w=h.debugLog||function(){};"undefined"!=typeof window&&(window.initCore=function(e,t,r){function n(n){const a=e.getState(),i=a.source||{},o=a.calibration||{},s=a.env||r||{};if("submitting"!==a.status){var c=i.blob||i.file,d=i.fileName||i.file&&i.file.name||"recording.webm";if(c){var u={transcript:(i.transcript||"").trim()||null,calibration:o.complete?JSON.parse(JSON.stringify(o)):null,env:s};e.dispatch({type:"starmus/submit-start"}),Promise.resolve().then(function(){if(!navigator.onLine)throw new Error("OFFLINE_FAST_PATH");return w("[Upload] Starting Priority Upload Pipeline..."),l({blob:c,fileName:d,formFields:n,metadata:u,instanceId:t,onProgress:m})}).then(function(t){w("[Upload] Upload Succeeded via",t.method,t),e.dispatch({type:"starmus/submit-complete",payload:t})}).catch(function(r){var a=r&&r.message&&-1!==r.message.indexOf("not configured");"OFFLINE_FAST_PATH"!==r.message&&a?e.dispatch({type:"starmus/error",payload:{message:r.message||"Upload failed."}}):(w("[Upload] Upload failed/offline. Attempting offline queue..."),async function(e,t,r,n,a){return(await f()).add(e,t,r,n,a)}(t,c,d,n,u).then(function(t){e.dispatch({type:"starmus/submit-queued",submissionId:t})}).catch(function(t){console.error("[Upload] Offline save failed:",t),e.dispatch({type:"starmus/error",payload:{message:"Upload failed and could not be saved offline."}})}))})}else e.dispatch({type:"starmus/error",payload:{message:"Please record or attach audio before submitting."}})}function m(t,r){e.dispatch({type:"starmus/submit-progress",progress:t/r})}}return b("submit",function(e,r){r&&r.instanceId===t&&n(e.formFields||{})}),b("reset",function(r,n){n&&n.instanceId===t&&e.dispatch({type:"starmus/reset"})}),{handleSubmit:n}});var S;S||(S=1,function(e){var t=e.StarmusHooks,r=t&&t.debugLog||function(){},n={},a=null;function i(e,r,n){try{t&&"function"==typeof t.dispatch&&t.dispatch("starmus_event",{instanceId:e,event:r,severity:n.severity||"info",message:n.message||"",data:n.data||{}})}catch(e){console.warn("[Starmus] Telemetry emit failed:",e)}}function o(){var t=e.AudioContext||e.webkitAudioContext;if(!t)throw new Error("AudioContext not supported");if((!a||"closed"===a.state)&&(a=new t({latencyHint:"interactive"}),r("[Recorder] Created AudioContext, state:",a.state),"function"!=typeof a.createMediaStreamSource))throw new Error("AudioContext lacks createMediaStreamSource");return a}function s(e){var t=o(),n=t.createMediaStreamSource(e);try{var a=function(e){var t=e.createMediaStreamDestination||e.createMediaStreamAudioDestination;if("function"!=typeof t)throw new Error("MediaStreamDestination not supported");var r=t.call(e);if(!r||!r.stream)throw new Error("Destination stream invalid");return r}(t),i=t.createBiquadFilter();i.type="highpass",i.frequency.value=85;var s=t.createDynamicsCompressor();s.threshold.value=-20,s.knee.value=40,s.ratio.value=12,s.attack.value=0,s.release.value=.25;var c=t.createAnalyser();return c.fftSize=2048,n.connect(i),i.connect(s),s.connect(c),c.connect(a),{audioContext:t,destinationStream:a.stream,analyser:c,nodes:[n,i,s,c,a],fallbackActive:!1}}catch(a){r("[Recorder] Audio graph failed — fallback to raw stream:",a.message);var d=t.createAnalyser();return d.fftSize=2048,n.connect(d),{audioContext:t,destinationStream:e,analyser:d,nodes:[n,d],fallbackActive:!0}}}e.initStarmusRecorder=function(a,c){var d=a.getState&&a.getState().tier||"A";r("[Recorder]["+c+"] Tier:",d),t.subscribe("setup-mic",function(e,t){if(t&&t.instanceId===c){if(!navigator.mediaDevices||"function"!=typeof navigator.mediaDevices.getUserMedia){var r="Microphone not supported.";return i(c,"E_RECORDER_UNSUPPORTED",{severity:"error",message:r}),void a.dispatch({type:"starmus/error",payload:{message:r,retryable:!1}})}navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){return i(c,"E_MIC_ACCESS",{severity:"info",message:"Mic access granted"}),a.dispatch({type:"starmus/calibration-start"}),(t=e,r=function(e,t){a.dispatch({type:"starmus/calibration-update",message:e,volumePercent:t})},new Promise(function(e){var n;try{n=o()}catch(t){return void e({gain:1,snr:1,noiseFloor:0,speechLevel:0,timestamp:(new Date).toISOString()})}var a=n.createAnalyser();a.fftSize=2048;var i=n.createMediaStreamSource(t);i.connect(a);var s=new Float32Array(a.fftSize),c=[],d=Date.now();!function t(){if("running"===n.state){a.getFloatTimeDomainData(s);for(var o=0,u=0;u<s.length;u++)o+=s[u]*s[u];var l=Math.sqrt(o/s.length);if(isFinite(l)){if(c.push(l),r){var m=Math.min(100,2e3*l);r("Calibrating…",m,!1)}if(Date.now()-d<15e3)requestAnimationFrame(t);else{var p=Math.max(1,Math.floor(c.length/3)),f=c.slice(0,p),y=c.slice(p,2*p),g=function(e){for(var t=0,r=0;r<e.length;r++)t+=e[r];return t/e.length},v=g(f),h=g(y),b=h/Math.max(v,1e-6),w=b<3?6:Math.max(1,Math.min(4,.1/Math.max(h,1e-6))),S={gain:parseFloat(w.toFixed(3)),snr:parseFloat(b.toFixed(3)),noiseFloor:parseFloat(v.toFixed(6)),speechLevel:parseFloat(h.toFixed(6)),timestamp:(new Date).toISOString()};try{i.disconnect()}catch(e){}try{a.disconnect()}catch(e){}r&&r("Mic calibrated",null,!0),e(S)}}else requestAnimationFrame(t)}else requestAnimationFrame(t)}()})).then(function(t){try{e.getTracks().forEach(function(e){e.stop()})}catch(e){}a.dispatch({type:"starmus/calibration-complete",calibration:t})});var t,r}).catch(function(e){var t=e&&"NotAllowedError"===e.name?"Microphone permission denied.":"Failed to access microphone.";i(c,"E_MIC_ACCESS",{severity:"error",message:t,data:{error:e.message}}),a.dispatch({type:"starmus/error",payload:{message:t,retryable:!0}})})}}),t.subscribe("start-recording",function(t,o){if(o&&o.instanceId===c){var d=a.getState();"calibrating"!==d.status?d.calibration&&!0===d.calibration.complete?navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){var o,d=s(t),u=d.destinationStream,l=d.analyser;"suspended"===d.audioContext.state&&d.audioContext.resume().catch(function(){}),(o=u,new Promise(function(e){var t=o.getAudioTracks&&o.getAudioTracks()||[];if(t.length){var r=t[0];if("live"!==r.readyState){var n=0,a=setInterval(function(){("live"===r.readyState||n>100)&&(clearInterval(a),e()),n+=1},50);setTimeout(function(){clearInterval(a),e()},5e3)}else e()}else e()})).then(function(){if((u.getAudioTracks&&u.getAudioTracks()||[]).length){var o,s=[];try{o=new e.MediaRecorder(u,{})}catch(e){r("[Recorder] MediaRecorder creation failed:",e);try{t.getTracks().forEach(function(e){e.stop()})}catch(e){}return void a.dispatch({type:"starmus/error",payload:{message:"Unable to start recording",retryable:!0}})}var m={mediaRecorder:o,rawStream:t,processedStream:u,audioContext:d.audioContext,analyser:l,nodes:d.nodes,fallbackActive:d.fallbackActive};n[c]=m,o.ondataavailable=function(e){e.data&&e.data.size>0&&s.push(e.data)},o.onstop=function(){if(n[c]===m){try{m.audioContext&&m.audioContext.close&&m.audioContext.close()}catch(e){}var e=new Blob(s,{type:o.mimeType||"audio/webm"}),r="starmus-recording-"+Date.now()+".webm";a.dispatch({type:"starmus/recording-available",payload:{blob:e,fileName:r}});try{t.getTracks().forEach(function(e){e.stop()})}catch(e){}try{u.getTracks().forEach(function(e){e.stop()})}catch(e){}m.nodes.forEach(function(e){try{e.disconnect()}catch(e){}}),delete n[c]}},o.onerror=function(e){r("[Recorder] MediaRecorder error:",e),i(c,"E_RECORDER_ERROR",{severity:"error",message:e.message}),a.dispatch({type:"starmus/error",payload:{message:"Recording error",retryable:!0}})};try{if("inactive"!==o.state)throw new Error("MediaRecorder not in inactive state");o.start(3e3),a.dispatch({type:"starmus/mic-start"})}catch(e){r("[Recorder] mediaRecorder.start failed:",e);try{t.getTracks().forEach(function(e){e.stop()})}catch(e){}return delete n[c],a.dispatch({type:"starmus/error",payload:{message:"Cannot start recording",retryable:!0}}),void i(c,"E_RECORDER_START_FAIL",{severity:"error",message:e.message})}var p=new Float32Array(l.fftSize);m.startTime=Date.now(),m.rafId=requestAnimationFrame(function e(){var t=n[c];if(t&&t.mediaRecorder&&("recording"===t.mediaRecorder.state||"paused"===t.mediaRecorder.state)){try{t.analyser.getFloatTimeDomainData(p);for(var r=0,i=0;i<p.length;i++)r+=p[i]*p[i];var o=Math.sqrt(r/p.length),s=Math.min(100,Math.max(0,4e3*o)),d=(Date.now()-m.startTime)/1e3;a.dispatch({type:"starmus/recorder-tick",duration:d,amplitude:s})}catch(e){}m.rafId=requestAnimationFrame(e)}})}else{try{t.getTracks().forEach(function(e){e.stop()})}catch(e){}a.dispatch({type:"starmus/error",payload:{message:"Invalid audio stream",retryable:!0}})}})}).catch(function(e){var t="Could not access microphone.";i(c,"E_MIC_ACCESS",{severity:"error",message:t,data:{error:e.message}}),a.dispatch({type:"starmus/error",payload:{message:t,retryable:!0}})}):a.dispatch({type:"starmus/error",payload:{message:"Microphone not available.",retryable:!1}}):a.dispatch({type:"starmus/error",payload:{message:"Please setup your microphone first.",retryable:!0}}):a.dispatch({type:"starmus/error",payload:{message:"Please wait for calibration to complete.",retryable:!0}})}}),t.subscribe("stop-mic",function(e,t){if(t&&t.instanceId===c){var r=n[c];if(r&&r.mediaRecorder&&"recording"===r.mediaRecorder.state){a.dispatch({type:"starmus/mic-stop"});try{r.mediaRecorder.stop()}catch(e){}}}}),t.subscribe("pause-mic",function(e,t){if(t&&t.instanceId===c){var r=n[c];r&&r.mediaRecorder&&"recording"===r.mediaRecorder.state&&"function"==typeof r.mediaRecorder.pause&&(a.dispatch({type:"starmus/mic-pause"}),r.mediaRecorder.pause())}}),t.subscribe("resume-mic",function(e,t){if(t&&t.instanceId===c){var r=n[c];r&&r.mediaRecorder&&"paused"===r.mediaRecorder.state&&"function"==typeof r.mediaRecorder.resume&&(a.dispatch({type:"starmus/mic-resume"}),r.mediaRecorder.resume())}}),t.subscribe("reset",function(e,t){if(t&&t.instanceId===c){var r=n[c];if(r){try{r.mediaRecorder&&"inactive"!==r.mediaRecorder.state&&r.mediaRecorder.stop()}catch(e){}r.rafId&&cancelAnimationFrame(r.rafId),r.rawStream&&r.rawStream.getTracks().forEach(function(e){e.stop()}),r.processedStream&&r.processedStream.getTracks().forEach(function(e){e.stop()}),r.nodes&&r.nodes.forEach(function(e){try{e.disconnect()}catch(e){}}),delete n[c]}}})}}("undefined"!=typeof window?window:globalThis),"undefined"!=typeof window&&(window.initRecorder=initRecorder,window.initStarmusRecorder=initRecorder));var k,T={exports:{}};k||(k=1,function(e){class t{constructor(e,t,r){this.peaks=e,this.container=document.getElementById(t),this.data=r||[],this.activeTokenIndex=-1,this.isUserScrolling=!1,this.scrollTimeout=null,this.init()}init(){this.container?(this.render(),this.bindEvents()):console.warn("Starmus Transcript: Container not found. Transcript sync disabled.")}render(){const e=document.createElement("div");this.data.forEach((t,r)=>{const n=document.createElement("span");n.textContent=t.text,n.className="starmus-word",n.dataset.index=r,n.dataset.start=t.start,n.dataset.end=t.end,t.confidence&&t.confidence<.8&&(n.dataset.confidence="low",n.title="Low confidence: ".concat(Math.round(100*t.confidence),"%")),e.appendChild(n),r<this.data.length-1&&e.appendChild(document.createTextNode(" "))}),this.container.replaceChildren(...e.childNodes)}bindEvents(){this.container.addEventListener("click",e=>{if(e.target.classList.contains("starmus-word")){const t=parseFloat(e.target.dataset.start);this.peaks.player.seek(t)}}),this.container.addEventListener("scroll",()=>{this.isUserScrolling=!0,clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{this.isUserScrolling=!1},1e3)});const e=this.peaks.player.getMediaElement();e&&e.addEventListener("timeupdate",()=>{this.syncHighlight(this.peaks.player.getCurrentTime())})}findTokenIndex(e){let t=0,r=this.data.length-1;for(;t<=r;){const n=Math.floor((t+r)/2),a=this.data[n];if(e>=a.start&&e<=a.end)return n;e<a.start?r=n-1:t=n+1}return-1}syncHighlight(e){const t=this.data[this.activeTokenIndex];if(t&&e>=t.start&&e<=t.end)return;const r=this.findTokenIndex(e);-1!==r&&r!==this.activeTokenIndex&&this.updateDOM(r)}updateDOM(e){const t=this.container.querySelectorAll(".starmus-word");if(-1!==this.activeTokenIndex){const e=t[this.activeTokenIndex];e&&e.classList.remove("is-active")}this.activeTokenIndex=e;const r=t[e];r&&(r.classList.add("is-active"),this.isUserScrolling||this.scrollToWord(r))}scrollToWord(e){const t=this.container.getBoundingClientRect(),r=e.getBoundingClientRect(),n=r.top<t.top,a=r.bottom>t.bottom;(n||a)&&e.scrollIntoView({behavior:"smooth",block:"center"})}updateData(e){this.data=e||[],this.activeTokenIndex=-1,this.render()}destroy(){this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.container&&(this.container.innerHTML="")}}"undefined"!=typeof window&&(window.StarmusTranscript=t),e.exports&&(e.exports=t),"undefined"!=typeof window&&(window.StarmusTranscriptController=t,window.initTranscriptController=function(e,r,n){return new t(e,r,n)})}(T));var R;R||(R=1,function(e){if(e.Starmus=e.Starmus||{},e.STARMUS_EDITOR_DATA?(e.STARMUS_BOOTSTRAP=e.STARMUS_EDITOR_DATA,e.STARMUS_BOOTSTRAP.pageType="editor"):e.STARMUS_RERECORDER_DATA?(e.STARMUS_BOOTSTRAP=e.STARMUS_RERECORDER_DATA,e.STARMUS_BOOTSTRAP.pageType="rerecorder"):e.STARMUS_RECORDER_DATA&&(e.STARMUS_BOOTSTRAP=e.STARMUS_RECORDER_DATA,e.STARMUS_BOOTSTRAP.pageType="recorder"),e.Starmus_DisableOptionalNodes=!0,e.Starmus_DisableOptionalNodes){var t=(e.AudioContext||e.webkitAudioContext||{}).prototype;t&&(t.createConstantSource&&(t.createConstantSource=function(){throw new Error("ConstantSourceNode disabled")}),t.createIIRFilter&&(t.createIIRFilter=function(){throw new Error("IIRFilterNode disabled")}))}!function(e){try{if("function"==typeof e.Peaks||"object"==typeof e.Peaks)return void(e.Starmus.Peaks=e.Peaks);Object.defineProperty(e,"Peaks",{get:function(){return e.Starmus.Peaks},set:function(t){e.Starmus.Peaks=t},configurable:!0})}catch(e){console.warn("[Starmus] Peaks.js exposure failed:",e)}}(e);var r=e.StarmusHooks,n=e.StarmusStateStore,a=e.StarmusUI_initInstance,i=e.StarmusCore_init,o=e.StarmusOffline_init;if(r&&n&&a&&i&&o){e.StarmusApp=e.StarmusApp||{},e.StarmusApp.isRecordingSupported=p,o().catch(function(e){console.error("[Starmus] Offline queue init failed:",e)});var s={},c=!1,d=null;document.addEventListener("sparxstar:environment-ready",function(e){c=!0,d&&(clearTimeout(d),d=null),g(e)}),d=setTimeout(function(){c||(console.warn("[Starmus] environment-ready not fired; using fallback."),v())},2e3),e.Starmus.instances=s}else console.error("[Starmus Integrator] Critical dependencies missing — cannot initialize.");function u(t,r){try{e.StarmusHooks&&"function"==typeof e.StarmusHooks.doAction&&e.StarmusHooks.doAction("starmus_event",{instanceId:r.instanceId||null,event:t,severity:r.severity||"info",message:r.message||"",data:r.data||{}})}catch(e){console.warn("[Starmus] Global telemetry emit failed:",e)}}function l(){try{return navigator.deviceMemory||null}catch(e){return null}}function m(){try{return navigator.hardwareConcurrency||null}catch(e){return null}}function p(){try{var t=!(!navigator.mediaDevices||"function"!=typeof navigator.mediaDevices.getUserMedia),r="function"==typeof e.MediaRecorder,n=!(!e.AudioContext&&!e.webkitAudioContext);return t&&r&&n}catch(e){return!1}}function f(e,t,r){var n=document.createElement("script");n.src=e,n.async=!0,n.onload=t,n.onerror=r,document.head.appendChild(n)}function y(t,r){var o=r.getAttribute("data-starmus-id");if(o||(o="starmus_"+Date.now()+"_"+Math.random().toString(16).slice(2),r.setAttribute("data-starmus-id",o)),s[o])return o;var c=function(e){var t=e.capabilities||{},r=e.network||{};if(/\bCrOS\b|Chrome OS/i.test(navigator.userAgent))return"A";if(!t.mediaRecorder||!t.webrtc)return"C";var n=l(),a=m();if(n&&n<1)return"C";if(a){if(1===a)return"C";if(2===a)return"B"}return/wv|Crosswalk|Android WebView|Opera Mini/i.test(navigator.userAgent)?"C":"2g"===r.effectiveType||"slow-2g"===r.effectiveType||n&&n<2?"B":"A"}(t);(async function(e){if("C"===e)return"C";if(navigator.storage&&navigator.storage.estimate)try{var t=((await navigator.storage.estimate()).quota||0)/1024/1024;if(t&&t<80)return"C"}catch(e){}if(navigator.permissions&&navigator.permissions.query)try{if("denied"===(await navigator.permissions.query({name:"microphone"})).state)return"C"}catch(e){}return e})(c).then(function(c){console.log("[Starmus] Instance",o,"-> Tier",c),u("TIER_ASSIGN",{instanceId:o,severity:"info",message:"Tier "+c+" assigned",data:{tier:c}});var d=n({instanceId:o,env:t,tier:c});d.getState().tier||d.dispatch({type:"starmus/tier-ready",payload:{tier:c}});var l={step1:r.querySelector(".starmus-step-1"),step2:r.querySelector(".starmus-step-2"),continueBtn:r.querySelector('[data-starmus-action="continue"]'),messageBox:r.querySelector("[data-starmus-message-box]"),setupMicBtn:r.querySelector('[data-starmus-action="setup-mic"]'),recordBtn:r.querySelector('[data-starmus-action="record"]'),pauseBtn:r.querySelector('[data-starmus-action="pause"]'),resumeBtn:r.querySelector('[data-starmus-action="resume"]'),stopBtn:r.querySelector('[data-starmus-action="stop"]'),submitBtn:r.querySelector('[data-starmus-action="submit"]'),resetBtn:r.querySelector('[data-starmus-action="reset"]'),fileInput:r.querySelector('input[type="file"]'),statusEl:r.querySelector("[data-starmus-status]"),progressEl:r.querySelector("[data-starmus-progress]"),progressWrap:r.querySelector(".starmus-progress-wrap"),recorderContainer:r.querySelector("[data-starmus-recorder-container]"),fallbackContainer:r.querySelector("[data-starmus-fallback-container]")};a(d,l),i(d,o,t),"C"!==c&&p()?f("starmus-recorder.js",function(){"function"==typeof e.initStarmusRecorder?e.initStarmusRecorder(d,o):(console.warn("[Starmus] Recorder init missing — falling back"),f("starmus-recorder-legacy.js",function(){"function"==typeof e.initStarmusRecorderLegacy?e.initStarmusRecorderLegacy(d,o):d.dispatch({type:"starmus/error",payload:{message:"Recorder init failed",retryable:!1}})}))},function(){console.warn("[Starmus] Full recorder load failed — falling back to legacy"),f("starmus-recorder-legacy.js",function(){"function"==typeof e.initStarmusRecorderLegacy?e.initStarmusRecorderLegacy(d,o):d.dispatch({type:"starmus/error",payload:{message:"Recorder fallback load failed",retryable:!1}})})}):(l.recorderContainer&&(l.recorderContainer.style.display="none"),l.fallbackContainer&&(l.fallbackContainer.style.display="block"),f("starmus-recorder-legacy.js",function(){"function"==typeof e.initStarmusRecorderLegacy?e.initStarmusRecorderLegacy(d,o):d.dispatch({type:"starmus/error",payload:{message:"Legacy recorder not available",retryable:!1}})},function(){console.error("[Starmus] Failed to load legacy recorder."),d.dispatch({type:"starmus/error",payload:{message:"Legacy recorder load failed",retryable:!1}})})),s[o]={store:d,form:r,elements:l,tier:c}})}function g(e){var t=e.detail||{},r=document.querySelectorAll('form[data-starmus="recorder"]');if(r&&0!==r.length)for(var n=0;n<r.length;n++)y(t,r[n])}function v(){var t=function(){try{return navigator.connection||navigator.mozConnection||navigator.webkitConnection||null}catch(e){return null}}()||{},r={browser:{userAgent:navigator.userAgent},device:{type:/mobile|android|iphone|ipad/i.test(navigator.userAgent)?"mobile":"desktop",memory:l(),concurrency:m()},capabilities:{webrtc:!(!navigator.mediaDevices||"function"!=typeof navigator.mediaDevices.getUserMedia),mediaRecorder:!!e.MediaRecorder,indexedDB:!!e.indexedDB},network:{effectiveType:t.effectiveType||"unknown",downlink:t.downlink||null,saveData:t.saveData||!1}};u("E_ENV_FALLBACK_INIT",{severity:"warning",message:"Fallback env used",data:{fallbackEnv:r}}),g({detail:r})}}("undefined"!=typeof window?window:globalThis));
