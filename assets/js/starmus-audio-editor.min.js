!function(e){"use strict";if("undefined"==typeof STARMUS_EDITOR_DATA)return;const{restUrl:t,nonce:n,postId:i,audioUrl:o,annotations:a=[]}=STARMUS_EDITOR_DATA;if(!document.querySelector(".starmus-editor"))return;const d=document.getElementById("overview"),r=document.getElementById("zoomview"),s=document.getElementById("play"),m=document.getElementById("add-region"),l=document.getElementById("save"),c=document.getElementById("regions-list"),u=document.getElementById("peaks-container");if(!(o&&d&&r&&s&&m&&l&&c&&u))return void p("Missing required elements for the audio editor.");let g=!1;function f(e){g=e,l.disabled=!g}function p(e,t="error"){const n=document.getElementById("starmus-editor-notice");n&&(e?(n.textContent=e,n.className=`starmus-editor__notice starmus-editor__notice--${t}`,n.hidden=!1):n.hidden=!0)}window.addEventListener("beforeunload",(function(e){g&&(e.preventDefault(),e.returnValue="")}));const T=new Audio(o);T.crossOrigin="anonymous",T.addEventListener("error",(function(){p("Audio failed to load. This may be a CORS issue. Ensure the server sends correct Cross-Origin-Resource-Policy headers.")})),T.addEventListener("loadedmetadata",(function(){if(!Number.isFinite(T.duration)||0===T.duration)return void p("Audio failed to load or has an invalid duration.");function e(e){let t=e.slice().filter((e=>Number.isFinite(e.startTime)&&Number.isFinite(e.endTime)&&e.endTime>e.startTime&&e.startTime>=0&&e.endTime<=T.duration));t.sort(((e,t)=>e.startTime-t.startTime));let n=[],i=-1;for(const o of t)o.startTime>=i&&(n.push(o),i=o.endTime);return n}function o(){return window.crypto?.randomUUID?window.crypto.randomUUID():"id-"+Math.random().toString(36).slice(2)+Date.now()}let u=e(a).map((e=>({...e,id:e.id||o(),label:(e.label||"").trim().slice(0,200)})));const y={containers:{overview:d,zoomview:r},mediaElement:T,height:180,zoomLevels:[64,128,256,512,1024],keyboard:!1,segments:u,allowSeeking:!0};Peaks.init(y,(function(a,d){if(a)return void p("Could not load audio waveform. Please check the browser console for details.");const r=document.getElementById("starmus-time-cur"),u=document.getElementById("starmus-time-dur"),y=e=>{if(!Number.isFinite(e))return"0:00";const t=Math.floor(e/60),n=Math.floor(e%60);return t+":"+String(n).padStart(2,"0")};u.textContent=y(T.duration),T.addEventListener("timeupdate",(()=>{r.textContent=y(T.currentTime)})),s.addEventListener("click",(()=>{T.paused?T.play():T.pause()})),T.addEventListener("play",(()=>{s.textContent="Pause",s.setAttribute("aria-pressed","true")})),T.addEventListener("pause",(()=>{s.textContent="Play",s.setAttribute("aria-pressed","false")})),document.getElementById("back5").onclick=()=>{T.currentTime=Math.max(0,T.currentTime-5)},document.getElementById("fwd5").onclick=()=>{T.currentTime=Math.min(T.duration||0,T.currentTime+5)},document.getElementById("zoom-in").onclick=()=>d.zoom.zoomIn(),document.getElementById("zoom-out").onclick=()=>d.zoom.zoomOut(),document.getElementById("zoom-fit").onclick=()=>d.zoom.setZoom(0);let v=!1,E=null;const b=document.getElementById("loop");function h(){const e=document.getElementById("regions-list");e.innerHTML="";const t=d.segments.getSegments();if(!t.length){const t=document.createElement("tr");return t.innerHTML='<td colspan="5">No annotations yet. Click "Add Region" to start.</td>',e.appendChild(t),void f(g)}t.forEach((t=>{const n=t.endTime-t.startTime,i=document.createElement("tr");i.innerHTML=`\n            <td><input data-k="label" data-id="${t.id}" value="${t.label?String(t.label).replace(/"/g,"&quot;"):""}" maxlength="200" placeholder="Annotation" class="widefat" /></td>\n            <td><input data-k="startTime" data-id="${t.id}" type="number" step="0.01" min="0" value="${t.startTime.toFixed(2)}" class="small-text" /></td>\n            <td><input data-k="endTime" data-id="${t.id}" type="number" step="0.01" min="0" value="${t.endTime.toFixed(2)}" class="small-text" /></td>\n            <td>${y(n)}</td>\n            <td>\n              <button class="button" data-act="jump" data-id="${t.id}">Jump</button>\n              <button class="button button-link-delete" data-act="del" data-id="${t.id}">Delete</button>\n            </td>`,e.appendChild(i)}))}let k;b.addEventListener("change",(()=>{v=b.checked})),T.addEventListener("timeupdate",(()=>{if(!v)return;const e=T.currentTime,t=d.segments.getSegments();t.length&&(E=t.find((t=>e>=t.startTime&&e<t.endTime))||E||t[0],e>=E.endTime&&(T.currentTime=E.startTime))})),document.addEventListener("keydown",(e=>{e.target.matches("input,textarea")||("Space"===e.code&&(e.preventDefault(),s.click()),"ArrowLeft"===e.key&&(e.preventDefault(),document.getElementById("back5").click()),"ArrowRight"===e.key&&(e.preventDefault(),document.getElementById("fwd5").click()),"="===e.key&&(e.preventDefault(),d.zoom.zoomIn()),"-"===e.key&&(e.preventDefault(),d.zoom.zoomOut()))})),h(),c.addEventListener("input",(e=>{e.target.dataset.id&&(clearTimeout(k),k=setTimeout((()=>{f(!0);const t=e.target.dataset.id,n=e.target.dataset.k;let i="number"===e.target.type?parseFloat(e.target.value):e.target.value;const o=d.segments.getSegment(t);o&&o.update({[n]:i})}),250))})),c.addEventListener("click",(e=>{const t=e.target.dataset.id,n=e.target.dataset.act;if(t&&n)if("jump"===n){const e=d.segments.getSegment(t);e&&(T.currentTime=e.startTime,T.play())}else if("del"===n){d.segments.getSegment(t)&&(d.segments.removeById(t),f(!0),h())}})),m.onclick=()=>{const e=d.player.getCurrentTime(),t=Math.max(0,e-5);d.segments.add({id:o(),startTime:t,endTime:e,labelText:"",editable:!0}),f(!0),h()};let w=!1;l.onclick=async()=>{if(w)return;w=!0,l.textContent="Saving...",l.disabled=!0,p(null);let o=d.segments.getSegments().map((e=>({id:e.id,startTime:e.startTime,endTime:e.endTime,label:(e.labelText||e.label||"").trim().slice(0,200)})));o=e(o);try{const e=await fetch(t,{method:"POST",headers:{"X-WP-Nonce":n,"Content-Type":"application/json"},body:JSON.stringify({postId:i,annotations:o})}),a=await e.json();if(!e.ok)throw new Error(a.message||e.statusText);if(!a.success)throw new Error(a.message||"An unknown error occurred.");f(!1),p("Annotations saved successfully!","success"),a.annotations&&(d.segments.removeAll(),d.segments.add(a.annotations),h())}catch(a){p("Save failed: "+a.message,"error")}finally{w=!1,l.textContent="Save",l.disabled=!g}}}))}))}(jQuery);
//# sourceMappingURL=starmus-audio-editor.min.js.map