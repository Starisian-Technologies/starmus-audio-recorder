!function(){"use strict";const e=Object.create(null);const t={subscribe:function(t,s){return e[t]||(e[t]=new Set),e[t].add(s),()=>{e[t].delete(s)}},dispatch:function(t,s={},r={}){const a=e[t];if(a&&a.size)for(const e of Array.from(a))try{e(s,r)}catch(e){console.error("[Starmus] Command handler error:",t,e)}}};function s(...e){"undefined"!=typeof window&&window.STARMUS_DEBUG&&console.log("[Starmus]",...e)}const r={instanceId:null,env:{},status:"uninitialized",error:null,source:{kind:null,blob:null,file:null,fileName:""},submission:{progress:0,isQueued:!1}};function a(e={}){let t={...r,...e};const s=new Set;return{getState:function(){return t},dispatch:function(e){t=function(e,t){if(!t||!t.type)return e;switch(t.type){case"starmus/init":return{...e,instanceId:t.payload.instanceId||e.instanceId,env:t.payload.env||e.env,status:"idle",error:null,submission:{progress:0,isQueued:!1}};case"starmus/ui/step-continue":return{...e,status:"ready_to_record",error:null};case"starmus/mic-start":return{...e,status:"recording",error:null,source:{...e.source,kind:"mic"}};case"starmus/mic-stop":return{...e,status:"processing"};case"starmus/mic-complete":return{...e,status:"ready_to_submit",error:null,source:{kind:"mic",blob:t.blob||null,file:null,fileName:t.fileName||"recording.webm"},submission:{progress:0,isQueued:!1}};case"starmus/file-attached":return{...e,status:"ready_to_submit",error:null,source:{kind:"file",blob:null,file:t.file||null,fileName:t.file?t.file.name:""},submission:{progress:0,isQueued:!1}};case"starmus/submit-start":return{...e,status:"submitting",error:null,submission:{...e.submission,progress:0,isQueued:!!t.isQueued}};case"starmus/submit-progress":return{...e,status:"submitting",submission:{...e.submission,progress:"number"==typeof t.progress?t.progress:e.submission.progress}};case"starmus/submit-complete":return{...e,status:"complete",submission:{...e.submission,progress:1}};case"starmus/error":return{...e,status:t.status||e.status||"idle",error:t.error||{message:"Unknown error",retryable:!0}};case"starmus/reset":return{...r,instanceId:e.instanceId,env:e.env,status:"idle"};default:return e}}(t,e),s.forEach(e=>{try{e(t)}catch(e){console.error("[Starmus] Store listener error:",e)}})},subscribe:function(e){return s.add(e),()=>{s.delete(e)}}}}function n(e,t){const{status:s,error:r,source:a={},submission:n={}}=e;if(t.step1&&t.step2){const e="idle"===s;t.step1.style.display=e?"block":"none",t.step2.style.display=e?"none":"block"}t.recordBtn&&(t.recordBtn.disabled="ready_to_record"!==s),t.stopBtn&&(t.stopBtn.disabled="recording"!==s),t.submitBtn&&(t.submitBtn.disabled="ready_to_submit"!==s),t.progressEl&&(t.progressEl.style.width=100*(n.progress||0)+"%",t.progressEl.style.display="submitting"===s?"block":"none");const i=t.statusEl||t.messageBox;if(i){let e="";if(r)i.className="starmus-status starmus-status--error",e=`Error: ${r.message||"An unknown error occurred."}`,r.retryable&&(e+=" Please try again.");else switch(i.className="starmus-status",s){case"idle":e="Please fill out the details below to continue.";break;case"ready_to_record":e="Ready to record or attach an audio file.";break;case"recording":e="Recording...";break;case"processing":e="Finalizing recording...";break;case"ready_to_submit":e=n.isQueued?"Saved offline. Will submit automatically.":`Ready to submit: ${a.fileName||"audio file"}.`;break;case"submitting":e=`Uploading... ${Math.round(100*(n.progress||0))}%`;break;case"complete":e="Submission successful!";break;default:e="Initializing..."}i.textContent=e,i.style.display="block"}}const i=new Map;const o=new Map;function u(e,r){let u=r.getAttribute("data-starmus-id");u||(u="starmus_"+Date.now()+"_"+Math.random().toString(16).slice(2),r.setAttribute("data-starmus-id",u));const c=a({instanceId:u,env:e}),d={step1:r.querySelector(".starmus-step-1"),step2:r.querySelector(".starmus-step-2"),continueBtn:r.querySelector('[data-starmus-action="continue"]')||r.querySelector(".starmus-btn-continue"),messageBox:r.querySelector("[data-starmus-message-box]")||r.querySelector('[id^="starmus_step1_usermsg_"]'),recordBtn:r.querySelector('[data-starmus-action="record"]'),stopBtn:r.querySelector('[data-starmus-action="stop"]'),submitBtn:r.querySelector('[data-starmus-action="submit"]'),resetBtn:r.querySelector('[data-starmus-action="reset"]'),fileInput:r.querySelector('input[type="file"][data-starmus-file]')||r.querySelector('input[type="file"]'),statusEl:r.querySelector("[data-starmus-status]"),progressEl:r.querySelector("[data-starmus-progress]")};!function(e,t){const s=e.subscribe(e=>n(e,t));n(e.getState(),t)}(c,d),function(e,r){t.subscribe("start-mic",async(t,a)=>{if(a.instanceId===r)if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{const t=await navigator.mediaDevices.getUserMedia({audio:!0}),a=new MediaRecorder(t),n=[];i.set(r,{mediaRecorder:a,chunks:n,stream:t}),a.addEventListener("dataavailable",e=>{e.data&&e.data.size>0&&n.push(e.data)}),a.addEventListener("stop",()=>{const t=i.get(r);if(!t)return;const a=new Blob(t.chunks,{type:"audio/webm"}),n=`starmus-recording-${Date.now()}.webm`;s("Mic recording complete",r,n),e.dispatch({type:"starmus/mic-complete",blob:a,fileName:n}),t.stream.getTracks().forEach(e=>e.stop()),i.delete(r)}),e.dispatch({type:"starmus/mic-start"}),a.start()}catch(t){console.error(t),e.dispatch({type:"starmus/error",error:{message:"Could not access microphone.",retryable:!0},status:"idle"})}else e.dispatch({type:"starmus/error",error:{message:"Microphone is not supported in this browser.",retryable:!1},status:"idle"})}),t.subscribe("stop-mic",(t,s)=>{if(s.instanceId!==r)return;const a=i.get(r);a&&a.mediaRecorder&&"recording"===a.mediaRecorder.state&&(e.dispatch({type:"starmus/mic-stop"}),a.mediaRecorder.stop())}),t.subscribe("attach-file",(t,a)=>{if(a.instanceId!==r)return;const n=t.file;n&&(s("File attached",r,n.name),e.dispatch({type:"starmus/file-attached",file:n}))}),t.subscribe("reset",(e,t)=>{if(t.instanceId!==r)return;const s=i.get(r);s&&(s.mediaRecorder&&"recording"===s.mediaRecorder.state&&s.mediaRecorder.stop(),s.stream&&s.stream.getTracks().forEach(e=>e.stop()),i.delete(r))})}(c,u),function(e,r,a){async function n(t){const n=e.getState(),{source:i}=n;if(!i||!i.blob&&!i.file)return void e.dispatch({type:"starmus/error",error:{message:"Please record or attach audio before submitting.",retryable:!1},status:n.status});const o=window&&window.starmusConfig?window.starmusConfig:{},u=o.endpoints||{},c=o.nonce||"",d=u.directUpload||"";if(!d)return void e.dispatch({type:"starmus/error",error:{message:"Upload endpoint is not configured.",retryable:!0},status:n.status});const l=new FormData;Object.keys(t).forEach(e=>{l.append(e,t[e])}),i.blob?l.append("audio_file",i.blob,i.fileName||"recording.webm"):i.file&&l.append("audio_file",i.file,i.file.name||"upload.webm"),l.append("_starmus_env",JSON.stringify(a||{})),e.dispatch({type:"starmus/submit-start"});try{s("Submitting audio for instance",r,d);const t=await fetch(d,{method:"POST",headers:{"X-WP-Nonce":c},body:l});if(!t.ok)throw new Error(`Upload failed with status ${t.status}`);e.dispatch({type:"starmus/submit-complete"})}catch(t){console.error(t),e.dispatch({type:"starmus/error",error:{message:t.message||"Upload failed.",retryable:!0},status:"ready_to_submit"})}}t.subscribe("submit",(e,t)=>{t.instanceId===r&&n(e.formFields||{})}),t.subscribe("reset",(t,s)=>{s.instanceId===r&&e.dispatch({type:"starmus/reset"})})}(c,u,e),o.set(u,{store:c,form:r,elements:d});const l=!(!window.SpeechRecognition&&!window.webkitSpeechRecognition);return c.dispatch({type:"starmus/init",payload:{instanceId:u,env:{...e,speechSupported:l}}}),d.continueBtn&&d.step1&&d.step2&&d.continueBtn.addEventListener("click",e=>{e.preventDefault();const t=d.step1,s=t.querySelector('[name="starmus_title"]'),r=t.querySelector('[name="starmus_language"]'),a=t.querySelector('[name="starmus_recording_type"]'),n=t.querySelector('[name="agreement_to_terms"]'),i=d.messageBox,o=[];s&&s.value.trim()||o.push("Title"),r&&r.value.trim()||o.push("Language"),a&&a.value.trim()||o.push("Recording Type"),n&&n.checked||o.push("Consent"),o.length>0?i&&(i.textContent="Missing: "+o.join(", "),i.style.display="block"):(i&&(i.textContent="",i.style.display="none"),c.dispatch({type:"starmus/ui/step-continue"}))}),d.recordBtn&&d.recordBtn.addEventListener("click",e=>{e.preventDefault(),t.dispatch("start-mic",{},{instanceId:u})}),d.stopBtn&&d.stopBtn.addEventListener("click",e=>{e.preventDefault(),t.dispatch("stop-mic",{},{instanceId:u})}),d.fileInput&&d.fileInput.addEventListener("change",()=>{const e=d.fileInput.files&&d.fileInput.files[0];e&&t.dispatch("attach-file",{file:e},{instanceId:u})}),r.addEventListener("submit",e=>{e.preventDefault();const s=new FormData(r),a={};s.forEach((e,t)=>{a[t]=e}),t.dispatch("submit",{formFields:a},{instanceId:u})}),d.resetBtn&&d.resetBtn.addEventListener("click",e=>{e.preventDefault(),t.dispatch("reset",{},{instanceId:u})}),u}document.addEventListener("sparxstar:environment-ready",function(e){const t=e.detail||{},s=document.querySelectorAll('form[data-starmus="recorder"]');s&&s.length&&Array.prototype.forEach.call(s,e=>{u(t,e)})},{once:!0}),"undefined"!=typeof window&&(window.STARMUS=window.STARMUS||{},window.STARMUS.instances=o)}();
