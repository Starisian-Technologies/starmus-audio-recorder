!function(){"use strict";const e=Object.create(null);const t={subscribe:function(t,r){return e[t]||(e[t]=new Set),e[t].add(r),()=>{e[t].delete(r)}},dispatch:function(t,r={},s={}){const o=e[t];if(o&&o.size)for(const e of Array.from(o))try{e(r,s)}catch(e){console.error("[Starmus] Command handler error:",t,e)}}};function r(...e){"undefined"!=typeof window&&window.STARMUS_DEBUG&&console.log("[Starmus]",...e)}const s={instanceId:null,env:{},tier:null,status:"uninitialized",error:null,source:{kind:null,blob:null,file:null,fileName:"",transcript:""},calibration:{phase:null,message:"",volumePercent:0,complete:!1,gain:1,snr:null,noiseFloor:null,speechLevel:null},submission:{progress:0,isQueued:!1}};function o(e={}){let t={...s,...e};const r=new Set;return{getState:function(){return t},dispatch:function(e){t=function(e,t){if(!t||!t.type)return e;switch(t.type){case"starmus/init":return{...e,instanceId:t.payload.instanceId||e.instanceId,env:t.payload.env||e.env,tier:t.payload.tier||e.tier,status:"idle",error:null,submission:{progress:0,isQueued:!1}};case"starmus/calibration-start":return{...e,status:"calibrating",calibration:{phase:"quiet",message:"Preparing calibration...",volumePercent:0,complete:!1,gain:1,snr:null,noiseFloor:null,speechLevel:null}};case"starmus/calibration-update":return{...e,calibration:{...e.calibration,message:t.message||e.calibration.message,volumePercent:void 0!==t.volumePercent?t.volumePercent:e.calibration.volumePercent}};case"starmus/calibration-complete":return{...e,status:"ready",calibration:{...e.calibration,...t.calibration,complete:!0,message:"Calibration complete"}};case"starmus/set-tier":return{...e,tier:t.tier};case"starmus/ui/step-continue":return{...e,status:"ready_to_record",error:null};case"starmus/mic-start":return{...e,status:"recording",error:null,source:{...e.source,kind:"mic"}};case"starmus/mic-stop":return{...e,status:"processing"};case"starmus/mic-complete":return{...e,status:"ready_to_submit",error:null,source:{kind:"mic",blob:t.blob||null,file:null,fileName:t.fileName||"recording.webm",transcript:t.transcript||e.source.transcript||""},submission:{progress:0,isQueued:!1}};case"starmus/transcript-update":return{...e,source:{...e.source,transcript:t.transcript||""}};case"starmus/file-attached":return{...e,status:"ready_to_submit",error:null,source:{kind:"file",blob:null,file:t.file||null,fileName:t.file?t.file.name:""},submission:{progress:0,isQueued:!1}};case"starmus/submit-start":return{...e,status:"submitting",error:null,submission:{...e.submission,progress:0,isQueued:!!t.isQueued}};case"starmus/submit-progress":return{...e,status:"submitting",submission:{...e.submission,progress:"number"==typeof t.progress?t.progress:e.submission.progress}};case"starmus/submit-queued":return{...e,status:"complete",submission:{...e.submission,progress:0,isQueued:!0,submissionId:t.submissionId}};case"starmus/submit-complete":return{...e,status:"complete",submission:{...e.submission,progress:1}};case"starmus/error":return{...e,status:t.status||e.status||"idle",error:t.error||{message:"Unknown error",retryable:!0}};case"starmus/reset":return{...s,instanceId:e.instanceId,env:e.env,status:"idle"};default:return e}}(t,e),r.forEach(e=>{try{e(t)}catch(e){console.error("[Starmus] Store listener error:",e)}})},subscribe:function(e){return r.add(e),()=>{r.delete(e)}}}}function n(e,t){const{status:r,error:s,source:o={},submission:n={},calibration:a={}}=e;if(t.step1&&t.step2){const e="idle"===r;t.step1.style.display=e?"block":"none",t.step2.style.display=e?"none":"block"}t.recordBtn&&(t.recordBtn.disabled="ready_to_record"!==r),t.stopBtn&&(t.stopBtn.disabled="recording"!==r),t.submitBtn&&(t.submitBtn.disabled="ready_to_submit"!==r),t.progressEl&&(t.progressEl.style.width=100*(n.progress||0)+"%",t.progressEl.style.display="submitting"===r?"block":"none"),t.volumeMeter&&("calibrating"===r?(t.volumeMeter.style.display="block",t.volumeMeter.style.width=`${a.volumePercent||0}%`):t.volumeMeter.style.display="none");const i=t.statusEl||t.messageBox;if(i){let e="";if(s)i.className="starmus-status starmus-status--error",e=`Error: ${s.message||"An unknown error occurred."}`,s.retryable&&(e+=" Please try again.");else switch(i.className="starmus-status",r){case"idle":e="Please fill out the details below to continue.";break;case"calibrating":e=a.message||"Calibrating microphone...";break;case"ready":case"ready_to_record":e=a.complete?`Calibration complete (Gain: ${(a.gain||1).toFixed(1)}x). Ready to record.`:"Ready to record or attach an audio file.";break;case"recording":e="Recording...";break;case"processing":e="Finalizing recording...";break;case"ready_to_submit":e=n.isQueued?"Saved offline. Will submit automatically when online.":`Ready to submit: ${o.fileName||"audio file"}.`;break;case"submitting":e=`Uploading... ${Math.round(100*(n.progress||0))}%`;break;case"complete":e=n.isQueued?"Saved offline. Will submit automatically when online.":"Submission successful!";break;default:e="Initializing..."}i.textContent=e,i.style.display="block"}}function a(e,t){const r=e.subscribe(e=>n(e,t));return n(e.getState(),t),r}const i=new Map;async function c(e,t){return new Promise(r=>{const s=new(window.AudioContext||window.webkitAudioContext),o=s.createAnalyser(),n=s.createMediaStreamSource(e),a=new Float32Array(o.fftSize);o.fftSize=2048,n.connect(o);const i=[],c=performance.now();!function e(){const l=performance.now()-c,u=Math.ceil((15e3-l)/1e3);let d="";d=l<5e3?`Be quiet for background noise (${u}s)`:l<1e4?`Now speak at normal volume (${u}s)`:`Be quiet again (${u}s)`,o.getFloatTimeDomainData(a);let m=0;for(let e=0;e<a.length;e++)m+=a[e]*a[e];const p=Math.sqrt(m/a.length);i.push(p);const g=Math.min(100,2e3*p);t&&t(d,g,!1),l<15e3?requestAnimationFrame(e):function(){const e=i.slice(0,Math.floor(.33*i.length)),o=i.slice(Math.floor(.33*i.length),Math.floor(.67*i.length)),a=e.reduce((e,t)=>e+t,0)/e.length,c=o.reduce((e,t)=>e+t,0)/o.length,l=c/Math.max(a,1e-6);let u=l<3?6:Math.max(1,Math.min(4,.1/Math.max(c,1e-6)));const d={gain:parseFloat(u.toFixed(3)),snr:parseFloat(l.toFixed(3)),noiseFloor:parseFloat(a.toFixed(6)),speechLevel:parseFloat(c.toFixed(6)),timestamp:(new Date).toISOString()};n.disconnect(),s.close();const m=`Ready to record. Mic calibrated (gain Ã—${u.toFixed(1)}, SNR: ${l.toFixed(1)})`;t&&t(m,null,!0);r(d)}()}()})}const l={chunkSize:5242880,retryDelays:[0,3e3,5e3,1e4,2e4],removeFingerprintOnSuccess:!0,storeFingerprintForResuming:!0};async function u(e,t,s,o,n,a){if(!window.tus||!window.tus.Upload)throw r("[TUS] tus-js-client not loaded, falling back to direct upload"),new Error("TUS_NOT_AVAILABLE");const i=window.starmusTus||{},c=i.endpoint||window.starmusConfig?.endpoints?.tusUpload;if(!c)throw r("[TUS] No TUS endpoint configured"),new Error("TUS_ENDPOINT_NOT_CONFIGURED");const u={filename:m(t),filetype:e.type||"audio/webm",...Object.keys(s).reduce((e,t)=>(e[t]=m(String(s[t])),e),{})};o&&(u.starmus_meta=m(JSON.stringify(o)));const d={endpoint:c,chunkSize:i.chunkSize||l.chunkSize,retryDelays:i.retryDelays||l.retryDelays,removeFingerprintOnSuccess:i.removeFingerprintOnSuccess??l.removeFingerprintOnSuccess,storeFingerprintForResuming:i.storeFingerprintForResuming??l.storeFingerprintForResuming,metadata:u,headers:i.headers||{},onError:function(e){r("[TUS] Upload error:",e)},onProgress:function(e,t){r(`[TUS] Progress: ${Math.round(e/t*100)}% (${e}/${t} bytes)`),a&&a(e,t)},onSuccess:function(){r("[TUS] Upload complete:",p.url)}},p=new window.tus.Upload(e,d);return new Promise((e,t)=>{p.findPreviousUploads().then(e=>{e&&e.length>0&&(r("[TUS] Found previous upload, resuming from:",e[0].uploadUrl),p.resumeFromPreviousUpload(e[0])),p.start()}).catch(e=>{r("[TUS] Could not check for previous uploads, starting fresh:",e),p.start()}),p.options.onSuccess=function(){r("[TUS] Upload successful:",p.url),e(p.url)},p.options.onError=function(e){r("[TUS] Upload failed:",e),t(e)}})}async function d(e,t,s,o,n,a){const i=window.starmusConfig||{},c=i.endpoints?.directUpload,l=i.nonce||"";if(!c)throw new Error("Direct upload endpoint not configured");const u=new FormData;Object.keys(s).forEach(e=>{u.append(e,s[e])}),u.append("audio_file",e,t),o&&(o.transcript&&u.append("_starmus_transcript",o.transcript),o.calibration&&u.append("_starmus_calibration",JSON.stringify(o.calibration)),o.env&&u.append("_starmus_env",JSON.stringify(o.env))),r("[Direct Upload] Uploading to:",c);const d=await fetch(c,{method:"POST",headers:{"X-WP-Nonce":l},body:u});if(!d.ok){const e=await d.text();throw new Error(`Upload failed: ${d.status} - ${e}`)}return d.json()}function m(e){return"string"!=typeof e&&(e=String(e)),(e=e.replace(/[\r\n\t]/g," ")).length>500&&(e=e.substring(0,497)+"..."),e}function p(){const e=!(!window.tus||!window.tus.Upload),t=!(!window.starmusTus?.endpoint&&!window.starmusConfig?.endpoints?.tusUpload);return e&&t}const g={dbName:"StarmusSubmissions",storeName:"pendingSubmissions",dbVersion:1,maxRetries:10,retryDelays:[0,5e3,1e4,3e4,6e4,12e4,3e5,6e5,12e5,18e5],localStorageKey:"starmus_offline_queue_fallback"};class f{constructor(){this.db=null,this.isOnline=navigator.onLine,this.isProcessing=!1,this.useLocalStorageFallback=!1}async init(){return window.indexedDB?new Promise((e,t)=>{const s=indexedDB.open(g.dbName,g.dbVersion);s.onerror=()=>{r("[Offline] IndexedDB open failed, using localStorage fallback"),this.useLocalStorageFallback=!0,e()},s.onsuccess=t=>{this.db=t.target.result,r("[Offline] IndexedDB connection ready"),e()},s.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(g.storeName)){const e=t.createObjectStore(g.storeName,{keyPath:"id"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("retryCount","retryCount",{unique:!1}),r("[Offline] Created object store:",g.storeName)}}}):(r("[Offline] IndexedDB not supported, using localStorage fallback"),this.useLocalStorageFallback=!0,Promise.resolve())}async add(e,t,r,s,o){const n={id:`starmus-offline-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,instanceId:e,fileName:r,timestamp:Date.now(),audioBlob:t,formFields:s||{},metadata:o||{},retryCount:0,lastAttempt:null,error:null};return this.useLocalStorageFallback?this._addToLocalStorage(n):this._addToIndexedDB(n)}async _addToIndexedDB(e){return new Promise((t,s)=>{const o=this.db.transaction([g.storeName],"readwrite").objectStore(g.storeName).add(e);o.onsuccess=()=>{r("[Offline] Added to queue:",e.id),this._notifyQueueUpdate(),t(e.id)},o.onerror=()=>{r("[Offline] Failed to add to queue:",o.error),s(o.error)}})}async _addToLocalStorage(e){try{const t=await this._blobToBase64(e.audioBlob),s={...e,audioBlob:null,audioBase64:t},o=this._getLocalStorageQueue();o.push(s);try{return localStorage.setItem(g.localStorageKey,JSON.stringify(o)),r("[Offline] Added to localStorage fallback queue:",e.id),this._notifyQueueUpdate(),e.id}catch(e){throw r("[Offline] localStorage quota exceeded, cannot save offline"),new Error("STORAGE_QUOTA_EXCEEDED")}}catch(e){throw r("[Offline] Failed to save to localStorage:",e),e}}async getAll(){return this.useLocalStorageFallback?this._getLocalStorageQueue():this._getAllFromIndexedDB()}async _getAllFromIndexedDB(){return new Promise((e,t)=>{const r=this.db.transaction([g.storeName],"readonly").objectStore(g.storeName).getAll();r.onsuccess=()=>{e(r.result||[])},r.onerror=()=>{t(r.error)}})}_getLocalStorageQueue(){try{const e=localStorage.getItem(g.localStorageKey);return e?JSON.parse(e):[]}catch(e){return r("[Offline] Failed to read localStorage queue:",e),[]}}async remove(e){return this.useLocalStorageFallback?this._removeFromLocalStorage(e):this._removeFromIndexedDB(e)}async _removeFromIndexedDB(e){return new Promise((t,s)=>{const o=this.db.transaction([g.storeName],"readwrite").objectStore(g.storeName).delete(e);o.onsuccess=()=>{r("[Offline] Removed from queue:",e),this._notifyQueueUpdate(),t()},o.onerror=()=>{s(o.error)}})}async _removeFromLocalStorage(e){const t=this._getLocalStorageQueue().filter(t=>t.id!==e);localStorage.setItem(g.localStorageKey,JSON.stringify(t)),r("[Offline] Removed from localStorage queue:",e),this._notifyQueueUpdate()}async _updateRetryCount(e,t,r){if(!this.useLocalStorageFallback)return new Promise((s,o)=>{const n=this.db.transaction([g.storeName],"readwrite").objectStore(g.storeName),a=n.get(e);a.onsuccess=()=>{const e=a.result;e&&(e.retryCount=t,e.lastAttempt=Date.now(),e.error=r||null,n.put(e)),s()},a.onerror=()=>{o(a.error)}});{const s=this._getLocalStorageQueue(),o=s.find(t=>t.id===e);o&&(o.retryCount=t,o.lastAttempt=Date.now(),o.error=r||null,localStorage.setItem(g.localStorageKey,JSON.stringify(s)))}}async processQueue(){if(this.isProcessing)r("[Offline] Queue processing already in progress");else if(this.isOnline){this.isProcessing=!0,r("[Offline] Starting queue processing");try{const e=await this.getAll();if(0===e.length)return r("[Offline] No pending submissions"),void(this.isProcessing=!1);r(`[Offline] Processing ${e.length} pending submission(s)`);for(const t of e)if(t.retryCount>=g.maxRetries)r("[Offline] Max retries exceeded for:",t.id);else{if(t.lastAttempt){const e=g.retryDelays[Math.min(t.retryCount,g.retryDelays.length-1)];if(Date.now()-t.lastAttempt<e){r(`[Offline] Skipping ${t.id}, retry delay not elapsed`);continue}}try{r(`[Offline] Retrying upload (attempt ${t.retryCount+1}):`,t.id);let e=t.audioBlob;this.useLocalStorageFallback&&t.audioBase64&&(e=await this._base64ToBlob(t.audioBase64,"audio/webm"));p()&&e.size>1048576?await u(e,t.fileName,t.formFields,t.metadata,t.instanceId,null):await d(e,t.fileName,t.formFields,t.metadata,t.instanceId),r("[Offline] Upload successful, removing from queue:",t.id),await this.remove(t.id)}catch(e){r("[Offline] Upload failed:",e.message),await this._updateRetryCount(t.id,t.retryCount+1,e.message)}}}finally{this.isProcessing=!1,r("[Offline] Queue processing complete")}}else r("[Offline] Cannot process queue while offline")}setupNetworkListeners(){window.addEventListener("online",()=>{r("[Offline] Network online, processing queue"),this.isOnline=!0,this.processQueue()}),window.addEventListener("offline",()=>{r("[Offline] Network offline"),this.isOnline=!1}),setInterval(()=>{this.isOnline&&!this.isProcessing&&this.processQueue()},6e4)}_notifyQueueUpdate(){window.StarmusHooks?.doAction&&this.getAll().then(e=>{window.StarmusHooks.doAction("starmus_offline_queue_updated",e)})}_blobToBase64(e){return new Promise((t,r)=>{const s=new FileReader;s.onloadend=()=>t(s.result),s.onerror=r,s.readAsDataURL(e)})}_base64ToBlob(e,t){const r=atob(e.split(",")[1]),s=new ArrayBuffer(r.length),o=new Uint8Array(s);for(let e=0;e<r.length;e++)o[e]=r.charCodeAt(e);return new Blob([s],{type:t})}}let b=null;async function y(){return b||(b=new f,await b.init(),b.setupNetworkListeners()),b}function h(e,s,o){async function n(t){const o=e.getState(),{source:n,calibration:a,env:i}=o;if(!n||!n.blob&&!n.file)return void e.dispatch({type:"starmus/error",error:{message:"Please record or attach audio before submitting.",retryable:!1},status:o.status});const c=n.blob||n.file,l=n.fileName||n.file?.name||"recording.webm",m={transcript:n.transcript?.trim()||null,calibration:a.complete?{gain:a.gain,snr:a.snr,noiseFloor:a.noiseFloor,speechLevel:a.speechLevel,timestamp:a.timestamp||(new Date).toISOString()}:null,env:i||{}},g=function(e){if(e<60)return`~${e}s`;if(e<3600)return`~${Math.ceil(e/60)}m`;return`~${Math.floor(e/3600)}h ${Math.ceil(e%3600/60)}m`}(function(e,t){let r=t?.downlink;if(!r||0===r){const e=t?.effectiveType;switch(e){case"slow-2g":r=.05;break;case"2g":r=.25;break;case"3g":default:r=1;break;case"4g":r=10}}const s=e/(1e6*r/8)*1.3;return Math.ceil(s)}(c.size,i.network));r(`[Upload] File size: ${(c.size/1024/1024).toFixed(2)}MB, estimated time: ${g}`),e.dispatch({type:"starmus/submit-start"});try{if(p()&&c.size>1048576){r("[Upload] Using TUS resumable upload for",l);const s=await u(c,l,t,m,0,(t,r)=>{const s=t/r;e.dispatch({type:"starmus/submit-progress",progress:s})});r("[Upload] TUS upload complete:",s),e.dispatch({type:"starmus/submit-complete",uploadUrl:s})}else{r("[Upload] Using direct POST upload for",l);const s=await d(c,l,t,m);r("[Upload] Direct upload complete:",s),e.dispatch({type:"starmus/submit-complete",response:s})}}catch(o){console.error("[Upload] Failed:",o);if("TUS_ENDPOINT_NOT_CONFIGURED"!==o.message&&"Direct upload endpoint not configured"!==o.message){r("[Upload] Saving to offline queue for retry");try{const o=await async function(e,t,r,s,o){return(await y()).add(e,t,r,s,o)}(s,c,l,t,m);r("[Upload] Saved to offline queue:",o),e.dispatch({type:"starmus/submit-queued",submissionId:o});r(`[Upload] ${await async function(){const e=await y();return(await e.getAll()).length}()} submission(s) in offline queue`)}catch(t){console.error("[Upload] Failed to save to offline queue:",t),e.dispatch({type:"starmus/error",error:{message:"Upload failed and could not be saved for retry. "+("STORAGE_QUOTA_EXCEEDED"===t.message?"Storage quota exceeded.":"Please try again."),retryable:!1},status:"ready_to_submit"})}}else e.dispatch({type:"starmus/error",error:{message:o.message||"Upload failed.",retryable:!1},status:"ready_to_submit"})}}return t.subscribe("submit",(e,t)=>{t.instanceId===s&&n(e.formFields||{})}),t.subscribe("reset",(t,r)=>{r.instanceId===s&&e.dispatch({type:"starmus/reset"})}),{handleSubmit:n}}y().then(e=>{console.log("[Starmus] Offline queue initialized and ready")}).catch(e=>{console.error("[Starmus] Failed to initialize offline queue:",e)});const w=new Map;async function S(e,s){let n=s.getAttribute("data-starmus-id");n||(n="starmus_"+Date.now()+"_"+Math.random().toString(16).slice(2),s.setAttribute("data-starmus-id",n));let l=function(e){const t=e.capabilities||{},r=e.network||{};if(!t.mediaRecorder||!t.webrtc)return console.log("[Tier Detection] Tier C: No MediaRecorder support"),"C";const s=navigator.deviceMemory,o=navigator.hardwareConcurrency;if(s&&s<1)return console.log("[Tier Detection] Tier C: Low RAM (<1GB)"),"C";if(o&&o<2)return console.log("[Tier Detection] Tier C: Low CPU (<2 threads)"),"C";const n=navigator.userAgent;return/wv|Crosswalk|Android WebView|Opera Mini/i.test(n)?(console.log("[Tier Detection] Tier C: WebView environment detected"),"C"):"2g"===r.effectiveType||"slow-2g"===r.effectiveType?(console.log("[Tier Detection] Tier B: Slow network (2G)"),"B"):s&&s<2?(console.log("[Tier Detection] Tier B: Marginal RAM (1-2GB)"),"B"):(console.log("[Tier Detection] Tier A: Full features enabled"),"A")}(e);l=await async function(e){if("C"===e)return"C";if(navigator.storage&&navigator.storage.estimate)try{if(((await navigator.storage.estimate()).quota||0)/1024/1024<80)return console.log("[Tier Detection] Tier C: Storage quota too low (<80MB)"),"C"}catch(e){console.warn("[Tier Detection] Could not estimate storage:",e)}if(navigator.permissions&&navigator.permissions.query)try{if("denied"===(await navigator.permissions.query({name:"microphone"})).state)return console.log("[Tier Detection] Tier C: Microphone permission denied"),"C"}catch(e){console.warn("[Tier Detection] Could not query microphone permission:",e)}return e}(l),console.log(`[Starmus] Instance ${n} detected as Tier ${l}`);const u=o({instanceId:n,env:e,tier:l}),d={step1:s.querySelector(".starmus-step-1"),step2:s.querySelector(".starmus-step-2"),continueBtn:s.querySelector('[data-starmus-action="continue"]')||s.querySelector(".starmus-btn-continue"),messageBox:s.querySelector("[data-starmus-message-box]")||s.querySelector('[id^="starmus_step1_usermsg_"]'),recordBtn:s.querySelector('[data-starmus-action="record"]'),stopBtn:s.querySelector('[data-starmus-action="stop"]'),submitBtn:s.querySelector('[data-starmus-action="submit"]'),resetBtn:s.querySelector('[data-starmus-action="reset"]'),fileInput:s.querySelector('input[type="file"][data-starmus-file]')||s.querySelector('input[type="file"]'),statusEl:s.querySelector("[data-starmus-status]"),progressEl:s.querySelector("[data-starmus-progress]"),recorderContainer:s.querySelector("[data-starmus-recorder-container]")||s.querySelector("#starmus_recorder_container_"+n),fallbackContainer:s.querySelector("[data-starmus-fallback-container]")||s.querySelector("#starmus_fallback_container_"+n)};if("C"===l){console.log("[Starmus] Tier C mode: Revealing file upload fallback"),d.recorderContainer&&(d.recorderContainer.style.display="none"),d.fallbackContainer&&(d.fallbackContainer.style.display="block"),h(u,n),a(u,d),w.set(n,{store:u,form:s,elements:d,tier:l});const t=!1;return u.dispatch({type:"starmus/init",payload:{instanceId:n,env:e,tier:l,speechSupported:t}}),window.StarmusHooks?.doAction&&window.StarmusHooks.doAction("starmus_tier_c_revealed",n,e),n}a(u,d),function(e,s){t.subscribe("start-mic",async(t,o)=>{if(o.instanceId===s)if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{const t=e.getState().env||{},o=function(e,t){const r=e?.network||{},s=e?.device||{},o=t?.allowedMimeTypes||{};let n="audio/webm;codecs=opus";o.webm||o.weba?n="audio/webm;codecs=opus":o.mp4||o.m4a?n="audio/mp4":o.ogg||o.oga?n="audio/ogg;codecs=opus":o.wav&&(n="audio/wav");let a={constraints:{audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:16e3,channelCount:1}},options:{mimeType:n,audioBitsPerSecond:24e3}};const i=r.effectiveType,c=r.downlink,l="mobile"===s.type;return"4g"===i||c>2?(a.constraints.audio.sampleRate=48e3,a.constraints.audio.channelCount=2,a.options.audioBitsPerSecond=128e3):("3g"===i||c>.5)&&(a.constraints.audio.sampleRate=22050,a.options.audioBitsPerSecond=48e3),r.saveData&&(a.constraints.audio.sampleRate=16e3,a.constraints.audio.channelCount=1,a.options.audioBitsPerSecond=16e3),!l&&("4g"===i||c>5)&&(a.constraints.audio.sampleRate=48e3,a.options.audioBitsPerSecond=192e3),a}(t,window&&window.starmusConfig?window.starmusConfig:{});r("Using audio settings:",o);const n=await navigator.mediaDevices.getUserMedia(o.constraints);e.dispatch({type:"starmus/calibration-start"});const a=await c(n,(t,r,s)=>{s?e.dispatch({type:"starmus/calibration-complete",calibration:a}):e.dispatch({type:"starmus/calibration-update",message:t,volumePercent:r})});r("Calibration complete:",a),window.StarmusHooks?.doAction&&window.StarmusHooks.doAction("starmus_calibration_complete",s,a);let l=o.options;MediaRecorder.isTypeSupported(l.mimeType)||(l={},r("MIME type not supported, using browser default"));const u=new MediaRecorder(n,l),d=[];let m="";const p=window.SpeechRecognition||window.webkitSpeechRecognition;let g=null;if(p&&t.speechSupported)try{g=new p,g.continuous=!0,g.interimResults=!0,g.maxAlternatives=1;const t=i.get(s)?.form||document.querySelector(`[data-starmus-id="${s}"]`),o=t?.querySelector('[name="starmus_language"]');g.lang=o?.value||"en-US",g.onresult=t=>{let s="";for(let e=0;e<t.results.length;e++){const r=t.results[e];r.isFinal&&(s+=r[0].transcript+" ")}m+=s,e.dispatch({type:"starmus/transcript-update",transcript:m.trim()}),r("Transcript updated:",m.trim())},g.onerror=e=>{r("Speech recognition error:",e.error)},g.onend=()=>{r("Speech recognition ended")},g.start(),r("Speech recognition started for language:",g.lang)}catch(e){r("Failed to start speech recognition:",e),g=null}i.set(s,{mediaRecorder:u,chunks:d,stream:n,recognition:g,transcript:m,calibration:a}),u.addEventListener("dataavailable",e=>{e.data&&e.data.size>0&&d.push(e.data)}),u.addEventListener("stop",()=>{const t=i.get(s);if(!t)return;if(t.recognition)try{t.recognition.stop()}catch(e){r("Error stopping recognition:",e)}const o=new Blob(t.chunks,{type:"audio/webm"}),n=`starmus-recording-${Date.now()}.webm`;r("Mic recording complete",s,n),r("Final transcript:",t.transcript||"(no transcript available)"),e.dispatch({type:"starmus/mic-complete",blob:o,fileName:n,transcript:t.transcript||""}),t.stream.getTracks().forEach(e=>e.stop()),i.delete(s)}),e.dispatch({type:"starmus/mic-start"}),u.start()}catch(t){console.error(t),e.dispatch({type:"starmus/error",error:{message:"Could not access microphone.",retryable:!0},status:"idle"})}else e.dispatch({type:"starmus/error",error:{message:"Microphone is not supported in this browser.",retryable:!1},status:"idle"})}),t.subscribe("stop-mic",(t,r)=>{if(r.instanceId!==s)return;const o=i.get(s);o&&o.mediaRecorder&&"recording"===o.mediaRecorder.state&&(e.dispatch({type:"starmus/mic-stop"}),o.mediaRecorder.stop())}),t.subscribe("attach-file",(t,o)=>{if(o.instanceId!==s)return;const n=t.file;n&&(r("File attached",s,n.name),e.dispatch({type:"starmus/file-attached",file:n}))}),t.subscribe("reset",(e,t)=>{if(t.instanceId!==s)return;const r=i.get(s);r&&(r.mediaRecorder&&"recording"===r.mediaRecorder.state&&r.mediaRecorder.stop(),r.stream&&r.stream.getTracks().forEach(e=>e.stop()),i.delete(s))})}(u,n),h(u,n),w.set(n,{store:u,form:s,elements:d,tier:l});const m="A"===l&&!(!window.SpeechRecognition&&!window.webkitSpeechRecognition);u.dispatch({type:"starmus/init",payload:{instanceId:n,env:e,tier:l,speechSupported:m}});const p="true"===s.dataset.starmusRerecord;return d.continueBtn&&d.step1&&d.step2?d.continueBtn.addEventListener("click",e=>{e.preventDefault();const t=d.step1,r=t.querySelector('[name="starmus_title"]'),s=t.querySelector('[name="starmus_language"]'),o=t.querySelector('[name="starmus_recording_type"]'),n=t.querySelector('[name="agreement_to_terms"]'),a=d.messageBox,i=[];r&&r.value.trim()||i.push("Title"),s&&s.value.trim()||i.push("Language"),o&&o.value.trim()||i.push("Recording Type"),n&&n.checked||i.push("Consent"),i.length>0?a&&(a.textContent="Missing: "+i.join(", "),a.style.display="block"):(a&&(a.textContent="",a.style.display="none"),u.dispatch({type:"starmus/ui/step-continue"}))}):p&&u.dispatch({type:"starmus/ui/step-continue"}),d.recordBtn&&d.recordBtn.addEventListener("click",e=>{e.preventDefault(),t.dispatch("start-mic",{},{instanceId:n})}),d.stopBtn&&d.stopBtn.addEventListener("click",e=>{e.preventDefault(),t.dispatch("stop-mic",{},{instanceId:n})}),d.fileInput&&d.fileInput.addEventListener("change",()=>{const e=d.fileInput.files&&d.fileInput.files[0];e&&t.dispatch("attach-file",{file:e},{instanceId:n})}),s.addEventListener("submit",e=>{e.preventDefault();const r=new FormData(s),o={};r.forEach((e,t)=>{o[t]=e}),t.dispatch("submit",{formFields:o},{instanceId:n})}),d.resetBtn&&d.resetBtn.addEventListener("click",e=>{e.preventDefault(),t.dispatch("reset",{},{instanceId:n})}),n}async function v(e){const t=e.detail||{},r=document.querySelectorAll('form[data-starmus="recorder"]');if(r&&r.length)for(const e of r)await S(t,e)}let k=!1;document.addEventListener("sparxstar:environment-ready",e=>{k=!0,v(e)},{once:!0}),setTimeout(()=>{k||(console.warn("[Starmus] sparxstar:environment-ready not received, using fallback initialization"),function(){const e=!(!navigator.mediaDevices||!window.MediaRecorder),t=!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia),r=navigator.connection||navigator.mozConnection||navigator.webkitConnection,s=r?{effectiveType:r.effectiveType||"unknown",downlink:r.downlink||null,rtt:r.rtt||null,saveData:r.saveData||!1}:{effectiveType:"unknown",downlink:null,rtt:null,saveData:!1},o=navigator.deviceMemory||null,n=navigator.hardwareConcurrency||null,a=screen.width||0,i=screen.height||0;let c=null;navigator.getBattery&&navigator.getBattery().then(e=>{c={charging:e.charging,level:e.level}}).catch(()=>{}),v({detail:{browser:{name:navigator.userAgent.includes("Chrome")?"Chrome":navigator.userAgent.includes("Firefox")?"Firefox":navigator.userAgent.includes("Safari")?"Safari":"Unknown",version:"unknown",userAgent:navigator.userAgent},device:{type:/mobile|android|iphone|ipad|tablet/i.test(navigator.userAgent)?"mobile":"desktop",os:navigator.platform||"unknown",memory:o,concurrency:n,screen:`${a}x${i}`,battery:c},capabilities:{webrtc:t,mediaRecorder:e,indexedDB:!!window.indexedDB,serviceWorker:"serviceWorker"in navigator,permissions:"permissions"in navigator,storage:"storage"in navigator&&"estimate"in navigator.storage},network:s}})}())},2e3),"undefined"!=typeof window&&(window.STARMUS=window.STARMUS||{},window.STARMUS.instances=w)}();
