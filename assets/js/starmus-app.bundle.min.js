!function(){"use strict";const e=Object.create(null),t=new Set;const r={subscribe:function(t,r){return e[t]||(e[t]=new Set),e[t].add(r),()=>{e[t]&&e[t].delete(r)}},dispatch:function(r,s={},n={}){const a=r+"::"+(n?.instanceId||"");if(t.has(a))return void console.warn("[Starmus] Prevented recursive dispatch:",r);const o=e[r];if(o&&o.size){t.add(a);try{for(const e of Array.from(o))try{e(s,n)}catch(e){console.error("[Starmus] Command handler error:",r,e)}}finally{t.delete(a)}}},clearAllHandlers:function(){for(const t in e)e[t]&&e[t].clear()}},s="undefined"!=typeof window&&(window.STARMUS_DEBUG||new URLSearchParams(window.location.search).has("debug"));function n(...e){s&&console.log.apply(console,["[Starmus]",...e])}const a={instanceId:null,env:{},tier:null,status:"uninitialized",error:null,source:{kind:null,blob:null,file:null,fileName:"",transcript:""},calibration:{phase:null,message:"",volumePercent:0,complete:!1,gain:1,snr:null,noiseFloor:null,speechLevel:null},submission:{progress:0,isQueued:!1}};function o(e={}){let t={...a,...e};const r=new Set;return{getState:function(){return t},dispatch:function(e){t=function(e,t){if(!t||!t.type)return e;switch(t.type){case"starmus/init":return{...e,instanceId:t.payload.instanceId||e.instanceId,env:t.payload.env||e.env,tier:t.payload.tier||e.tier,status:"idle",error:null,submission:{progress:0,isQueued:!1}};case"starmus/calibration-start":return{...e,status:"calibrating",calibration:{phase:"quiet",message:"Preparing calibration...",volumePercent:0,complete:!1,gain:1,snr:null,noiseFloor:null,speechLevel:null}};case"starmus/calibration-update":return{...e,calibration:{...e.calibration,message:t.message||e.calibration.message,volumePercent:void 0!==t.volumePercent?t.volumePercent:e.calibration.volumePercent}};case"starmus/calibration-complete":return{...e,status:"ready",calibration:{...e.calibration,...t.calibration,complete:!0,message:"Calibration complete"}};case"starmus/set-tier":return{...e,tier:t.tier};case"starmus/ui/step-continue":return{...e,status:"ready_to_record",error:null};case"starmus/mic-start":return{...e,status:"recording",error:null,source:{...e.source,kind:"mic"}};case"starmus/mic-stop":return{...e,status:"processing"};case"starmus/mic-complete":return{...e,status:"ready_to_submit",error:null,source:{kind:"mic",blob:t.blob||null,file:null,fileName:t.fileName||"recording.webm",transcript:t.transcript||e.source.transcript||""},submission:{progress:0,isQueued:!1}};case"starmus/transcript-update":return{...e,source:{...e.source,transcript:t.transcript||""}};case"starmus/file-attached":return{...e,status:"ready_to_submit",error:null,source:{kind:"file",blob:null,file:t.file||null,fileName:t.file?t.file.name:""},submission:{progress:0,isQueued:!1}};case"starmus/submit-start":return{...e,status:"submitting",error:null,submission:{...e.submission,progress:0,isQueued:!!t.isQueued}};case"starmus/submit-progress":return{...e,status:"submitting",submission:{...e.submission,progress:"number"==typeof t.progress?t.progress:e.submission.progress}};case"starmus/submit-queued":return{...e,status:"complete",submission:{...e.submission,progress:0,isQueued:!0,submissionId:t.submissionId}};case"starmus/submit-complete":return{...e,status:"complete",submission:{...e.submission,progress:1}};case"starmus/error":return{...e,status:t.status||e.status||"idle",error:t.error||{message:"Unknown error",retryable:!0}};case"starmus/reset":return{...a,instanceId:e.instanceId,env:e.env,status:"idle"};default:return e}}(t,e),r.forEach(e=>{try{e(t)}catch(e){console.error("[Starmus] Store listener error:",e)}})},subscribe:function(e){return r.add(e),()=>{r.delete(e)}}}}function i(e,t){const{status:r,error:s,source:n={},submission:a={},calibration:o={}}=e;if(t.step1&&t.step2){const e="idle"!==r&&"ready"!==r;t.step1.style.display=e?"none":"block",t.step2.style.display=e?"block":"none"}if(t.recordBtn&&(t.recordBtn.disabled="recording"===r||"submitting"===r||"ready_to_submit"===r,"recording"===r?(t.recordBtn.classList.add("starmus-btn--recording"),t.recordBtn.textContent="Recording..."):(t.recordBtn.classList.remove("starmus-btn--recording"),t.recordBtn.textContent=t.recordBtn.getAttribute("data-original-text")||"Record")),t.stopBtn&&(t.stopBtn.disabled="recording"!==r),t.submitBtn&&(t.submitBtn.disabled="ready_to_submit"!==r,"submitting"===r?t.submitBtn.classList.add("starmus-btn--loading"):t.submitBtn.classList.remove("starmus-btn--loading")),t.resetBtn){const e="ready_to_submit"===r||"complete"===r||!!s;t.resetBtn.style.display=e?"inline-block":"none",t.resetBtn.disabled="submitting"===r}if(t.transcriptBox&&(n.transcript?(t.transcriptBox.style.display="block",t.transcriptBox.textContent=n.transcript,t.transcriptBox.classList.remove("starmus-transcript--pulse"),t.transcriptBox.offsetWidth,t.transcriptBox.classList.add("starmus-transcript--pulse")):t.transcriptBox.style.display="none"),t.progressEl){const e=100*(a.progress||0);t.progressEl.style.width=`${e}%`,t.progressEl.style.display="submitting"===r||"calibrating"===r?"block":"none"}if(t.volumeMeter&&("calibrating"===r?(t.volumeMeter.style.display="block",t.volumeMeter.style.width=`${o.volumePercent||0}%`):t.volumeMeter.style.display="none"),t.fileInput&&(n.file||n.fileName)){const e=n.fileName||n.file.name,r=t.form?.querySelector(`label[for="${t.fileInput.id}"]`);r&&(r.textContent=`Selected: ${e}`)}const i=t.statusEl||t.messageBox;if(i){let e="",t="starmus-status";if(s)t+=" starmus-status--error",e=`Error: ${s.message||"An unknown error occurred."}`,s.retryable&&(e+=" Please try again.");else switch(r){case"idle":e="Please fill out the details to continue.";break;case"calibrating":e=o.message||"Adjusting microphone...";break;case"ready":case"ready_to_record":e=o.complete?`Mic ready (Gain: ${(o.gain||1).toFixed(1)}x).`:"Ready to record.";break;case"recording":e="Recording in progress...",t+=" starmus-status--recording";break;case"processing":e="Processing audio...";break;case"ready_to_submit":a.isQueued?(e="Network offline. Recording saved to queue.",t+=" starmus-status--warning"):e=`Recorded: ${n.fileName||"Audio File"}. Ready to submit.`;break;case"submitting":e=`Uploading... ${Math.round(100*(a.progress||0))}%`;break;case"complete":a.isQueued?(e="Saved to offline queue. Will upload automatically when online.",t+=" starmus-status--warning"):(e="Submission successful! Thank you.",t+=" starmus-status--success");break;default:e=""}i.className=t,i.textContent=e,i.style.display=e?"block":"none"}}const c=new Map;let u=null;function l(){if(!u||"closed"===u.state){const e=window.AudioContext||window.webkitAudioContext;u=new e({latencyHint:"playback"})}return u}async function d(e,t){return new Promise(r=>{const s=l(),n=s.createAnalyser();n.fftSize=2048;const a=s.createMediaStreamSource(e);a.connect(n);const o=new Float32Array(n.fftSize),i=[],c=performance.now();!function e(){const s=performance.now()-c,u=Math.ceil((15e3-s)/1e3);let l="";l=s<5e3?`Be quiet for background noise (${u}s)`:s<1e4?`Now speak at normal volume (${u}s)`:`Be quiet again (${u}s)`,n.getFloatTimeDomainData(o);let d=0;for(let e=0;e<o.length;e++)d+=o[e]*o[e];const m=Math.sqrt(d/o.length);if(!Number.isFinite(m))return void requestAnimationFrame(e);i.push(m);const p=Math.min(100,2e3*m);t&&t(l,p,!1),s<15e3?requestAnimationFrame(e):function(){const e=Math.floor(i.length/3),s=i.slice(0,e),o=i.slice(e,2*e),c=s.reduce((e,t)=>e+t,0)/s.length,u=o.reduce((e,t)=>e+t,0)/o.length,l=u/Math.max(c,1e-6),d=l<3?6:Math.max(1,Math.min(4,.1/Math.max(u,1e-6))),m={gain:parseFloat(d.toFixed(3)),snr:parseFloat(l.toFixed(3)),noiseFloor:parseFloat(c.toFixed(6)),speechLevel:parseFloat(u.toFixed(6)),timestamp:(new Date).toISOString()};try{a.disconnect()}catch{}try{n.disconnect()}catch{}const p=`Ready. Mic calibrated (gain ×${d.toFixed(1)})`;t&&t(p,null,!0);r(m)}()}()})}function m(e,t){r.subscribe("start-mic",async(r,s)=>{if(s.instanceId===t)if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{const r=e.getState().env||{},s=function(e,t){const r=e?.network||{},s=e?.device||{},n=t?.allowedMimeTypes||{};let a="audio/webm;codecs=opus";n.mp4||n.m4a?a="audio/mp4":n.wav&&(a="audio/wav");const o={constraints:{audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:16e3,channelCount:1}},options:{mimeType:a,audioBitsPerSecond:24e3}},i=r.effectiveType,c=r.downlink,u="mobile"===s.type;return"4g"===i||c>2?(o.constraints.audio.sampleRate=48e3,o.constraints.audio.channelCount=2,o.options.audioBitsPerSecond=128e3):("3g"===i||c>.5)&&(o.constraints.audio.sampleRate=22050,o.options.audioBitsPerSecond=48e3),r.saveData&&(o.constraints.audio.sampleRate=16e3,o.constraints.audio.channelCount=1,o.options.audioBitsPerSecond=16e3),!u&&("4g"===i||c>5)&&(o.constraints.audio.sampleRate=48e3,o.options.audioBitsPerSecond=192e3),o}(r,window&&window.starmusConfig?window.starmusConfig:{});n("Using audio settings:",s);const a=await navigator.mediaDevices.getUserMedia(s.constraints);e.dispatch({type:"starmus/calibration-start"});const o=await d(a,(t,r,s)=>{s?e.dispatch({type:"starmus/calibration-complete",calibration:o}):e.dispatch({type:"starmus/calibration-update",message:t,volumePercent:r})}),{audioContext:i,destinationStream:u,nodes:m}=function(e){const t=l(),r=t.createMediaStreamSource(e),s=t.createBiquadFilter();s.type="highpass",s.frequency.value=85;const n=t.createDynamicsCompressor();n.threshold.value=-20,n.knee.value=40,n.ratio.value=12,n.attack.value=0,n.release.value=.25;const a=t.createMediaStreamAudioDestination();return r.connect(s),s.connect(n),n.connect(a),{audioContext:t,destinationStream:a.stream,nodes:[r,s,n,a]}}(a);"suspended"===i.state&&await i.resume();const p={};MediaRecorder.isTypeSupported(s.options.mimeType)?(p.mimeType=s.options.mimeType,p.audioBitsPerSecond=s.options.audioBitsPerSecond):n("Preferred MIME not supported, using browser default");const f=new MediaRecorder(u,p),g=[];let b="";const y=window.SpeechRecognition||window.webkitSpeechRecognition;let h=null;if(y&&r.speechSupported)try{h=new y,h.continuous=!0,h.interimResults=!0,h.maxAlternatives=1;const r=c.get(t)?.form||document.querySelector(`[data-starmus-id="${t}"]`),s=r?.querySelector('[name="starmus_language"]');h.lang=s?.value||"en-US",h.onresult=t=>{let r="";for(let e=0;e<t.results.length;e++){const s=t.results[e];s.isFinal&&(r+=s[0].transcript+" ")}b+=r,e.dispatch({type:"starmus/transcript-update",transcript:b.trim()})},h.start()}catch(e){n("Failed to start speech recognition:",e)}c.set(t,{mediaRecorder:f,chunks:g,rawStream:a,processedStream:u,audioContext:i,audioNodes:m,recognition:h,transcript:b,calibration:o}),f.addEventListener("dataavailable",e=>{e.data&&e.data.size>0&&g.push(e.data)}),f.addEventListener("stop",()=>{const r=c.get(t);if(!r)return;if(r.recognition)try{r.recognition.stop()}catch{}const s=new Blob(r.chunks,{type:r.mediaRecorder.mimeType||"audio/webm"}),a=`starmus-recording-${Date.now()}.webm`;n("Mic recording complete",t,a),e.dispatch({type:"starmus/mic-complete",blob:s,fileName:a,transcript:r.transcript||""}),r.rawStream&&r.rawStream.getTracks().forEach(e=>{try{e.stop()}catch{}}),r.processedStream&&r.processedStream.getTracks().forEach(e=>{try{e.stop()}catch{}}),r.audioNodes&&r.audioNodes.forEach(e=>{try{e.disconnect()}catch{}}),c.delete(t)}),e.dispatch({type:"starmus/mic-start"}),f.start(1e3)}catch(t){console.error(t),e.dispatch({type:"starmus/error",error:{message:"Could not access microphone.",retryable:!0},status:"idle"})}else e.dispatch({type:"starmus/error",error:{message:"Microphone is not supported in this browser.",retryable:!1},status:"idle"})}),r.subscribe("stop-mic",(r,s)=>{if(s.instanceId!==t)return;const n=c.get(t);n&&n.mediaRecorder&&"recording"===n.mediaRecorder.state&&(e.dispatch({type:"starmus/mic-stop"}),n.mediaRecorder.stop())}),r.subscribe("attach-file",(r,s)=>{if(s.instanceId!==t)return;const a=r.file;a&&(n("File attached",t,a.name),e.dispatch({type:"starmus/file-attached",file:a}))}),r.subscribe("reset",(e,r)=>{if(r.instanceId!==t)return;const s=c.get(t);s&&(s.mediaRecorder&&"recording"===s.mediaRecorder.state&&s.mediaRecorder.stop(),s.rawStream&&s.rawStream.getTracks().forEach(e=>e.stop()),s.processedStream&&s.processedStream.getTracks().forEach(e=>e.stop()),s.audioNodes&&s.audioNodes.forEach(e=>{try{e.disconnect()}catch{}}),c.delete(t))})}const p={chunkSize:1048576,retryDelays:[0,3e3,5e3,1e4,2e4,6e4]};async function f(e,t,r,s,a,o){if(!window.tus||!window.tus.Upload)throw n("[TUS] Library missing, using fallback"),new Error("TUS_NOT_AVAILABLE");const i=window.starmusTus||{},c=i.endpoint||window.starmusConfig?.endpoints?.tusUpload;if(!c)throw new Error("TUS_ENDPOINT_NOT_CONFIGURED");const u={filename:b(t),filetype:e.type||"audio/webm",...Object.keys(r).reduce((e,t)=>(e[t]=b(String(r[t])),e),{})};return s&&(u.starmus_meta=b(JSON.stringify(s))),new Promise((t,r)=>{const s={endpoint:c,chunkSize:i.chunkSize||p.chunkSize,retryDelays:i.retryDelays||p.retryDelays,metadata:u,headers:i.headers||{},fingerprint:function(e,t){return["starmus",a,e.size].join("-")},onError:e=>{n("[TUS] Error:",e),r(e)},onProgress:(e,t)=>{o&&o(e,t)},onSuccess:()=>{n("[TUS] Success:",l.url),t(l.url)}},l=new window.tus.Upload(e,s);l.findPreviousUploads().then(e=>{e&&e.length>0&&(n("[TUS] Resuming from:",e[0].uploadUrl),l.resumeFromPreviousUpload(e[0])),l.start()}).catch(()=>{l.start()})})}async function g(e,t,r,s,n,a){const o=window.starmusConfig||{},i=o.endpoints?.directUpload,c=o.nonce||"";if(!i)throw new Error("Direct upload endpoint not configured");return new Promise((n,o)=>{const u=new FormData;Object.keys(r).forEach(e=>u.append(e,r[e])),u.append("audio_file",e,t),s&&(s.transcript&&u.append("_starmus_transcript",s.transcript),s.calibration&&u.append("_starmus_calibration",JSON.stringify(s.calibration)),s.env&&u.append("_starmus_env",JSON.stringify(s.env)));const l=new XMLHttpRequest;l.open("POST",i,!0),l.setRequestHeader("X-WP-Nonce",c),l.upload&&a&&(l.upload.onprogress=e=>{e.lengthComputable&&a(e.loaded,e.total)}),l.onload=()=>{if(l.status>=200&&l.status<300)try{const e=JSON.parse(l.responseText);n(e)}catch{o(new Error("Invalid JSON response from server"))}else o(new Error(`Upload failed: ${l.status} ${l.statusText}`))},l.onerror=()=>o(new Error("Network error during direct upload")),l.onabort=()=>o(new Error("Upload aborted")),l.send(u)})}function b(e){return"string"!=typeof e&&(e=String(e)),(e=e.replace(/[\r\n\t]/g," ")).length>500?e.substring(0,497)+"...":e}function y(){return!(!window.tus||!window.tus.Upload||!window.starmusTus?.endpoint&&!window.starmusConfig?.endpoints?.tusUpload)}const h={dbName:"StarmusSubmissions",storeName:"pendingSubmissions",dbVersion:1,maxRetries:10,retryDelays:[0,5e3,1e4,3e4,6e4,12e4,3e5,6e5,12e5,18e5],maxBlobSize:41943040};const w=new class{constructor(){this.db=null,this.isOnline=navigator.onLine,this.isProcessing=!1}async init(){return window.indexedDB?new Promise((e,t)=>{const r=indexedDB.open(h.dbName,h.dbVersion);r.onerror=t=>{n("[Offline] DB Open Failed:",t.target.error),e()},r.onblocked=()=>{n("[Offline] DB Open Blocked: Close other tabs")},r.onsuccess=t=>{this.db=t.target.result,this.db.onversionchange=()=>{this.db.close(),n("[Offline] Database outdated, closing connection.")},n("[Offline] IndexedDB connection ready"),e()},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(h.storeName)){const e=t.createObjectStore(h.storeName,{keyPath:"id"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("retryCount","retryCount",{unique:!1}),n("[Offline] Created object store:",h.storeName)}}}):(console.error("[Offline] Critical: IndexedDB not supported. Offline uploads unavailable."),Promise.resolve())}async add(e,t,r,s,a){if(!this.db)throw new Error("Database not initialized");const o={id:`starmus-offline-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,instanceId:e,fileName:r,timestamp:Date.now(),audioBlob:t,formFields:s||{},metadata:a||{},retryCount:0,lastAttempt:null,error:null};return new Promise((e,t)=>{const r=this.db.transaction([h.storeName],"readwrite"),s=r.objectStore(h.storeName);if(o.audioBlob.size>h.maxBlobSize){r.abort();const e=`Audio file too large for offline storage (${(o.audioBlob.size/1024/1024).toFixed(2)}MB > 40MB limit)`;return n(`[Offline] ${e}`),void t(new Error(e))}const a=new Blob([o.audioBlob],{type:o.audioBlob.type});o.audioBlob=a;const i=s.add(o);r.oncomplete=()=>{s&&(n("[Offline] Transaction Committed:",o.id),this._notifyQueueUpdate(),e(o.id))},r.onerror=e=>{const r=e.target.error;if("QuotaExceededError"===r?.name)return n("[Offline] IndexedDB quota exceeded"),void t(new Error("IndexedDB quota exceeded — cannot save offline."));n("[Offline] Transaction Failed:",r),t(r)},i.onerror=e=>{e.stopPropagation(),t(e.target.error)}})}async getAll(){return this.db?new Promise((e,t)=>{const r=this.db.transaction([h.storeName],"readonly").objectStore(h.storeName).getAll();r.onsuccess=()=>{e(r.result||[])},r.onerror=()=>{t(r.error)}}):[]}async remove(e){if(this.db)return new Promise((t,r)=>{const s=this.db.transaction([h.storeName],"readwrite");s.objectStore(h.storeName).delete(e),s.oncomplete=()=>{n("[Offline] Removed from queue:",e),this._notifyQueueUpdate(),t()},s.onerror=e=>{r(e.target.error)}})}async _updateRetryCount(e,t,r){if(this.db)return new Promise((s,n)=>{const a=this.db.transaction([h.storeName],"readwrite"),o=a.objectStore(h.storeName),i=o.get(e);i.onsuccess=()=>{const e=i.result;e&&(e.retryCount=t,e.lastAttempt=Date.now(),e.error=r||null,o.put(e))},a.oncomplete=()=>{s()},a.onerror=()=>{n(a.error)}})}async processQueue(){if(!this.isProcessing&&navigator.onLine){this.isProcessing=!0,n("[Offline] Checking queue...");try{const e=await this.getAll();if(0===e.length)return void(this.isProcessing=!1);n(`[Offline] Found ${e.length} pending items`);for(const t of e)if(t.retryCount>=h.maxRetries)n("[Offline] Max retries exceeded, leaving in queue for manual review:",t.id);else{if(t.lastAttempt){const e=h.retryDelays[Math.min(t.retryCount,h.retryDelays.length-1)];if(Date.now()-t.lastAttempt<e)continue}try{n(`[Offline] Retrying upload (Attempt ${t.retryCount+1}):`,t.id);y()&&t.audioBlob.size>1048576?await f(t.audioBlob,t.fileName,t.formFields,t.metadata,t.instanceId,null):await g(t.audioBlob,t.fileName,t.formFields,t.metadata,t.instanceId),await this.remove(t.id)}catch(e){console.error("[Offline] Upload failed:",e);const r=e?.message||"";if(r.includes("QuotaExceededError")||r.includes("quota exceeded")||r.includes("400")||r.includes("Invalid JSON"))return void n("[Offline] Non-retryable error, leaving in queue for manual review:",t.id);await this._updateRetryCount(t.id,t.retryCount+1,r||"Upload failed (network instability)")}}}catch(e){console.error("[Offline] Queue processing error",e)}finally{this.isProcessing=!1}}}setupNetworkListeners(){window.addEventListener("online",()=>{n("[Offline] Network online - Triggering Queue"),this.isOnline=!0,this.processQueue()}),window.addEventListener("offline",()=>{this.isOnline=!1}),setInterval(()=>{navigator.onLine&&!this.isProcessing&&this.processQueue()},6e4)}_notifyQueueUpdate(){window.StarmusHooks?.doAction&&this.getAll().then(e=>{const t=e.map(e=>({id:e.id,fileName:e.fileName,retryCount:e.retryCount,error:e.error,timestamp:e.timestamp}));window.StarmusHooks.doAction("starmus_offline_queue_updated",t)})}};let v=null;async function S(){return v||(v=w,await v.init(),v.setupNetworkListeners()),v}function k(e,t,s){async function a(r){const a=e.getState(),{source:o,calibration:i,env:c}=a;if("submitting"===a.status)return void n("[Upload] Ignored duplicate submit");if(!o||!o.blob&&!o.file)return void e.dispatch({type:"starmus/error",error:{message:"Please record or attach audio before submitting.",retryable:!1},status:a.status});const u=o.blob||o.file,l=o.fileName||o.file?.name||"recording.webm",d=i&&i.complete?{gain:i.gain,snr:i.snr,noiseFloor:i.noiseFloor,speechLevel:i.speechLevel,timestamp:i.timestamp||(new Date).toISOString()}:null,m=Object.freeze({transcript:o.transcript?.trim()||null,calibration:d,env:c||s||{}}),p=function(e,t){let r=t?.downlink;if(!r||0===r){const e=t?.effectiveType;switch(e){case"slow-2g":r=.05;break;case"2g":r=.15;break;case"3g":r=.75;break;case"4g":r=8;break;default:r=.5}}r=Math.min(r,10);const s=1e6*r/8;return Math.ceil(e/s*1.5)}(u.size,(c||s).network),b=(h=p,Number.isFinite(h)?h<60?`~${h}s`:`~${Math.ceil(h/60)} min`:"Calculating...");var h;n(`[Upload] File size: ${(u.size/1024/1024).toFixed(2)}MB, estimated time: ${b}`),e.dispatch({type:"starmus/submit-start"});const w=(t,r)=>{const s=t/r;e.dispatch({type:"starmus/submit-progress",progress:s})};try{if(!navigator.onLine)throw n("[Upload] Device is offline, skipping directly to queue"),new Error("OFFLINE_FAST_PATH");if(y()&&u.size>1048576){n("[Upload] Using TUS resumable upload for",l);const s=await f(u,l,r,m,t,w);n("[Upload] TUS upload complete:",s),e.dispatch({type:"starmus/submit-complete",uploadUrl:s}),e.dispatch({type:"starmus/ready"})}else{n("[Upload] Using direct POST upload for",l);const t=await g(u,l,r,m,0,w);n("[Upload] Direct upload complete:",t),e.dispatch({type:"starmus/submit-complete",response:t}),e.dispatch({type:"starmus/ready"})}}catch(s){"OFFLINE_FAST_PATH"===s.message?n("[Upload] Processing offline save..."):console.error("[Upload] Failed:",s);if("TUS_ENDPOINT_NOT_CONFIGURED"===s.message||"Direct upload endpoint not configured"===s.message)e.dispatch({type:"starmus/error",error:{message:s.message||"Upload failed.",retryable:!1},status:"ready_to_submit"});else try{const s=await async function(e,t,r,s,n){return(await S()).add(e,t,r,s,n)}(t,u,l,r,m);n("[Upload] Saved to offline queue:",s),e.dispatch({type:"starmus/submit-queued",submissionId:s}),e.dispatch({type:"starmus/ready"}),async function(){const e=await S();return(await e.getAll()).length}().then(e=>{n(`[Upload] Queue depth: ${e}`)})}catch(t){console.error("[Upload] Offline save failed:",t);let r="Upload failed and could not be saved.";t.message&&t.message.includes("too large")?r="File too large to save offline.":"STORAGE_QUOTA_EXCEEDED"===t.message&&(r="Storage full. Cannot save offline."),e.dispatch({type:"starmus/error",error:{message:r,retryable:!1},status:"ready_to_submit"})}}}return r.subscribe("submit",(e,r)=>{r.instanceId===t&&a(e.formFields||{})}),r.subscribe("reset",(r,s)=>{s.instanceId===t&&e.dispatch({type:"starmus/reset"})}),{handleSubmit:a}}S().then(()=>{console.log("[Starmus] Offline queue initialized")}).catch(e=>{console.error("[Starmus] Offline queue init failed:",e)});const B=new Map;function C(){try{return navigator.deviceMemory||null}catch{return null}}function _(){try{return navigator.hardwareConcurrency||null}catch{return null}}async function x(e,t){let s=t.getAttribute("data-starmus-id");if(s||(s="starmus_"+Date.now()+"_"+Math.random().toString(16).slice(2),t.setAttribute("data-starmus-id",s)),B.has(s))return console.warn(`[Starmus] Instance ${s} already wired, skipping`),s;let n=function(e){const t=e.capabilities||{},r=e.network||{};if(!t.mediaRecorder||!t.webrtc)return"C";const s=C(),n=_();return s&&s<1||n&&n<2||/wv|Crosswalk|Android WebView|Opera Mini/i.test(navigator.userAgent)?"C":"2g"===r.effectiveType||"slow-2g"===r.effectiveType||s&&s<2?"B":"A"}(e);n=await async function(e){if("C"===e)return"C";if(navigator.storage&&navigator.storage.estimate)try{if(((await navigator.storage.estimate()).quota||0)/1024/1024<80)return"C"}catch{}if(navigator.permissions&&navigator.permissions.query)try{if("denied"===(await navigator.permissions.query({name:"microphone"})).state)return"C"}catch{}return e}(n),console.log(`[Starmus] Instance ${s} detected as Tier ${n}`);const a=o({instanceId:s,env:e,tier:n}),c={step1:t.querySelector(".starmus-step-1"),step2:t.querySelector(".starmus-step-2"),continueBtn:t.querySelector('[data-starmus-action="continue"]'),messageBox:t.querySelector("[data-starmus-message-box]"),recordBtn:t.querySelector('[data-starmus-action="record"]'),stopBtn:t.querySelector('[data-starmus-action="stop"]'),submitBtn:t.querySelector('[data-starmus-action="submit"]'),resetBtn:t.querySelector('[data-starmus-action="reset"]'),fileInput:t.querySelector('input[type="file"]'),statusEl:t.querySelector("[data-starmus-status]"),progressEl:t.querySelector("[data-starmus-progress]"),recorderContainer:t.querySelector("[data-starmus-recorder-container]"),fallbackContainer:t.querySelector("[data-starmus-fallback-container]")};"C"===n&&(console.log("[Starmus] Tier C: Revealing fallback, hiding recorder"),c.recorderContainer&&(c.recorderContainer.style.display="none"),c.fallbackContainer&&(c.fallbackContainer.style.display="block"),window.StarmusHooks?.doAction&&window.StarmusHooks.doAction("starmus_tier_c_revealed",s,e)),function(e,t){t.recordBtn&&!t.recordBtn.getAttribute("data-original-text")&&t.recordBtn.setAttribute("data-original-text",t.recordBtn.textContent);const r=e.subscribe(e=>i(e,t));i(e.getState(),t)}(a,c),k(a,s,e),"C"!==n&&m(a,s),B.set(s,{store:a,form:t,elements:c,tier:n});const u="A"===n&&!(!window.SpeechRecognition&&!window.webkitSpeechRecognition);return a.dispatch({type:"starmus/init",payload:{instanceId:s,env:e,tier:n,speechSupported:u}}),c.continueBtn?(console.log("[Starmus] Attaching continue button listener for",s),c.continueBtn.addEventListener("click",e=>{e.preventDefault(),console.log("[Starmus] Continue button clicked");const t=c.step1;if(!t)return void console.error("[Starmus] step1 element not found");const r=t.querySelector('[name="starmus_title"]'),s=t.querySelector('[name="starmus_language"]'),n=t.querySelector('[name="starmus_recording_type"]'),o=t.querySelector('[name="agreement_to_terms"]'),i=c.messageBox,u=[];r&&r.value.trim()||u.push("Title"),s&&s.value.trim()||u.push("Language"),n&&n.value.trim()||u.push("Recording Type"),o&&o.checked||u.push("Consent"),u.length>0?i&&(i.textContent="Missing: "+u.join(", "),i.style.display="block"):(i&&(i.textContent="",i.style.display="none"),console.log("[Starmus] Validation passed, dispatching step-continue"),a.dispatch({type:"starmus/ui/step-continue"}),console.log("[Starmus] Dispatch complete, state should be ready_to_record"))})):console.warn("[Starmus] Continue button not found for instance",s),"true"===t.dataset.starmusRerecord&&a.dispatch({type:"starmus/ui/step-continue"}),"C"!==n&&(c.recordBtn&&c.recordBtn.addEventListener("click",e=>{e.preventDefault(),r.dispatch("start-mic",{},{instanceId:s})}),c.stopBtn&&c.stopBtn.addEventListener("click",e=>{e.preventDefault(),r.dispatch("stop-mic",{},{instanceId:s})})),c.fileInput&&c.fileInput.addEventListener("change",()=>{const e=c.fileInput.files&&c.fileInput.files[0];e&&r.dispatch("attach-file",{file:e},{instanceId:s})}),t.addEventListener("submit",e=>{e.preventDefault();const n=new FormData(t),a={};n.forEach((e,t)=>{a[t]=e}),r.dispatch("submit",{formFields:a},{instanceId:s})}),c.resetBtn&&c.resetBtn.addEventListener("click",e=>{e.preventDefault(),r.dispatch("reset",{},{instanceId:s})}),s}async function N(e){const t=e.detail||{},r=document.querySelectorAll('form[data-starmus="recorder"]');if(r&&r.length)for(const e of r)await x(t,e)}function D(){const e=function(){try{return navigator.connection||navigator.mozConnection||navigator.webkitConnection||null}catch{return null}}(),t=e?{effectiveType:e.effectiveType||"unknown",downlink:e.downlink||null,saveData:e.saveData||!1}:{effectiveType:"unknown",downlink:null,saveData:!1};N({detail:{browser:{userAgent:navigator.userAgent},device:{type:/mobile|android|iphone|ipad/i.test(navigator.userAgent)?"mobile":"desktop",memory:C(),concurrency:_(),battery:null},capabilities:{webrtc:!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia),mediaRecorder:!(!navigator.mediaDevices||!window.MediaRecorder),indexedDB:!!window.indexedDB},network:t}})}let T=!1,U=null;document.addEventListener("sparxstar:environment-ready",e=>{T=!0,U&&(clearTimeout(U),U=null),N(e)}),U=setTimeout(()=>{T||(console.warn("[Starmus] Using fallback initialization"),D())},2e3),"undefined"!=typeof window&&(window.STARMUS=window.STARMUS||{},window.STARMUS.instances=B)}();
